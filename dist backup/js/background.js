(()=>{"use strict";const e="mac";var t;!function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.FATAL=4]="FATAL",e[e.OFF=5]="OFF"}(t||(t={}));class n{log(e,n){({[t.DEBUG]:console.debug,[t.INFO]:console.info,[t.WARN]:console.warn,[t.ERROR]:console.error,[t.FATAL]:console.error,[t.OFF]:()=>{}}[e]||console.log)(n)}}class r{constructor(e={}){this.level=e.level??t.INFO,this.prefix=e.prefix??"",this.dateFormat=e.dateFormat??!0,this.transports=e.transport??[new n]}setLevel(e){return this.level=e,this}setPrefix(e){return this.prefix=e,this}addTransport(e){return this.transports.push(e),this}formatMessage(e,n){const r={[t.DEBUG]:"DEBUG",[t.INFO]:"INFO",[t.WARN]:"WARN",[t.ERROR]:"ERROR",[t.FATAL]:"FATAL",[t.OFF]:"OFF"};let s="";return this.dateFormat&&(s+=`[${(new Date).toLocaleString()}] `),s+=`[${r[e]||"UNKNOWN"}] `,this.prefix&&(s+=`[${this.prefix}] `),s+=n,s}log(e,t,...n){if(e<this.level)return;let r;r=t instanceof Error?`${t.message}\n${t.stack}`:t,n.length>0&&(r+=" "+n.map(e=>null==e||null==e?e+"":e instanceof Error||e.stack&&e.message?`${e.message}\n${e.stack}`:"object"==typeof e?JSON.stringify(e):String(e)).join(" "));const s=this.formatMessage(e,r);this.transports.forEach(t=>{t.log(e,s)})}isEnableDebug(){return this.level<=t.DEBUG}debug(e,...n){this.log(t.DEBUG,e,...n)}isEnableInfo(){return this.level<=t.INFO}info(e,...n){this.log(t.INFO,e,...n)}warn(e,...n){this.log(t.WARN,e,...n)}error(e,...n){this.log(t.ERROR,e,...n)}fatal(e,...n){this.log(t.FATAL,e,...n)}createChild(e,t={}){const n=this.prefix?`${this.prefix}.${e}`:e;return new r({level:t.level||this.level,prefix:n,dateFormat:void 0!==t.dateFormat?t.dateFormat:this.dateFormat,transport:t.transport||this.transports})}}const s=new r;function o(e){return new Promise(t=>setTimeout(()=>t(),e))}function a(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function i(e,t,n){return new Promise(async(r,s)=>{let o=setTimeout(()=>{s(new Error("Timeout")),n&&n("Timeout")},t);try{const t=await e();clearTimeout(o),r(t)}catch(e){clearTimeout(o),s(e),n&&n(e+"")}})}function l(e){let t=null;if(e.startsWith("http://")||e.startsWith("https://"))t=new URL(e);else if(e.startsWith("data:image/")&&(e=e.substring(e.indexOf(",")+1)),"undefined"!=typeof Buffer){const n=Buffer.from(e,"base64");t=new Uint8Array(n)}else{const n=atob(e);t=new Uint8Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e)}return t}function u(e,t){let n=[],r=t.reduce((e,t)=>(e[t.name]=t,e),{}),s=[];for(let t=0;t<e.length;t++){let s=e[t],o=r[s.name];o?(n.push(o),delete r[s.name]):n.push(s)}for(let e=0;e<t.length;e++){let o=t[e];r[o.name]&&-1===s.indexOf(o.name)&&(n.push(o),s.push(o.name))}return n}function c(e,t){let n=[],r=t.reduce((e,t)=>(e[t.Name]=t,e),{});for(let t=0;t<e.length;t++){let s=e[t],o=r[s.Name];o?(n.push(o),delete r[s.Name]):n.push(s)}for(let e=0;e<t.length;e++){let s=t[e];r[s.Name]&&n.push(s)}return n}function d(e,t,n=!0){return e?e.length>t?e.substring(0,t)+(n?"...":""):e:""}class p{constructor(e,t,n,r){this.conversation=[],this.pauseStatus=0,this.currentStepControllers=new Set,this.taskId=e,this.config=t,this.agents=n,this.chain=r,this.variables=new Map,this.controller=new AbortController}async checkAborted(e){if(this.controller.signal.aborted){const e=new Error("Operation was interrupted");throw e.name="AbortError",e}for(;this.pauseStatus>0&&!e;)if(await o(500),2==this.pauseStatus&&(this.currentStepControllers.forEach(e=>{e.abort("Pause")}),this.currentStepControllers.clear()),this.controller.signal.aborted){const e=new Error("Operation was interrupted");throw e.name="AbortError",e}}currentAgent(){const e=this.chain.agents[this.chain.agents.length-1];if(!e)return null;const t=this.agents.filter(t=>t.Name==e.agent.name)[0];if(!t)return null;const n=t.AgentContext;return[t,e.agent,n]}get pause(){return this.pauseStatus>0}setPause(e,t){this.pauseStatus=e?t?2:1:0,2==this.pauseStatus&&(this.currentStepControllers.forEach(e=>{e.abort("Pause")}),this.currentStepControllers.clear())}}class h{constructor(e,t,n){this.context=e,this.agent=t,this.agentChain=n,this.variables=new Map,this.consecutiveErrorNum=0}}var m,g="vercel.ai.error",f=Symbol.for(g),y=class e extends Error{constructor({name:e,message:t,cause:n}){super(t),this[m]=!0,this.name=e,this.cause=n}static isInstance(t){return e.hasMarker(t,g)}static hasMarker(e,t){const n=Symbol.for(t);return null!=e&&"object"==typeof e&&n in e&&"boolean"==typeof e[n]&&!0===e[n]}};m=f;var b,v=y,w="AI_APICallError",_=`vercel.ai.error.${w}`,x=Symbol.for(_),k=class extends v{constructor({message:e,url:t,requestBodyValues:n,statusCode:r,responseHeaders:s,responseBody:o,cause:a,isRetryable:i=null!=r&&(408===r||409===r||429===r||r>=500),data:l}){super({name:w,message:e,cause:a}),this[b]=!0,this.url=t,this.requestBodyValues=n,this.statusCode=r,this.responseHeaders=s,this.responseBody=o,this.isRetryable=i,this.data=l}static isInstance(e){return v.hasMarker(e,_)}};b=x;var T,N="AI_EmptyResponseBodyError",I=`vercel.ai.error.${N}`,E=Symbol.for(I),C=class extends v{constructor({message:e="Empty response body"}={}){super({name:N,message:e}),this[T]=!0}static isInstance(e){return v.hasMarker(e,I)}};function S(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}T=E;var A,R="AI_InvalidArgumentError",O=`vercel.ai.error.${R}`,j=Symbol.for(O),M=class extends v{constructor({message:e,cause:t,argument:n}){super({name:R,message:e,cause:t}),this[A]=!0,this.argument=n}static isInstance(e){return v.hasMarker(e,O)}};A=j;var P,D="AI_InvalidPromptError",$=`vercel.ai.error.${D}`,U=Symbol.for($),q=class extends v{constructor({prompt:e,message:t,cause:n}){super({name:D,message:`Invalid prompt: ${t}`,cause:n}),this[P]=!0,this.prompt=e}static isInstance(e){return v.hasMarker(e,$)}};P=U;var L,F="AI_InvalidResponseDataError",B=`vercel.ai.error.${F}`,H=Symbol.for(B),Z=class extends v{constructor({data:e,message:t=`Invalid response data: ${JSON.stringify(e)}.`}){super({name:F,message:t}),this[L]=!0,this.data=e}static isInstance(e){return v.hasMarker(e,B)}};L=H;var W,V="AI_JSONParseError",z=`vercel.ai.error.${V}`,G=Symbol.for(z),K=class extends v{constructor({text:e,cause:t}){super({name:V,message:`JSON parsing failed: Text: ${e}.\nError message: ${S(t)}`,cause:t}),this[W]=!0,this.text=e}static isInstance(e){return v.hasMarker(e,z)}};W=G;var J,X="AI_LoadAPIKeyError",Y=`vercel.ai.error.${X}`,Q=Symbol.for(Y),ee=class extends v{constructor({message:e}){super({name:X,message:e}),this[J]=!0}static isInstance(e){return v.hasMarker(e,Y)}};J=Q;var te,ne="AI_LoadSettingError",re=`vercel.ai.error.${ne}`,se=Symbol.for(re),oe=class extends v{constructor({message:e}){super({name:ne,message:e}),this[te]=!0}static isInstance(e){return v.hasMarker(e,re)}};te=se;var ae,ie="AI_NoSuchModelError",le=`vercel.ai.error.${ie}`,ue=Symbol.for(le),ce=class extends v{constructor({errorName:e=ie,modelId:t,modelType:n,message:r=`No such ${n}: ${t}`}){super({name:e,message:r}),this[ae]=!0,this.modelId=t,this.modelType=n}static isInstance(e){return v.hasMarker(e,le)}};ae=ue;var de,pe="AI_TooManyEmbeddingValuesForCallError",he=`vercel.ai.error.${pe}`,me=Symbol.for(he),ge=class extends v{constructor(e){super({name:pe,message:`Too many values for a single embedding call. The ${e.provider} model "${e.modelId}" can only embed up to ${e.maxEmbeddingsPerCall} values per call, but ${e.values.length} values were provided.`}),this[de]=!0,this.provider=e.provider,this.modelId=e.modelId,this.maxEmbeddingsPerCall=e.maxEmbeddingsPerCall,this.values=e.values}static isInstance(e){return v.hasMarker(e,he)}};de=me;var fe,ye="AI_TypeValidationError",be=`vercel.ai.error.${ye}`,ve=Symbol.for(be);fe=ve;var we,_e=class e extends v{constructor({value:e,cause:t}){super({name:ye,message:`Type validation failed: Value: ${JSON.stringify(e)}.\nError message: ${S(t)}`,cause:t}),this[fe]=!0,this.value=e}static isInstance(e){return v.hasMarker(e,be)}static wrap({value:t,cause:n}){return e.isInstance(n)&&n.value===t?n:new e({value:t,cause:n})}},xe="AI_UnsupportedFunctionalityError",ke=`vercel.ai.error.${xe}`,Te=Symbol.for(ke),Ne=class extends v{constructor({functionality:e,message:t=`'${e}' functionality not supported.`}){super({name:xe,message:t}),this[we]=!0,this.functionality=e}static isInstance(e){return v.hasMarker(e,ke)}};function Ie(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}we=Te;var Ee,Ce={exports:{}},Se=Ie(function(){if(Ee)return Ce.exports;Ee=1;const e="undefined"!=typeof Buffer,t=/"(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])"\s*:/,n=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/;function r(r,o,a){null==a&&null!==o&&"object"==typeof o&&(a=o,o=void 0),e&&Buffer.isBuffer(r)&&(r=r.toString()),r&&65279===r.charCodeAt(0)&&(r=r.slice(1));const i=JSON.parse(r,o);if(null===i||"object"!=typeof i)return i;const l=a&&a.protoAction||"error",u=a&&a.constructorAction||"error";if("ignore"===l&&"ignore"===u)return i;if("ignore"!==l&&"ignore"!==u){if(!1===t.test(r)&&!1===n.test(r))return i}else if("ignore"!==l&&"ignore"===u){if(!1===t.test(r))return i}else if(!1===n.test(r))return i;return s(i,{protoAction:l,constructorAction:u,safe:a&&a.safe})}function s(e,{protoAction:t="error",constructorAction:n="error",safe:r}={}){let s=[e];for(;s.length;){const e=s;s=[];for(const o of e){if("ignore"!==t&&Object.prototype.hasOwnProperty.call(o,"__proto__")){if(!0===r)return null;if("error"===t)throw new SyntaxError("Object contains forbidden prototype property");delete o.__proto__}if("ignore"!==n&&Object.prototype.hasOwnProperty.call(o,"constructor")&&Object.prototype.hasOwnProperty.call(o.constructor,"prototype")){if(!0===r)return null;if("error"===n)throw new SyntaxError("Object contains forbidden prototype property");delete o.constructor}for(const e in o){const t=o[e];t&&"object"==typeof t&&s.push(t)}}}return e}function o(e,t,n){const s=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return r(e,t,n)}finally{Error.stackTraceLimit=s}}return Ce.exports=o,Ce.exports.default=o,Ce.exports.parse=o,Ce.exports.safeParse=function(e,t){const n=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return r(e,t,{safe:!0})}catch(e){return null}finally{Error.stackTraceLimit=n}},Ce.exports.scan=s,Ce.exports}());function Ae(...e){return e.reduce((e,t)=>({...e,...null!=t?t:{}}),{})}function Re(){let e,t,n,r="",s=[];function o(e,t){if(""===e)return void a(t);if(e.startsWith(":"))return;const n=e.indexOf(":");if(-1===n)return void i(e,"");const r=n+1;i(e.slice(0,n),r<e.length&&" "===e[r]?e.slice(r+1):e.slice(r))}function a(r){s.length>0&&(r.enqueue({event:e,data:s.join("\n"),id:t,retry:n}),s=[],e=void 0,n=void 0)}function i(r,o){switch(r){case"event":e=o;break;case"data":s.push(o);break;case"id":t=o;break;case"retry":const r=parseInt(o,10);isNaN(r)||(n=r)}}return new TransformStream({transform(e,t){const{lines:n,incompleteLine:s}=function(e,t){const n=[];let r=e;for(let e=0;e<t.length;){const s=t[e++];"\n"===s?(n.push(r),r=""):"\r"===s?(n.push(r),r="","\n"===t[e]&&e++):r+=s}return{lines:n,incompleteLine:r}}(r,e);r=s;for(let e=0;e<n.length;e++)o(n[e],t)},flush(e){o(r,e),a(e)}})}function Oe(e){const t={};return e.headers.forEach((e,n)=>{t[n]=e}),t}var je=({prefix:e,size:t=16,alphabet:n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:r="-"}={})=>{const s=((e,t=21)=>(n=t)=>{let r="",s=0|n;for(;s--;)r+=e[Math.random()*e.length|0];return r})(n,t);if(null==e)return s;if(n.includes(r))throw new M({argument:"separator",message:`The separator "${r}" must not be part of the alphabet "${n}".`});return t=>`${e}${r}${s(t)}`},Me=je();function Pe(e){return Object.fromEntries(Object.entries(e).filter(([e,t])=>null!=t))}function De(e){return e instanceof Error&&("AbortError"===e.name||"TimeoutError"===e.name)}function $e({apiKey:e,environmentVariableName:t,apiKeyParameterName:n="apiKey",description:r}){if("string"==typeof e)return e;if(null!=e)throw new ee({message:`${r} API key must be a string.`});if("undefined"==typeof process)throw new ee({message:`${r} API key is missing. Pass it using the '${n}' parameter. Environment variables is not supported in this environment.`});if(null==(e=process.env[t]))throw new ee({message:`${r} API key is missing. Pass it using the '${n}' parameter or the ${t} environment variable.`});if("string"!=typeof e)throw new ee({message:`${r} API key must be a string. The value of the ${t} environment variable is not a string.`});return e}function Ue({settingValue:e,environmentVariableName:t}){return"string"==typeof e||null==e&&"undefined"!=typeof process&&null!=(e=process.env[t])&&"string"==typeof e?e:void 0}function qe({settingValue:e,environmentVariableName:t,settingName:n,description:r}){if("string"==typeof e)return e;if(null!=e)throw new oe({message:`${r} setting must be a string.`});if("undefined"==typeof process)throw new oe({message:`${r} setting is missing. Pass it using the '${n}' parameter. Environment variables is not supported in this environment.`});if(null==(e=process.env[t]))throw new oe({message:`${r} setting is missing. Pass it using the '${n}' parameter or the ${t} environment variable.`});if("string"!=typeof e)throw new oe({message:`${r} setting must be a string. The value of the ${t} environment variable is not a string.`});return e}var Le=Symbol.for("vercel.ai.validator");function Fe({value:e,schema:t}){const n=function(e){return function(e){return"object"==typeof e&&null!==e&&Le in e&&!0===e[Le]&&"validate"in e}(e)?e:(t=e,n=e=>{const n=t.safeParse(e);return n.success?{success:!0,value:n.data}:{success:!1,error:n.error}},{[Le]:!0,validate:n});var t,n}(t);try{if(null==n.validate)return{success:!0,value:e};const t=n.validate(e);return t.success?t:{success:!1,error:_e.wrap({value:e,cause:t.error})}}catch(t){return{success:!1,error:_e.wrap({value:e,cause:t})}}}function Be({text:e,schema:t}){try{const n=Se.parse(e);if(null==t)return{success:!0,value:n,rawValue:n};const r=Fe({value:n,schema:t});return r.success?{...r,rawValue:n}:r}catch(t){return{success:!1,error:K.isInstance(t)?t:new K({text:e,cause:t})}}}function He(e){try{return Se.parse(e),!0}catch(e){return!1}}function Ze({provider:e,providerOptions:t,schema:n}){if(null==(null==t?void 0:t[e]))return;const r=Fe({value:t[e],schema:n});if(!r.success)throw new M({argument:"providerOptions",message:`invalid ${e} provider options`,cause:r.error});return r.value}var We=()=>globalThis.fetch,Ve=async({url:e,headers:t,body:n,failedResponseHandler:r,successfulResponseHandler:s,abortSignal:o,fetch:a})=>ze({url:e,headers:{"Content-Type":"application/json",...t},body:{content:JSON.stringify(n),values:n},failedResponseHandler:r,successfulResponseHandler:s,abortSignal:o,fetch:a}),ze=async({url:e,headers:t={},body:n,successfulResponseHandler:r,failedResponseHandler:s,abortSignal:o,fetch:a=We()})=>{try{const i=await a(e,{method:"POST",headers:Pe(t),body:n.content,signal:o}),l=Oe(i);if(!i.ok){let t;try{t=await s({response:i,url:e,requestBodyValues:n.values})}catch(t){if(De(t)||k.isInstance(t))throw t;throw new k({message:"Failed to process error response",cause:t,statusCode:i.status,url:e,responseHeaders:l,requestBodyValues:n.values})}throw t.value}try{return await r({response:i,url:e,requestBodyValues:n.values})}catch(t){if(t instanceof Error&&(De(t)||k.isInstance(t)))throw t;throw new k({message:"Failed to process successful response",cause:t,statusCode:i.status,url:e,responseHeaders:l,requestBodyValues:n.values})}}catch(t){if(De(t))throw t;if(t instanceof TypeError&&"fetch failed"===t.message){const r=t.cause;if(null!=r)throw new k({message:`Cannot connect to API: ${r.message}`,cause:r,url:e,requestBodyValues:n.values,isRetryable:!0})}throw t}};async function Ge(e){return"function"==typeof e&&(e=e()),Promise.resolve(e)}var Ke,Je,Xe=({errorSchema:e,errorToMessage:t,isRetryable:n})=>async({response:r,url:s,requestBodyValues:o})=>{const a=await r.text(),i=Oe(r);if(""===a.trim())return{responseHeaders:i,value:new k({message:r.statusText,url:s,requestBodyValues:o,statusCode:r.status,responseHeaders:i,responseBody:a,isRetryable:null==n?void 0:n(r)})};try{const l=function({text:e,schema:t}){try{const n=Se.parse(e);return null==t?n:function({value:e,schema:t}){const n=Fe({value:e,schema:t});if(!n.success)throw _e.wrap({value:e,cause:n.error});return n.value}({value:n,schema:t})}catch(t){if(K.isInstance(t)||_e.isInstance(t))throw t;throw new K({text:e,cause:t})}}({text:a,schema:e});return{responseHeaders:i,value:new k({message:t(l),url:s,requestBodyValues:o,statusCode:r.status,responseHeaders:i,responseBody:a,data:l,isRetryable:null==n?void 0:n(r,l)})}}catch(e){return{responseHeaders:i,value:new k({message:r.statusText,url:s,requestBodyValues:o,statusCode:r.status,responseHeaders:i,responseBody:a,isRetryable:null==n?void 0:n(r)})}}},Ye=e=>async({response:t})=>{const n=Oe(t);if(null==t.body)throw new C({});return{responseHeaders:n,value:t.body.pipeThrough(new TextDecoderStream).pipeThrough(Re()).pipeThrough(new TransformStream({transform({data:t},n){"[DONE]"!==t&&n.enqueue(Be({text:t,schema:e}))}}))}},Qe=e=>async({response:t,url:n,requestBodyValues:r})=>{const s=await t.text(),o=Be({text:s,schema:e}),a=Oe(t);if(!o.success)throw new k({message:"Invalid JSON response",cause:o.error,statusCode:t.status,responseHeaders:a,responseBody:s,url:n,requestBodyValues:r});return{responseHeaders:a,value:o.value,rawValue:o.rawValue}},{btoa:et,atob:tt}=globalThis;function nt(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),n=tt(t);return Uint8Array.from(n,e=>e.codePointAt(0))}function rt(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCodePoint(e[n]);return et(t)}function st(e){return null==e?void 0:e.replace(/\/$/,"")}!function(e){e.assertEqual=e=>e,e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter(e=>"number"!=typeof t[t[e]]),r={};for(const e of n)r[e]=t[e];return e.objectValues(r)},e.objectValues=t=>e.objectKeys(t).map(function(e){return t[e]}),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(Ke||(Ke={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(Je||(Je={}));const ot=Ke.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),at=e=>{switch(typeof e){case"undefined":return ot.undefined;case"string":return ot.string;case"number":return isNaN(e)?ot.nan:ot.number;case"boolean":return ot.boolean;case"function":return ot.function;case"bigint":return ot.bigint;case"symbol":return ot.symbol;case"object":return Array.isArray(e)?ot.array:null===e?ot.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?ot.promise:"undefined"!=typeof Map&&e instanceof Map?ot.map:"undefined"!=typeof Set&&e instanceof Set?ot.set:"undefined"!=typeof Date&&e instanceof Date?ot.date:ot.object;default:return ot.unknown}},it=Ke.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class lt extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},n={_errors:[]},r=e=>{for(const s of e.issues)if("invalid_union"===s.code)s.unionErrors.map(r);else if("invalid_return_type"===s.code)r(s.returnTypeError);else if("invalid_arguments"===s.code)r(s.argumentsError);else if(0===s.path.length)n._errors.push(t(s));else{let e=n,r=0;for(;r<s.path.length;){const n=s.path[r];r===s.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(s))):e[n]=e[n]||{_errors:[]},e=e[n],r++}}};return r(this),n}static assert(e){if(!(e instanceof lt))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Ke.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},n=[];for(const r of this.issues)r.path.length>0?(t[r.path[0]]=t[r.path[0]]||[],t[r.path[0]].push(e(r))):n.push(e(r));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}lt.create=e=>new lt(e);const ut=(e,t)=>{let n;switch(e.code){case it.invalid_type:n=e.received===ot.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case it.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,Ke.jsonStringifyReplacer)}`;break;case it.unrecognized_keys:n=`Unrecognized key(s) in object: ${Ke.joinValues(e.keys,", ")}`;break;case it.invalid_union:n="Invalid input";break;case it.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${Ke.joinValues(e.options)}`;break;case it.invalid_enum_value:n=`Invalid enum value. Expected ${Ke.joinValues(e.options)}, received '${e.received}'`;break;case it.invalid_arguments:n="Invalid function arguments";break;case it.invalid_return_type:n="Invalid function return type";break;case it.invalid_date:n="Invalid date";break;case it.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:Ke.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case it.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case it.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case it.custom:n="Invalid input";break;case it.invalid_intersection_types:n="Intersection results could not be merged";break;case it.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case it.not_finite:n="Number must be finite";break;default:n=t.defaultError,Ke.assertNever(e)}return{message:n}};let ct=ut;function dt(){return ct}const pt=e=>{const{data:t,path:n,errorMaps:r,issueData:s}=e,o=[...n,...s.path||[]],a={...s,path:o};if(void 0!==s.message)return{...s,path:o,message:s.message};let i="";const l=r.filter(e=>!!e).slice().reverse();for(const e of l)i=e(a,{data:t,defaultError:i}).message;return{...s,path:o,message:i}};function ht(e,t){const n=dt(),r=pt({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===ut?void 0:ut].filter(e=>!!e)});e.common.issues.push(r)}class mt{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const r of t){if("aborted"===r.status)return gt;"dirty"===r.status&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,r=await e.value;n.push({key:t,value:r})}return mt.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const r of t){const{key:t,value:s}=r;if("aborted"===t.status)return gt;if("aborted"===s.status)return gt;"dirty"===t.status&&e.dirty(),"dirty"===s.status&&e.dirty(),"__proto__"===t.value||void 0===s.value&&!r.alwaysSet||(n[t.value]=s.value)}return{status:e.value,value:n}}}const gt=Object.freeze({status:"aborted"}),ft=e=>({status:"dirty",value:e}),yt=e=>({status:"valid",value:e}),bt=e=>"aborted"===e.status,vt=e=>"dirty"===e.status,wt=e=>"valid"===e.status,_t=e=>"undefined"!=typeof Promise&&e instanceof Promise;function xt(e,t,n,r){if("function"==typeof t||!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t.get(e)}function kt(e,t,n,r,s){if("function"==typeof t||!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return t.set(e,n),n}var Tt,Nt,It;"function"==typeof SuppressedError&&SuppressedError,function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(Tt||(Tt={}));class Et{constructor(e,t,n,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=r}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Ct=(e,t)=>{if(wt(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new lt(e.common.issues);return this._error=t,this._error}}};function St(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:r,description:s}=e;if(t&&(n||r))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:s}:{errorMap:(t,s)=>{var o,a;const{message:i}=e;return"invalid_enum_value"===t.code?{message:null!=i?i:s.defaultError}:void 0===s.data?{message:null!==(o=null!=i?i:r)&&void 0!==o?o:s.defaultError}:"invalid_type"!==t.code?{message:s.defaultError}:{message:null!==(a=null!=i?i:n)&&void 0!==a?a:s.defaultError}},description:s}}class At{get description(){return this._def.description}_getType(e){return at(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:at(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new mt,ctx:{common:e.parent.common,data:e.data,parsedType:at(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(_t(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){var n;const r={common:{issues:[],async:null!==(n=null==t?void 0:t.async)&&void 0!==n&&n,contextualErrorMap:null==t?void 0:t.errorMap},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:at(e)},s=this._parseSync({data:e,path:r.path,parent:r});return Ct(r,s)}"~validate"(e){var t,n;const r={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:at(e)};if(!this["~standard"].async)try{const t=this._parseSync({data:e,path:[],parent:r});return wt(t)?{value:t.value}:{issues:r.common.issues}}catch(e){(null===(n=null===(t=null==e?void 0:e.message)||void 0===t?void 0:t.toLowerCase())||void 0===n?void 0:n.includes("encountered"))&&(this["~standard"].async=!0),r.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:r}).then(e=>wt(e)?{value:e.value}:{issues:r.common.issues})}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:null==t?void 0:t.errorMap,async:!0},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:at(e)},r=this._parse({data:e,path:n.path,parent:n}),s=await(_t(r)?r:Promise.resolve(r));return Ct(n,s)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement((t,r)=>{const s=e(t),o=()=>r.addIssue({code:it.custom,...n(t)});return"undefined"!=typeof Promise&&s instanceof Promise?s.then(e=>!!e||(o(),!1)):!!s||(o(),!1)})}refinement(e,t){return this._refinement((n,r)=>!!e(n)||(r.addIssue("function"==typeof t?t(n,r):t),!1))}_refinement(e){return new jn({schema:this,typeName:Vn.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return Mn.create(this,this._def)}nullable(){return Pn.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return mn.create(this)}promise(){return On.create(this,this._def)}or(e){return yn.create([this,e],this._def)}and(e){return _n.create(this,e,this._def)}transform(e){return new jn({...St(this._def),schema:this,typeName:Vn.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new Dn({...St(this._def),innerType:this,defaultValue:t,typeName:Vn.ZodDefault})}brand(){return new Ln({typeName:Vn.ZodBranded,type:this,...St(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new $n({...St(this._def),innerType:this,catchValue:t,typeName:Vn.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return Fn.create(this,e)}readonly(){return Bn.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Rt=/^c[^\s-]{8,}$/i,Ot=/^[0-9a-z]+$/,jt=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Mt=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Pt=/^[a-z0-9_-]{21}$/i,Dt=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,$t=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Ut=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let qt;const Lt=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Ft=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Bt=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Ht=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Zt=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Wt=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Vt="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",zt=new RegExp(`^${Vt}$`);function Gt(e){let t="[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),`([01]\\d|2[0-3]):[0-5]\\d(:${t})${e.precision?"+":"?"}`}function Kt(e){return new RegExp(`^${Gt(e)}$`)}function Jt(e){let t=`${Vt}T${Gt(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}function Xt(e,t){return!("v4"!==t&&t||!Lt.test(e))||!("v6"!==t&&t||!Bt.test(e))}function Yt(e,t){if(!Dt.test(e))return!1;try{const[n]=e.split("."),r=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),s=JSON.parse(atob(r));return!("object"!=typeof s||null===s||!s.typ||!s.alg||t&&s.alg!==t)}catch(e){return!1}}function Qt(e,t){return!("v4"!==t&&t||!Ft.test(e))||!("v6"!==t&&t||!Ht.test(e))}class en extends At{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==ot.string){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:ot.string,received:t.parsedType}),gt}const t=new mt;let n;for(const r of this._def.checks)if("min"===r.kind)e.data.length<r.value&&(n=this._getOrReturnCtx(e,n),ht(n,{code:it.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),t.dirty());else if("max"===r.kind)e.data.length>r.value&&(n=this._getOrReturnCtx(e,n),ht(n,{code:it.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),t.dirty());else if("length"===r.kind){const s=e.data.length>r.value,o=e.data.length<r.value;(s||o)&&(n=this._getOrReturnCtx(e,n),s?ht(n,{code:it.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}):o&&ht(n,{code:it.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}),t.dirty())}else if("email"===r.kind)Ut.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"email",code:it.invalid_string,message:r.message}),t.dirty());else if("emoji"===r.kind)qt||(qt=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),qt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"emoji",code:it.invalid_string,message:r.message}),t.dirty());else if("uuid"===r.kind)Mt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"uuid",code:it.invalid_string,message:r.message}),t.dirty());else if("nanoid"===r.kind)Pt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"nanoid",code:it.invalid_string,message:r.message}),t.dirty());else if("cuid"===r.kind)Rt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"cuid",code:it.invalid_string,message:r.message}),t.dirty());else if("cuid2"===r.kind)Ot.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"cuid2",code:it.invalid_string,message:r.message}),t.dirty());else if("ulid"===r.kind)jt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"ulid",code:it.invalid_string,message:r.message}),t.dirty());else if("url"===r.kind)try{new URL(e.data)}catch(s){n=this._getOrReturnCtx(e,n),ht(n,{validation:"url",code:it.invalid_string,message:r.message}),t.dirty()}else"regex"===r.kind?(r.regex.lastIndex=0,r.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"regex",code:it.invalid_string,message:r.message}),t.dirty())):"trim"===r.kind?e.data=e.data.trim():"includes"===r.kind?e.data.includes(r.value,r.position)||(n=this._getOrReturnCtx(e,n),ht(n,{code:it.invalid_string,validation:{includes:r.value,position:r.position},message:r.message}),t.dirty()):"toLowerCase"===r.kind?e.data=e.data.toLowerCase():"toUpperCase"===r.kind?e.data=e.data.toUpperCase():"startsWith"===r.kind?e.data.startsWith(r.value)||(n=this._getOrReturnCtx(e,n),ht(n,{code:it.invalid_string,validation:{startsWith:r.value},message:r.message}),t.dirty()):"endsWith"===r.kind?e.data.endsWith(r.value)||(n=this._getOrReturnCtx(e,n),ht(n,{code:it.invalid_string,validation:{endsWith:r.value},message:r.message}),t.dirty()):"datetime"===r.kind?Jt(r).test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{code:it.invalid_string,validation:"datetime",message:r.message}),t.dirty()):"date"===r.kind?zt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{code:it.invalid_string,validation:"date",message:r.message}),t.dirty()):"time"===r.kind?Kt(r).test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{code:it.invalid_string,validation:"time",message:r.message}),t.dirty()):"duration"===r.kind?$t.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"duration",code:it.invalid_string,message:r.message}),t.dirty()):"ip"===r.kind?Xt(e.data,r.version)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"ip",code:it.invalid_string,message:r.message}),t.dirty()):"jwt"===r.kind?Yt(e.data,r.alg)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"jwt",code:it.invalid_string,message:r.message}),t.dirty()):"cidr"===r.kind?Qt(e.data,r.version)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"cidr",code:it.invalid_string,message:r.message}),t.dirty()):"base64"===r.kind?Zt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"base64",code:it.invalid_string,message:r.message}),t.dirty()):"base64url"===r.kind?Wt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"base64url",code:it.invalid_string,message:r.message}),t.dirty()):Ke.assertNever(r);return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement(t=>e.test(t),{validation:t,code:it.invalid_string,...Tt.errToObj(n)})}_addCheck(e){return new en({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...Tt.errToObj(e)})}url(e){return this._addCheck({kind:"url",...Tt.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...Tt.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...Tt.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...Tt.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...Tt.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...Tt.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...Tt.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...Tt.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...Tt.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...Tt.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...Tt.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...Tt.errToObj(e)})}datetime(e){var t,n;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!==(t=null==e?void 0:e.offset)&&void 0!==t&&t,local:null!==(n=null==e?void 0:e.local)&&void 0!==n&&n,...Tt.errToObj(null==e?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,...Tt.errToObj(null==e?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...Tt.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...Tt.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:null==t?void 0:t.position,...Tt.errToObj(null==t?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...Tt.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...Tt.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...Tt.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...Tt.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...Tt.errToObj(t)})}nonempty(e){return this.min(1,Tt.errToObj(e))}trim(){return new en({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new en({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new en({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function tn(e,t){const n=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,s=n>r?n:r;return parseInt(e.toFixed(s).replace(".",""))%parseInt(t.toFixed(s).replace(".",""))/Math.pow(10,s)}en.create=e=>{var t;return new en({checks:[],typeName:Vn.ZodString,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...St(e)})};class nn extends At{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==ot.number){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:ot.number,received:t.parsedType}),gt}let t;const n=new mt;for(const r of this._def.checks)"int"===r.kind?Ke.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),ht(t,{code:it.invalid_type,expected:"integer",received:"float",message:r.message}),n.dirty()):"min"===r.kind?(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),ht(t,{code:it.too_small,minimum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty()):"max"===r.kind?(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),ht(t,{code:it.too_big,maximum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty()):"multipleOf"===r.kind?0!==tn(e.data,r.value)&&(t=this._getOrReturnCtx(e,t),ht(t,{code:it.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):"finite"===r.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),ht(t,{code:it.not_finite,message:r.message}),n.dirty()):Ke.assertNever(r);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,Tt.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Tt.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Tt.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Tt.toString(t))}setLimit(e,t,n,r){return new nn({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Tt.toString(r)}]})}_addCheck(e){return new nn({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:Tt.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:Tt.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:Tt.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:Tt.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:Tt.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Tt.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:Tt.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:Tt.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:Tt.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&Ke.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}nn.create=e=>new nn({checks:[],typeName:Vn.ZodNumber,coerce:(null==e?void 0:e.coerce)||!1,...St(e)});class rn extends At{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch(t){return this._getInvalidInput(e)}if(this._getType(e)!==ot.bigint)return this._getInvalidInput(e);let t;const n=new mt;for(const r of this._def.checks)"min"===r.kind?(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),ht(t,{code:it.too_small,type:"bigint",minimum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty()):"max"===r.kind?(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),ht(t,{code:it.too_big,type:"bigint",maximum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty()):"multipleOf"===r.kind?e.data%r.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),ht(t,{code:it.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):Ke.assertNever(r);return{status:n.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:ot.bigint,received:t.parsedType}),gt}gte(e,t){return this.setLimit("min",e,!0,Tt.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Tt.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Tt.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Tt.toString(t))}setLimit(e,t,n,r){return new rn({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Tt.toString(r)}]})}_addCheck(e){return new rn({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:Tt.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:Tt.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:Tt.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:Tt.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Tt.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}rn.create=e=>{var t;return new rn({checks:[],typeName:Vn.ZodBigInt,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...St(e)})};class sn extends At{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==ot.boolean){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:ot.boolean,received:t.parsedType}),gt}return yt(e.data)}}sn.create=e=>new sn({typeName:Vn.ZodBoolean,coerce:(null==e?void 0:e.coerce)||!1,...St(e)});class on extends At{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==ot.date){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:ot.date,received:t.parsedType}),gt}if(isNaN(e.data.getTime()))return ht(this._getOrReturnCtx(e),{code:it.invalid_date}),gt;const t=new mt;let n;for(const r of this._def.checks)"min"===r.kind?e.data.getTime()<r.value&&(n=this._getOrReturnCtx(e,n),ht(n,{code:it.too_small,message:r.message,inclusive:!0,exact:!1,minimum:r.value,type:"date"}),t.dirty()):"max"===r.kind?e.data.getTime()>r.value&&(n=this._getOrReturnCtx(e,n),ht(n,{code:it.too_big,message:r.message,inclusive:!0,exact:!1,maximum:r.value,type:"date"}),t.dirty()):Ke.assertNever(r);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new on({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:Tt.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:Tt.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}on.create=e=>new on({checks:[],coerce:(null==e?void 0:e.coerce)||!1,typeName:Vn.ZodDate,...St(e)});class an extends At{_parse(e){if(this._getType(e)!==ot.symbol){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:ot.symbol,received:t.parsedType}),gt}return yt(e.data)}}an.create=e=>new an({typeName:Vn.ZodSymbol,...St(e)});class ln extends At{_parse(e){if(this._getType(e)!==ot.undefined){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:ot.undefined,received:t.parsedType}),gt}return yt(e.data)}}ln.create=e=>new ln({typeName:Vn.ZodUndefined,...St(e)});class un extends At{_parse(e){if(this._getType(e)!==ot.null){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:ot.null,received:t.parsedType}),gt}return yt(e.data)}}un.create=e=>new un({typeName:Vn.ZodNull,...St(e)});class cn extends At{constructor(){super(...arguments),this._any=!0}_parse(e){return yt(e.data)}}cn.create=e=>new cn({typeName:Vn.ZodAny,...St(e)});class dn extends At{constructor(){super(...arguments),this._unknown=!0}_parse(e){return yt(e.data)}}dn.create=e=>new dn({typeName:Vn.ZodUnknown,...St(e)});class pn extends At{_parse(e){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:ot.never,received:t.parsedType}),gt}}pn.create=e=>new pn({typeName:Vn.ZodNever,...St(e)});class hn extends At{_parse(e){if(this._getType(e)!==ot.undefined){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:ot.void,received:t.parsedType}),gt}return yt(e.data)}}hn.create=e=>new hn({typeName:Vn.ZodVoid,...St(e)});class mn extends At{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),r=this._def;if(t.parsedType!==ot.array)return ht(t,{code:it.invalid_type,expected:ot.array,received:t.parsedType}),gt;if(null!==r.exactLength){const e=t.data.length>r.exactLength.value,s=t.data.length<r.exactLength.value;(e||s)&&(ht(t,{code:e?it.too_big:it.too_small,minimum:s?r.exactLength.value:void 0,maximum:e?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),n.dirty())}if(null!==r.minLength&&t.data.length<r.minLength.value&&(ht(t,{code:it.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),n.dirty()),null!==r.maxLength&&t.data.length>r.maxLength.value&&(ht(t,{code:it.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((e,n)=>r.type._parseAsync(new Et(t,e,t.path,n)))).then(e=>mt.mergeArray(n,e));const s=[...t.data].map((e,n)=>r.type._parseSync(new Et(t,e,t.path,n)));return mt.mergeArray(n,s)}get element(){return this._def.type}min(e,t){return new mn({...this._def,minLength:{value:e,message:Tt.toString(t)}})}max(e,t){return new mn({...this._def,maxLength:{value:e,message:Tt.toString(t)}})}length(e,t){return new mn({...this._def,exactLength:{value:e,message:Tt.toString(t)}})}nonempty(e){return this.min(1,e)}}function gn(e){if(e instanceof fn){const t={};for(const n in e.shape){const r=e.shape[n];t[n]=Mn.create(gn(r))}return new fn({...e._def,shape:()=>t})}return e instanceof mn?new mn({...e._def,type:gn(e.element)}):e instanceof Mn?Mn.create(gn(e.unwrap())):e instanceof Pn?Pn.create(gn(e.unwrap())):e instanceof xn?xn.create(e.items.map(e=>gn(e))):e}mn.create=(e,t)=>new mn({type:e,minLength:null,maxLength:null,exactLength:null,typeName:Vn.ZodArray,...St(t)});class fn extends At{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=Ke.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==ot.object){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:ot.object,received:t.parsedType}),gt}const{status:t,ctx:n}=this._processInputParams(e),{shape:r,keys:s}=this._getCached(),o=[];if(!(this._def.catchall instanceof pn&&"strip"===this._def.unknownKeys))for(const e in n.data)s.includes(e)||o.push(e);const a=[];for(const e of s){const t=r[e],s=n.data[e];a.push({key:{status:"valid",value:e},value:t._parse(new Et(n,s,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof pn){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of o)a.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)o.length>0&&(ht(n,{code:it.unrecognized_keys,keys:o}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of o){const r=n.data[t];a.push({key:{status:"valid",value:t},value:e._parse(new Et(n,r,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then(async()=>{const e=[];for(const t of a){const n=await t.key,r=await t.value;e.push({key:n,value:r,alwaysSet:t.alwaysSet})}return e}).then(e=>mt.mergeObjectSync(t,e)):mt.mergeObjectSync(t,a)}get shape(){return this._def.shape()}strict(e){return Tt.errToObj,new fn({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{var r,s,o,a;const i=null!==(o=null===(s=(r=this._def).errorMap)||void 0===s?void 0:s.call(r,t,n).message)&&void 0!==o?o:n.defaultError;return"unrecognized_keys"===t.code?{message:null!==(a=Tt.errToObj(e).message)&&void 0!==a?a:i}:{message:i}}}:{}})}strip(){return new fn({...this._def,unknownKeys:"strip"})}passthrough(){return new fn({...this._def,unknownKeys:"passthrough"})}extend(e){return new fn({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new fn({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:Vn.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new fn({...this._def,catchall:e})}pick(e){const t={};return Ke.objectKeys(e).forEach(n=>{e[n]&&this.shape[n]&&(t[n]=this.shape[n])}),new fn({...this._def,shape:()=>t})}omit(e){const t={};return Ke.objectKeys(this.shape).forEach(n=>{e[n]||(t[n]=this.shape[n])}),new fn({...this._def,shape:()=>t})}deepPartial(){return gn(this)}partial(e){const t={};return Ke.objectKeys(this.shape).forEach(n=>{const r=this.shape[n];e&&!e[n]?t[n]=r:t[n]=r.optional()}),new fn({...this._def,shape:()=>t})}required(e){const t={};return Ke.objectKeys(this.shape).forEach(n=>{if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof Mn;)e=e._def.innerType;t[n]=e}}),new fn({...this._def,shape:()=>t})}keyof(){return Sn(Ke.objectKeys(this.shape))}}fn.create=(e,t)=>new fn({shape:()=>e,unknownKeys:"strip",catchall:pn.create(),typeName:Vn.ZodObject,...St(t)}),fn.strictCreate=(e,t)=>new fn({shape:()=>e,unknownKeys:"strict",catchall:pn.create(),typeName:Vn.ZodObject,...St(t)}),fn.lazycreate=(e,t)=>new fn({shape:e,unknownKeys:"strip",catchall:pn.create(),typeName:Vn.ZodObject,...St(t)});class yn extends At{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map(async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}})).then(function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map(e=>new lt(e.ctx.common.issues));return ht(t,{code:it.invalid_union,unionErrors:n}),gt});{let e;const r=[];for(const s of n){const n={...t,common:{...t.common,issues:[]},parent:null},o=s._parseSync({data:t.data,path:t.path,parent:n});if("valid"===o.status)return o;"dirty"!==o.status||e||(e={result:o,ctx:n}),n.common.issues.length&&r.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const s=r.map(e=>new lt(e));return ht(t,{code:it.invalid_union,unionErrors:s}),gt}}get options(){return this._def.options}}yn.create=(e,t)=>new yn({options:e,typeName:Vn.ZodUnion,...St(t)});const bn=e=>e instanceof En?bn(e.schema):e instanceof jn?bn(e.innerType()):e instanceof Cn?[e.value]:e instanceof An?e.options:e instanceof Rn?Ke.objectValues(e.enum):e instanceof Dn?bn(e._def.innerType):e instanceof ln?[void 0]:e instanceof un?[null]:e instanceof Mn?[void 0,...bn(e.unwrap())]:e instanceof Pn?[null,...bn(e.unwrap())]:e instanceof Ln||e instanceof Bn?bn(e.unwrap()):e instanceof $n?bn(e._def.innerType):[];class vn extends At{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==ot.object)return ht(t,{code:it.invalid_type,expected:ot.object,received:t.parsedType}),gt;const n=this.discriminator,r=t.data[n],s=this.optionsMap.get(r);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(ht(t,{code:it.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),gt)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const r=new Map;for(const n of t){const t=bn(n.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const s of t){if(r.has(s))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(s)}`);r.set(s,n)}}return new vn({typeName:Vn.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:r,...St(n)})}}function wn(e,t){const n=at(e),r=at(t);if(e===t)return{valid:!0,data:e};if(n===ot.object&&r===ot.object){const n=Ke.objectKeys(t),r=Ke.objectKeys(e).filter(e=>-1!==n.indexOf(e)),s={...e,...t};for(const n of r){const r=wn(e[n],t[n]);if(!r.valid)return{valid:!1};s[n]=r.data}return{valid:!0,data:s}}if(n===ot.array&&r===ot.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let r=0;r<e.length;r++){const s=wn(e[r],t[r]);if(!s.valid)return{valid:!1};n.push(s.data)}return{valid:!0,data:n}}return n===ot.date&&r===ot.date&&+e===+t?{valid:!0,data:e}:{valid:!1}}class _n extends At{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=(e,r)=>{if(bt(e)||bt(r))return gt;const s=wn(e.value,r.value);return s.valid?((vt(e)||vt(r))&&t.dirty(),{status:t.value,value:s.data}):(ht(n,{code:it.invalid_intersection_types}),gt)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([e,t])=>r(e,t)):r(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}_n.create=(e,t,n)=>new _n({left:e,right:t,typeName:Vn.ZodIntersection,...St(n)});class xn extends At{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==ot.array)return ht(n,{code:it.invalid_type,expected:ot.array,received:n.parsedType}),gt;if(n.data.length<this._def.items.length)return ht(n,{code:it.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),gt;!this._def.rest&&n.data.length>this._def.items.length&&(ht(n,{code:it.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const r=[...n.data].map((e,t)=>{const r=this._def.items[t]||this._def.rest;return r?r._parse(new Et(n,e,n.path,t)):null}).filter(e=>!!e);return n.common.async?Promise.all(r).then(e=>mt.mergeArray(t,e)):mt.mergeArray(t,r)}get items(){return this._def.items}rest(e){return new xn({...this._def,rest:e})}}xn.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new xn({items:e,typeName:Vn.ZodTuple,rest:null,...St(t)})};class kn extends At{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==ot.object)return ht(n,{code:it.invalid_type,expected:ot.object,received:n.parsedType}),gt;const r=[],s=this._def.keyType,o=this._def.valueType;for(const e in n.data)r.push({key:s._parse(new Et(n,e,n.path,e)),value:o._parse(new Et(n,n.data[e],n.path,e)),alwaysSet:e in n.data});return n.common.async?mt.mergeObjectAsync(t,r):mt.mergeObjectSync(t,r)}get element(){return this._def.valueType}static create(e,t,n){return new kn(t instanceof At?{keyType:e,valueType:t,typeName:Vn.ZodRecord,...St(n)}:{keyType:en.create(),valueType:e,typeName:Vn.ZodRecord,...St(t)})}}class Tn extends At{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==ot.map)return ht(n,{code:it.invalid_type,expected:ot.map,received:n.parsedType}),gt;const r=this._def.keyType,s=this._def.valueType,o=[...n.data.entries()].map(([e,t],o)=>({key:r._parse(new Et(n,e,n.path,[o,"key"])),value:s._parse(new Et(n,t,n.path,[o,"value"]))}));if(n.common.async){const e=new Map;return Promise.resolve().then(async()=>{for(const n of o){const r=await n.key,s=await n.value;if("aborted"===r.status||"aborted"===s.status)return gt;"dirty"!==r.status&&"dirty"!==s.status||t.dirty(),e.set(r.value,s.value)}return{status:t.value,value:e}})}{const e=new Map;for(const n of o){const r=n.key,s=n.value;if("aborted"===r.status||"aborted"===s.status)return gt;"dirty"!==r.status&&"dirty"!==s.status||t.dirty(),e.set(r.value,s.value)}return{status:t.value,value:e}}}}Tn.create=(e,t,n)=>new Tn({valueType:t,keyType:e,typeName:Vn.ZodMap,...St(n)});class Nn extends At{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==ot.set)return ht(n,{code:it.invalid_type,expected:ot.set,received:n.parsedType}),gt;const r=this._def;null!==r.minSize&&n.data.size<r.minSize.value&&(ht(n,{code:it.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),t.dirty()),null!==r.maxSize&&n.data.size>r.maxSize.value&&(ht(n,{code:it.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),t.dirty());const s=this._def.valueType;function o(e){const n=new Set;for(const r of e){if("aborted"===r.status)return gt;"dirty"===r.status&&t.dirty(),n.add(r.value)}return{status:t.value,value:n}}const a=[...n.data.values()].map((e,t)=>s._parse(new Et(n,e,n.path,t)));return n.common.async?Promise.all(a).then(e=>o(e)):o(a)}min(e,t){return new Nn({...this._def,minSize:{value:e,message:Tt.toString(t)}})}max(e,t){return new Nn({...this._def,maxSize:{value:e,message:Tt.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Nn.create=(e,t)=>new Nn({valueType:e,minSize:null,maxSize:null,typeName:Vn.ZodSet,...St(t)});class In extends At{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==ot.function)return ht(t,{code:it.invalid_type,expected:ot.function,received:t.parsedType}),gt;function n(e,n){return pt({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,dt(),ut].filter(e=>!!e),issueData:{code:it.invalid_arguments,argumentsError:n}})}function r(e,n){return pt({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,dt(),ut].filter(e=>!!e),issueData:{code:it.invalid_return_type,returnTypeError:n}})}const s={errorMap:t.common.contextualErrorMap},o=t.data;if(this._def.returns instanceof On){const e=this;return yt(async function(...t){const a=new lt([]),i=await e._def.args.parseAsync(t,s).catch(e=>{throw a.addIssue(n(t,e)),a}),l=await Reflect.apply(o,this,i);return await e._def.returns._def.type.parseAsync(l,s).catch(e=>{throw a.addIssue(r(l,e)),a})})}{const e=this;return yt(function(...t){const a=e._def.args.safeParse(t,s);if(!a.success)throw new lt([n(t,a.error)]);const i=Reflect.apply(o,this,a.data),l=e._def.returns.safeParse(i,s);if(!l.success)throw new lt([r(i,l.error)]);return l.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new In({...this._def,args:xn.create(e).rest(dn.create())})}returns(e){return new In({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new In({args:e||xn.create([]).rest(dn.create()),returns:t||dn.create(),typeName:Vn.ZodFunction,...St(n)})}}class En extends At{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}En.create=(e,t)=>new En({getter:e,typeName:Vn.ZodLazy,...St(t)});class Cn extends At{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return ht(t,{received:t.data,code:it.invalid_literal,expected:this._def.value}),gt}return{status:"valid",value:e.data}}get value(){return this._def.value}}function Sn(e,t){return new An({values:e,typeName:Vn.ZodEnum,...St(t)})}Cn.create=(e,t)=>new Cn({value:e,typeName:Vn.ZodLiteral,...St(t)});class An extends At{constructor(){super(...arguments),Nt.set(this,void 0)}_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return ht(t,{expected:Ke.joinValues(n),received:t.parsedType,code:it.invalid_type}),gt}if(xt(this,Nt)||kt(this,Nt,new Set(this._def.values)),!xt(this,Nt).has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return ht(t,{received:t.data,code:it.invalid_enum_value,options:n}),gt}return yt(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return An.create(e,{...this._def,...t})}exclude(e,t=this._def){return An.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}Nt=new WeakMap,An.create=Sn;class Rn extends At{constructor(){super(...arguments),It.set(this,void 0)}_parse(e){const t=Ke.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==ot.string&&n.parsedType!==ot.number){const e=Ke.objectValues(t);return ht(n,{expected:Ke.joinValues(e),received:n.parsedType,code:it.invalid_type}),gt}if(xt(this,It)||kt(this,It,new Set(Ke.getValidEnumValues(this._def.values))),!xt(this,It).has(e.data)){const e=Ke.objectValues(t);return ht(n,{received:n.data,code:it.invalid_enum_value,options:e}),gt}return yt(e.data)}get enum(){return this._def.values}}It=new WeakMap,Rn.create=(e,t)=>new Rn({values:e,typeName:Vn.ZodNativeEnum,...St(t)});class On extends At{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==ot.promise&&!1===t.common.async)return ht(t,{code:it.invalid_type,expected:ot.promise,received:t.parsedType}),gt;const n=t.parsedType===ot.promise?t.data:Promise.resolve(t.data);return yt(n.then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}On.create=(e,t)=>new On({type:e,typeName:Vn.ZodPromise,...St(t)});class jn extends At{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===Vn.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=this._def.effect||null,s={addIssue:e=>{ht(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(s.addIssue=s.addIssue.bind(s),"preprocess"===r.type){const e=r.transform(n.data,s);if(n.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return gt;const r=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===r.status?gt:"dirty"===r.status||"dirty"===t.value?ft(r.value):r});{if("aborted"===t.value)return gt;const r=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===r.status?gt:"dirty"===r.status||"dirty"===t.value?ft(r.value):r}}if("refinement"===r.type){const e=e=>{const t=r.refinement(e,s);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const r=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===r.status?gt:("dirty"===r.status&&t.dirty(),e(r.value),{status:t.value,value:r.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(n=>"aborted"===n.status?gt:("dirty"===n.status&&t.dirty(),e(n.value).then(()=>({status:t.value,value:n.value}))))}if("transform"===r.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!wt(e))return e;const o=r.transform(e.value,s);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(e=>wt(e)?Promise.resolve(r.transform(e.value,s)).then(e=>({status:t.value,value:e})):e)}Ke.assertNever(r)}}jn.create=(e,t,n)=>new jn({schema:e,typeName:Vn.ZodEffects,effect:t,...St(n)}),jn.createWithPreprocess=(e,t,n)=>new jn({schema:t,effect:{type:"preprocess",transform:e},typeName:Vn.ZodEffects,...St(n)});class Mn extends At{_parse(e){return this._getType(e)===ot.undefined?yt(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Mn.create=(e,t)=>new Mn({innerType:e,typeName:Vn.ZodOptional,...St(t)});class Pn extends At{_parse(e){return this._getType(e)===ot.null?yt(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Pn.create=(e,t)=>new Pn({innerType:e,typeName:Vn.ZodNullable,...St(t)});class Dn extends At{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===ot.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Dn.create=(e,t)=>new Dn({innerType:e,typeName:Vn.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...St(t)});class $n extends At{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return _t(r)?r.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new lt(n.common.issues)},input:n.data})})):{status:"valid",value:"valid"===r.status?r.value:this._def.catchValue({get error(){return new lt(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}$n.create=(e,t)=>new $n({innerType:e,typeName:Vn.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...St(t)});class Un extends At{_parse(e){if(this._getType(e)!==ot.nan){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:ot.nan,received:t.parsedType}),gt}return{status:"valid",value:e.data}}}Un.create=e=>new Un({typeName:Vn.ZodNaN,...St(e)});const qn=Symbol("zod_brand");class Ln extends At{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class Fn extends At{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?gt:"dirty"===e.status?(t.dirty(),ft(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})();{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?gt:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new Fn({in:e,out:t,typeName:Vn.ZodPipeline})}}class Bn extends At{_parse(e){const t=this._def.innerType._parse(e),n=e=>(wt(e)&&(e.value=Object.freeze(e.value)),e);return _t(t)?t.then(e=>n(e)):n(t)}unwrap(){return this._def.innerType}}function Hn(e,t){const n="function"==typeof e?e(t):"string"==typeof e?{message:e}:e;return"string"==typeof n?{message:n}:n}function Zn(e,t={},n){return e?cn.create().superRefine((r,s)=>{var o,a;const i=e(r);if(i instanceof Promise)return i.then(e=>{var o,a;if(!e){const e=Hn(t,r),i=null===(a=null!==(o=e.fatal)&&void 0!==o?o:n)||void 0===a||a;s.addIssue({code:"custom",...e,fatal:i})}});if(!i){const e=Hn(t,r),i=null===(a=null!==(o=e.fatal)&&void 0!==o?o:n)||void 0===a||a;s.addIssue({code:"custom",...e,fatal:i})}}):cn.create()}Bn.create=(e,t)=>new Bn({innerType:e,typeName:Vn.ZodReadonly,...St(t)});const Wn={object:fn.lazycreate};var Vn;!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(Vn||(Vn={}));const zn=en.create,Gn=nn.create,Kn=Un.create,Jn=rn.create,Xn=sn.create,Yn=on.create,Qn=an.create,er=ln.create,tr=un.create,nr=cn.create,rr=dn.create,sr=pn.create,or=hn.create,ar=mn.create,ir=fn.create,lr=fn.strictCreate,ur=yn.create,cr=vn.create,dr=_n.create,pr=xn.create,hr=kn.create,mr=Tn.create,gr=Nn.create,fr=In.create,yr=En.create,br=Cn.create,vr=An.create,wr=Rn.create,_r=On.create,xr=jn.create,kr=Mn.create,Tr=Pn.create,Nr=jn.createWithPreprocess,Ir=Fn.create,Er={string:e=>en.create({...e,coerce:!0}),number:e=>nn.create({...e,coerce:!0}),boolean:e=>sn.create({...e,coerce:!0}),bigint:e=>rn.create({...e,coerce:!0}),date:e=>on.create({...e,coerce:!0})},Cr=gt;var Sr=Object.freeze({__proto__:null,defaultErrorMap:ut,setErrorMap:function(e){ct=e},getErrorMap:dt,makeIssue:pt,EMPTY_PATH:[],addIssueToContext:ht,ParseStatus:mt,INVALID:gt,DIRTY:ft,OK:yt,isAborted:bt,isDirty:vt,isValid:wt,isAsync:_t,get util(){return Ke},get objectUtil(){return Je},ZodParsedType:ot,getParsedType:at,ZodType:At,datetimeRegex:Jt,ZodString:en,ZodNumber:nn,ZodBigInt:rn,ZodBoolean:sn,ZodDate:on,ZodSymbol:an,ZodUndefined:ln,ZodNull:un,ZodAny:cn,ZodUnknown:dn,ZodNever:pn,ZodVoid:hn,ZodArray:mn,ZodObject:fn,ZodUnion:yn,ZodDiscriminatedUnion:vn,ZodIntersection:_n,ZodTuple:xn,ZodRecord:kn,ZodMap:Tn,ZodSet:Nn,ZodFunction:In,ZodLazy:En,ZodLiteral:Cn,ZodEnum:An,ZodNativeEnum:Rn,ZodPromise:On,ZodEffects:jn,ZodTransformer:jn,ZodOptional:Mn,ZodNullable:Pn,ZodDefault:Dn,ZodCatch:$n,ZodNaN:Un,BRAND:qn,ZodBranded:Ln,ZodPipeline:Fn,ZodReadonly:Bn,custom:Zn,Schema:At,ZodSchema:At,late:Wn,get ZodFirstPartyTypeKind(){return Vn},coerce:Er,any:nr,array:ar,bigint:Jn,boolean:Xn,date:Yn,discriminatedUnion:cr,effect:xr,enum:vr,function:fr,instanceof:(e,t={message:`Input not instance of ${e.name}`})=>Zn(t=>t instanceof e,t),intersection:dr,lazy:yr,literal:br,map:mr,nan:Kn,nativeEnum:wr,never:sr,null:tr,nullable:Tr,number:Gn,object:ir,oboolean:()=>Xn().optional(),onumber:()=>Gn().optional(),optional:kr,ostring:()=>zn().optional(),pipeline:Ir,preprocess:Nr,promise:_r,record:hr,set:gr,strictObject:lr,string:zn,symbol:Qn,transformer:xr,tuple:pr,undefined:er,union:ur,unknown:rr,void:or,NEVER:Cr,ZodIssueCode:it,quotelessJson:e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:lt});function Ar(e){var t,n;return null!=(n=null==(t=null==e?void 0:e.content)?void 0:t.map(({token:e,logprob:t,top_logprobs:n})=>({token:e,logprob:t,topLogprobs:n?n.map(({token:e,logprob:t})=>({token:e,logprob:t})):[]})))?n:void 0}function Rr(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var Or=Sr.object({error:Sr.object({message:Sr.string(),type:Sr.string().nullish(),param:Sr.any().nullish(),code:Sr.union([Sr.string(),Sr.number()]).nullish()})}),jr=Xe({errorSchema:Or,errorToMessage:e=>e.error.message});function Mr({id:e,model:t,created:n}){return{id:null!=e?e:void 0,modelId:null!=t?t:void 0,timestamp:null!=n?new Date(1e3*n):void 0}}var Pr=class{constructor(e,t,n){this.specificationVersion="v1",this.modelId=e,this.settings=t,this.config=n}get supportsStructuredOutputs(){var e;return null!=(e=this.settings.structuredOutputs)?e:qr(this.modelId)}get defaultObjectGenerationMode(){return this.modelId.startsWith("gpt-4o-audio-preview")?"tool":this.supportsStructuredOutputs?"json":"tool"}get provider(){return this.config.provider}get supportsImageUrls(){return!this.settings.downloadImages}getArgs({mode:e,prompt:t,maxTokens:n,temperature:r,topP:s,topK:o,frequencyPenalty:a,presencePenalty:i,stopSequences:l,responseFormat:u,seed:c,providerMetadata:d}){var p,h,m,g,f,y,b,v;const w=e.type,_=[];null!=o&&_.push({type:"unsupported-setting",setting:"topK"}),"json"!==(null==u?void 0:u.type)||null==u.schema||this.supportsStructuredOutputs||_.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is only supported with structuredOutputs"});const x=this.settings.useLegacyFunctionCalling;if(x&&!0===this.settings.parallelToolCalls)throw new Ne({functionality:"useLegacyFunctionCalling with parallelToolCalls"});if(x&&this.supportsStructuredOutputs)throw new Ne({functionality:"structuredOutputs with useLegacyFunctionCalling"});const{messages:k,warnings:T}=function({prompt:e,useLegacyFunctionCalling:t=!1,systemMessageMode:n="system"}){const r=[],s=[];for(const{role:o,content:a}of e)switch(o){case"system":switch(n){case"system":r.push({role:"system",content:a});break;case"developer":r.push({role:"developer",content:a});break;case"remove":s.push({type:"other",message:"system messages are removed for this model"});break;default:throw new Error(`Unsupported system message mode: ${n}`)}break;case"user":if(1===a.length&&"text"===a[0].type){r.push({role:"user",content:a[0].text});break}r.push({role:"user",content:a.map((e,t)=>{var n,r,s,o;switch(e.type){case"text":return{type:"text",text:e.text};case"image":return{type:"image_url",image_url:{url:e.image instanceof URL?e.image.toString():`data:${null!=(n=e.mimeType)?n:"image/jpeg"};base64,${rt(e.image)}`,detail:null==(s=null==(r=e.providerMetadata)?void 0:r.openai)?void 0:s.imageDetail}};case"file":if(e.data instanceof URL)throw new Ne({functionality:"'File content parts with URL data' functionality not supported."});switch(e.mimeType){case"audio/wav":return{type:"input_audio",input_audio:{data:e.data,format:"wav"}};case"audio/mp3":case"audio/mpeg":return{type:"input_audio",input_audio:{data:e.data,format:"mp3"}};case"application/pdf":return{type:"file",file:{filename:null!=(o=e.filename)?o:`part-${t}.pdf`,file_data:`data:application/pdf;base64,${e.data}`}};default:throw new Ne({functionality:`File content part type ${e.mimeType} in user messages`})}}})});break;case"assistant":{let e="";const n=[];for(const t of a)switch(t.type){case"text":e+=t.text;break;case"tool-call":n.push({id:t.toolCallId,type:"function",function:{name:t.toolName,arguments:JSON.stringify(t.args)}})}if(t){if(n.length>1)throw new Ne({functionality:"useLegacyFunctionCalling with multiple tool calls in one message"});r.push({role:"assistant",content:e,function_call:n.length>0?n[0].function:void 0})}else r.push({role:"assistant",content:e,tool_calls:n.length>0?n:void 0});break}case"tool":for(const e of a)t?r.push({role:"function",name:e.toolName,content:JSON.stringify(e.result)}):r.push({role:"tool",tool_call_id:e.toolCallId,content:JSON.stringify(e.result)});break;default:throw new Error(`Unsupported role: ${o}`)}return{messages:r,warnings:s}}({prompt:t,useLegacyFunctionCalling:x,systemMessageMode:Lr(this.modelId)});_.push(...T);const N={model:this.modelId,logit_bias:this.settings.logitBias,logprobs:!0===this.settings.logprobs||"number"==typeof this.settings.logprobs||void 0,top_logprobs:"number"==typeof this.settings.logprobs?this.settings.logprobs:"boolean"==typeof this.settings.logprobs&&this.settings.logprobs?0:void 0,user:this.settings.user,parallel_tool_calls:this.settings.parallelToolCalls,max_tokens:n,temperature:r,top_p:s,frequency_penalty:a,presence_penalty:i,response_format:"json"===(null==u?void 0:u.type)?this.supportsStructuredOutputs&&null!=u.schema?{type:"json_schema",json_schema:{schema:u.schema,strict:!0,name:null!=(p=u.name)?p:"response",description:u.description}}:{type:"json_object"}:void 0,stop:l,seed:c,max_completion_tokens:null==(h=null==d?void 0:d.openai)?void 0:h.maxCompletionTokens,store:null==(m=null==d?void 0:d.openai)?void 0:m.store,metadata:null==(g=null==d?void 0:d.openai)?void 0:g.metadata,prediction:null==(f=null==d?void 0:d.openai)?void 0:f.prediction,reasoning_effort:null!=(b=null==(y=null==d?void 0:d.openai)?void 0:y.reasoningEffort)?b:this.settings.reasoningEffort,messages:k};switch(qr(this.modelId)?(null!=N.temperature&&(N.temperature=void 0,_.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for reasoning models"})),null!=N.top_p&&(N.top_p=void 0,_.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported for reasoning models"})),null!=N.frequency_penalty&&(N.frequency_penalty=void 0,_.push({type:"unsupported-setting",setting:"frequencyPenalty",details:"frequencyPenalty is not supported for reasoning models"})),null!=N.presence_penalty&&(N.presence_penalty=void 0,_.push({type:"unsupported-setting",setting:"presencePenalty",details:"presencePenalty is not supported for reasoning models"})),null!=N.logit_bias&&(N.logit_bias=void 0,_.push({type:"other",message:"logitBias is not supported for reasoning models"})),null!=N.logprobs&&(N.logprobs=void 0,_.push({type:"other",message:"logprobs is not supported for reasoning models"})),null!=N.top_logprobs&&(N.top_logprobs=void 0,_.push({type:"other",message:"topLogprobs is not supported for reasoning models"})),null!=N.max_tokens&&(null==N.max_completion_tokens&&(N.max_completion_tokens=N.max_tokens),N.max_tokens=void 0)):(this.modelId.startsWith("gpt-4o-search-preview")||this.modelId.startsWith("gpt-4o-mini-search-preview"))&&null!=N.temperature&&(N.temperature=void 0,_.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for the search preview models and has been removed."})),w){case"regular":{const{tools:t,tool_choice:n,functions:r,function_call:s,toolWarnings:o}=function({mode:e,useLegacyFunctionCalling:t=!1,structuredOutputs:n}){var r;const s=(null==(r=e.tools)?void 0:r.length)?e.tools:void 0,o=[];if(null==s)return{tools:void 0,tool_choice:void 0,toolWarnings:o};const a=e.toolChoice;if(t){const e=[];for(const t of s)"provider-defined"===t.type?o.push({type:"unsupported-tool",tool:t}):e.push({name:t.name,description:t.description,parameters:t.parameters});if(null==a)return{functions:e,function_call:void 0,toolWarnings:o};switch(a.type){case"auto":case"none":case void 0:return{functions:e,function_call:void 0,toolWarnings:o};case"required":throw new Ne({functionality:"useLegacyFunctionCalling and toolChoice: required"});default:return{functions:e,function_call:{name:a.toolName},toolWarnings:o}}}const i=[];for(const e of s)"provider-defined"===e.type?o.push({type:"unsupported-tool",tool:e}):i.push({type:"function",function:{name:e.name,description:e.description,parameters:e.parameters,strict:!!n||void 0}});if(null==a)return{tools:i,tool_choice:void 0,toolWarnings:o};const l=a.type;switch(l){case"auto":case"none":case"required":return{tools:i,tool_choice:l,toolWarnings:o};case"tool":return{tools:i,tool_choice:{type:"function",function:{name:a.toolName}},toolWarnings:o};default:throw new Ne({functionality:`Unsupported tool choice type: ${l}`})}}({mode:e,useLegacyFunctionCalling:x,structuredOutputs:this.supportsStructuredOutputs});return{args:{...N,tools:t,tool_choice:n,functions:r,function_call:s},warnings:[..._,...o]}}case"object-json":return{args:{...N,response_format:this.supportsStructuredOutputs&&null!=e.schema?{type:"json_schema",json_schema:{schema:e.schema,strict:!0,name:null!=(v=e.name)?v:"response",description:e.description}}:{type:"json_object"}},warnings:_};case"object-tool":return{args:x?{...N,function_call:{name:e.tool.name},functions:[{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters}]}:{...N,tool_choice:{type:"function",function:{name:e.tool.name}},tools:[{type:"function",function:{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters,strict:!!this.supportsStructuredOutputs||void 0}}]},warnings:_};default:throw new Error(`Unsupported type: ${w}`)}}async doGenerate(e){var t,n,r,s,o,a,i,l;const{args:u,warnings:c}=this.getArgs(e),{responseHeaders:d,value:p,rawValue:h}=await Ve({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:u,failedResponseHandler:jr,successfulResponseHandler:Qe($r),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:m,...g}=u,f=p.choices[0],y=null==(t=p.usage)?void 0:t.completion_tokens_details,b=null==(n=p.usage)?void 0:n.prompt_tokens_details,v={openai:{}};return null!=(null==y?void 0:y.reasoning_tokens)&&(v.openai.reasoningTokens=null==y?void 0:y.reasoning_tokens),null!=(null==y?void 0:y.accepted_prediction_tokens)&&(v.openai.acceptedPredictionTokens=null==y?void 0:y.accepted_prediction_tokens),null!=(null==y?void 0:y.rejected_prediction_tokens)&&(v.openai.rejectedPredictionTokens=null==y?void 0:y.rejected_prediction_tokens),null!=(null==b?void 0:b.cached_tokens)&&(v.openai.cachedPromptTokens=null==b?void 0:b.cached_tokens),{text:null!=(r=f.message.content)?r:void 0,toolCalls:this.settings.useLegacyFunctionCalling&&f.message.function_call?[{toolCallType:"function",toolCallId:Me(),toolName:f.message.function_call.name,args:f.message.function_call.arguments}]:null==(s=f.message.tool_calls)?void 0:s.map(e=>{var t;return{toolCallType:"function",toolCallId:null!=(t=e.id)?t:Me(),toolName:e.function.name,args:e.function.arguments}}),finishReason:Rr(f.finish_reason),usage:{promptTokens:null!=(a=null==(o=p.usage)?void 0:o.prompt_tokens)?a:NaN,completionTokens:null!=(l=null==(i=p.usage)?void 0:i.completion_tokens)?l:NaN},rawCall:{rawPrompt:m,rawSettings:g},rawResponse:{headers:d,body:h},request:{body:JSON.stringify(u)},response:Mr(p),warnings:c,logprobs:Ar(f.logprobs),providerMetadata:v}}async doStream(e){if(this.settings.simulateStreaming){const t=await this.doGenerate(e);return{stream:new ReadableStream({start(e){if(e.enqueue({type:"response-metadata",...t.response}),t.text&&e.enqueue({type:"text-delta",textDelta:t.text}),t.toolCalls)for(const n of t.toolCalls)e.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:n.toolCallId,toolName:n.toolName,argsTextDelta:n.args}),e.enqueue({type:"tool-call",...n});e.enqueue({type:"finish",finishReason:t.finishReason,usage:t.usage,logprobs:t.logprobs,providerMetadata:t.providerMetadata}),e.close()}}),rawCall:t.rawCall,rawResponse:t.rawResponse,warnings:t.warnings}}const{args:t,warnings:n}=this.getArgs(e),r={...t,stream:!0,stream_options:"strict"===this.config.compatibility?{include_usage:!0}:void 0},{responseHeaders:s,value:o}=await Ve({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:r,failedResponseHandler:jr,successfulResponseHandler:Ye(Ur),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:a,...i}=t,l=[];let u,c="unknown",d={promptTokens:void 0,completionTokens:void 0},p=!0;const{useLegacyFunctionCalling:h}=this.settings,m={openai:{}};return{stream:o.pipeThrough(new TransformStream({transform(e,t){var n,r,s,o,a,i,g,f,y,b,v,w;if(!e.success)return c="error",void t.enqueue({type:"error",error:e.error});const _=e.value;if("error"in _)return c="error",void t.enqueue({type:"error",error:_.error});if(p&&(p=!1,t.enqueue({type:"response-metadata",...Mr(_)})),null!=_.usage){const{prompt_tokens:e,completion_tokens:t,prompt_tokens_details:n,completion_tokens_details:r}=_.usage;d={promptTokens:null!=e?e:void 0,completionTokens:null!=t?t:void 0},null!=(null==r?void 0:r.reasoning_tokens)&&(m.openai.reasoningTokens=null==r?void 0:r.reasoning_tokens),null!=(null==r?void 0:r.accepted_prediction_tokens)&&(m.openai.acceptedPredictionTokens=null==r?void 0:r.accepted_prediction_tokens),null!=(null==r?void 0:r.rejected_prediction_tokens)&&(m.openai.rejectedPredictionTokens=null==r?void 0:r.rejected_prediction_tokens),null!=(null==n?void 0:n.cached_tokens)&&(m.openai.cachedPromptTokens=null==n?void 0:n.cached_tokens)}const x=_.choices[0];if(null!=(null==x?void 0:x.finish_reason)&&(c=Rr(x.finish_reason)),null==(null==x?void 0:x.delta))return;const k=x.delta;null!=k.content&&t.enqueue({type:"text-delta",textDelta:k.content});const T=Ar(null==x?void 0:x.logprobs);(null==T?void 0:T.length)&&(void 0===u&&(u=[]),u.push(...T));const N=h&&null!=k.function_call?[{type:"function",id:Me(),function:k.function_call,index:0}]:k.tool_calls;if(null!=N)for(const e of N){const u=e.index;if(null==l[u]){if("function"!==e.type)throw new Z({data:e,message:"Expected 'function' type."});if(null==e.id)throw new Z({data:e,message:"Expected 'id' to be a string."});if(null==(null==(n=e.function)?void 0:n.name))throw new Z({data:e,message:"Expected 'function.name' to be a string."});l[u]={id:e.id,type:"function",function:{name:e.function.name,arguments:null!=(r=e.function.arguments)?r:""},hasFinished:!1};const i=l[u];null!=(null==(s=i.function)?void 0:s.name)&&null!=(null==(o=i.function)?void 0:o.arguments)&&(i.function.arguments.length>0&&t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:i.id,toolName:i.function.name,argsTextDelta:i.function.arguments}),He(i.function.arguments)&&(t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:null!=(a=i.id)?a:Me(),toolName:i.function.name,args:i.function.arguments}),i.hasFinished=!0));continue}const c=l[u];c.hasFinished||(null!=(null==(i=e.function)?void 0:i.arguments)&&(c.function.arguments+=null!=(f=null==(g=e.function)?void 0:g.arguments)?f:""),t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:c.id,toolName:c.function.name,argsTextDelta:null!=(y=e.function.arguments)?y:""}),null!=(null==(b=c.function)?void 0:b.name)&&null!=(null==(v=c.function)?void 0:v.arguments)&&He(c.function.arguments)&&(t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:null!=(w=c.id)?w:Me(),toolName:c.function.name,args:c.function.arguments}),c.hasFinished=!0))}},flush(e){var t,n;e.enqueue({type:"finish",finishReason:c,logprobs:u,usage:{promptTokens:null!=(t=d.promptTokens)?t:NaN,completionTokens:null!=(n=d.completionTokens)?n:NaN},...null!=m?{providerMetadata:m}:{}})}})),rawCall:{rawPrompt:a,rawSettings:i},rawResponse:{headers:s},request:{body:JSON.stringify(r)},warnings:n}}},Dr=Sr.object({prompt_tokens:Sr.number().nullish(),completion_tokens:Sr.number().nullish(),prompt_tokens_details:Sr.object({cached_tokens:Sr.number().nullish()}).nullish(),completion_tokens_details:Sr.object({reasoning_tokens:Sr.number().nullish(),accepted_prediction_tokens:Sr.number().nullish(),rejected_prediction_tokens:Sr.number().nullish()}).nullish()}).nullish(),$r=Sr.object({id:Sr.string().nullish(),created:Sr.number().nullish(),model:Sr.string().nullish(),choices:Sr.array(Sr.object({message:Sr.object({role:Sr.literal("assistant").nullish(),content:Sr.string().nullish(),function_call:Sr.object({arguments:Sr.string(),name:Sr.string()}).nullish(),tool_calls:Sr.array(Sr.object({id:Sr.string().nullish(),type:Sr.literal("function"),function:Sr.object({name:Sr.string(),arguments:Sr.string()})})).nullish()}),index:Sr.number(),logprobs:Sr.object({content:Sr.array(Sr.object({token:Sr.string(),logprob:Sr.number(),top_logprobs:Sr.array(Sr.object({token:Sr.string(),logprob:Sr.number()}))})).nullable()}).nullish(),finish_reason:Sr.string().nullish()})),usage:Dr}),Ur=Sr.union([Sr.object({id:Sr.string().nullish(),created:Sr.number().nullish(),model:Sr.string().nullish(),choices:Sr.array(Sr.object({delta:Sr.object({role:Sr.enum(["assistant"]).nullish(),content:Sr.string().nullish(),function_call:Sr.object({name:Sr.string().optional(),arguments:Sr.string().optional()}).nullish(),tool_calls:Sr.array(Sr.object({index:Sr.number(),id:Sr.string().nullish(),type:Sr.literal("function").nullish(),function:Sr.object({name:Sr.string().nullish(),arguments:Sr.string().nullish()})})).nullish()}).nullish(),logprobs:Sr.object({content:Sr.array(Sr.object({token:Sr.string(),logprob:Sr.number(),top_logprobs:Sr.array(Sr.object({token:Sr.string(),logprob:Sr.number()}))})).nullable()}).nullish(),finish_reason:Sr.string().nullish(),index:Sr.number()})),usage:Dr}),Or]);function qr(e){return e.startsWith("o")}function Lr(e){var t,n;return qr(e)?null!=(n=null==(t=Fr[e])?void 0:t.systemMessageMode)?n:"developer":"system"}var Fr={"o1-mini":{systemMessageMode:"remove"},"o1-mini-2024-09-12":{systemMessageMode:"remove"},"o1-preview":{systemMessageMode:"remove"},"o1-preview-2024-09-12":{systemMessageMode:"remove"},o3:{systemMessageMode:"developer"},"o3-2025-04-16":{systemMessageMode:"developer"},"o3-mini":{systemMessageMode:"developer"},"o3-mini-2025-01-31":{systemMessageMode:"developer"},"o4-mini":{systemMessageMode:"developer"},"o4-mini-2025-04-16":{systemMessageMode:"developer"}};function Br(e){return null==e?void 0:e.tokens.map((t,n)=>({token:t,logprob:e.token_logprobs[n],topLogprobs:e.top_logprobs?Object.entries(e.top_logprobs[n]).map(([e,t])=>({token:e,logprob:t})):[]}))}var Hr=class{constructor(e,t,n){this.specificationVersion="v1",this.defaultObjectGenerationMode=void 0,this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}getArgs({mode:e,inputFormat:t,prompt:n,maxTokens:r,temperature:s,topP:o,topK:a,frequencyPenalty:i,presencePenalty:l,stopSequences:u,responseFormat:c,seed:d}){var p;const h=e.type,m=[];null!=a&&m.push({type:"unsupported-setting",setting:"topK"}),null!=c&&"text"!==c.type&&m.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});const{prompt:g,stopSequences:f}=function({prompt:e,inputFormat:t,user:n="user",assistant:r="assistant"}){if("prompt"===t&&1===e.length&&"user"===e[0].role&&1===e[0].content.length&&"text"===e[0].content[0].type)return{prompt:e[0].content[0].text};let s="";"system"===e[0].role&&(s+=`${e[0].content}\n\n`,e=e.slice(1));for(const{role:t,content:o}of e)switch(t){case"system":throw new q({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":s+=`${n}:\n${o.map(e=>{switch(e.type){case"text":return e.text;case"image":throw new Ne({functionality:"images"})}}).join("")}\n\n`;break;case"assistant":s+=`${r}:\n${o.map(e=>{switch(e.type){case"text":return e.text;case"tool-call":throw new Ne({functionality:"tool-call messages"})}}).join("")}\n\n`;break;case"tool":throw new Ne({functionality:"tool messages"});default:throw new Error(`Unsupported role: ${t}`)}return s+=`${r}:\n`,{prompt:s,stopSequences:[`\n${n}:`]}}({prompt:n,inputFormat:t}),y=[...null!=f?f:[],...null!=u?u:[]],b={model:this.modelId,echo:this.settings.echo,logit_bias:this.settings.logitBias,logprobs:"number"==typeof this.settings.logprobs?this.settings.logprobs:"boolean"==typeof this.settings.logprobs&&this.settings.logprobs?0:void 0,suffix:this.settings.suffix,user:this.settings.user,max_tokens:r,temperature:s,top_p:o,frequency_penalty:i,presence_penalty:l,seed:d,prompt:g,stop:y.length>0?y:void 0};switch(h){case"regular":if(null==(p=e.tools)?void 0:p.length)throw new Ne({functionality:"tools"});if(e.toolChoice)throw new Ne({functionality:"toolChoice"});return{args:b,warnings:m};case"object-json":throw new Ne({functionality:"object-json mode"});case"object-tool":throw new Ne({functionality:"object-tool mode"});default:throw new Error(`Unsupported type: ${h}`)}}async doGenerate(e){const{args:t,warnings:n}=this.getArgs(e),{responseHeaders:r,value:s,rawValue:o}=await Ve({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:t,failedResponseHandler:jr,successfulResponseHandler:Qe(Zr),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:a,...i}=t,l=s.choices[0];return{text:l.text,usage:{promptTokens:s.usage.prompt_tokens,completionTokens:s.usage.completion_tokens},finishReason:Rr(l.finish_reason),logprobs:Br(l.logprobs),rawCall:{rawPrompt:a,rawSettings:i},rawResponse:{headers:r,body:o},response:Mr(s),warnings:n,request:{body:JSON.stringify(t)}}}async doStream(e){const{args:t,warnings:n}=this.getArgs(e),r={...t,stream:!0,stream_options:"strict"===this.config.compatibility?{include_usage:!0}:void 0},{responseHeaders:s,value:o}=await Ve({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:r,failedResponseHandler:jr,successfulResponseHandler:Ye(Wr),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:a,...i}=t;let l,u="unknown",c={promptTokens:Number.NaN,completionTokens:Number.NaN},d=!0;return{stream:o.pipeThrough(new TransformStream({transform(e,t){if(!e.success)return u="error",void t.enqueue({type:"error",error:e.error});const n=e.value;if("error"in n)return u="error",void t.enqueue({type:"error",error:n.error});d&&(d=!1,t.enqueue({type:"response-metadata",...Mr(n)})),null!=n.usage&&(c={promptTokens:n.usage.prompt_tokens,completionTokens:n.usage.completion_tokens});const r=n.choices[0];null!=(null==r?void 0:r.finish_reason)&&(u=Rr(r.finish_reason)),null!=(null==r?void 0:r.text)&&t.enqueue({type:"text-delta",textDelta:r.text});const s=Br(null==r?void 0:r.logprobs);(null==s?void 0:s.length)&&(void 0===l&&(l=[]),l.push(...s))},flush(e){e.enqueue({type:"finish",finishReason:u,logprobs:l,usage:c})}})),rawCall:{rawPrompt:a,rawSettings:i},rawResponse:{headers:s},warnings:n,request:{body:JSON.stringify(r)}}}},Zr=Sr.object({id:Sr.string().nullish(),created:Sr.number().nullish(),model:Sr.string().nullish(),choices:Sr.array(Sr.object({text:Sr.string(),finish_reason:Sr.string(),logprobs:Sr.object({tokens:Sr.array(Sr.string()),token_logprobs:Sr.array(Sr.number()),top_logprobs:Sr.array(Sr.record(Sr.string(),Sr.number())).nullable()}).nullish()})),usage:Sr.object({prompt_tokens:Sr.number(),completion_tokens:Sr.number()})}),Wr=Sr.union([Sr.object({id:Sr.string().nullish(),created:Sr.number().nullish(),model:Sr.string().nullish(),choices:Sr.array(Sr.object({text:Sr.string(),finish_reason:Sr.string().nullish(),index:Sr.number(),logprobs:Sr.object({tokens:Sr.array(Sr.string()),token_logprobs:Sr.array(Sr.number()),top_logprobs:Sr.array(Sr.record(Sr.string(),Sr.number())).nullable()}).nullish()})),usage:Sr.object({prompt_tokens:Sr.number(),completion_tokens:Sr.number()}).nullish()}),Or]),Vr=class{constructor(e,t,n){this.specificationVersion="v1",this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){var e;return null!=(e=this.settings.maxEmbeddingsPerCall)?e:2048}get supportsParallelCalls(){var e;return null==(e=this.settings.supportsParallelCalls)||e}async doEmbed({values:e,headers:t,abortSignal:n}){if(e.length>this.maxEmbeddingsPerCall)throw new ge({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const{responseHeaders:r,value:s}=await Ve({url:this.config.url({path:"/embeddings",modelId:this.modelId}),headers:Ae(this.config.headers(),t),body:{model:this.modelId,input:e,encoding_format:"float",dimensions:this.settings.dimensions,user:this.settings.user},failedResponseHandler:jr,successfulResponseHandler:Qe(zr),abortSignal:n,fetch:this.config.fetch});return{embeddings:s.data.map(e=>e.embedding),usage:s.usage?{tokens:s.usage.prompt_tokens}:void 0,rawResponse:{headers:r}}}},zr=Sr.object({data:Sr.array(Sr.object({embedding:Sr.array(Sr.number())})),usage:Sr.object({prompt_tokens:Sr.number()}).nullish()}),Gr={"dall-e-3":1,"dall-e-2":10,"gpt-image-1":10},Kr=new Set(["gpt-image-1"]),Jr=class{constructor(e,t,n){this.modelId=e,this.settings=t,this.config=n,this.specificationVersion="v1"}get maxImagesPerCall(){var e,t;return null!=(t=null!=(e=this.settings.maxImagesPerCall)?e:Gr[this.modelId])?t:1}get provider(){return this.config.provider}async doGenerate({prompt:e,n:t,size:n,aspectRatio:r,seed:s,providerOptions:o,headers:a,abortSignal:i}){var l,u,c,d;const p=[];null!=r&&p.push({type:"unsupported-setting",setting:"aspectRatio",details:"This model does not support aspect ratio. Use `size` instead."}),null!=s&&p.push({type:"unsupported-setting",setting:"seed"});const h=null!=(c=null==(u=null==(l=this.config._internal)?void 0:l.currentDate)?void 0:u.call(l))?c:new Date,{value:m,responseHeaders:g}=await Ve({url:this.config.url({path:"/images/generations",modelId:this.modelId}),headers:Ae(this.config.headers(),a),body:{model:this.modelId,prompt:e,n:t,size:n,...null!=(d=o.openai)?d:{},...Kr.has(this.modelId)?{}:{response_format:"b64_json"}},failedResponseHandler:jr,successfulResponseHandler:Qe(Xr),abortSignal:i,fetch:this.config.fetch});return{images:m.data.map(e=>e.b64_json),warnings:p,response:{timestamp:h,modelId:this.modelId,headers:g}}}},Xr=Sr.object({data:Sr.array(Sr.object({b64_json:Sr.string()}))}),Yr=Sr.object({include:Sr.array(Sr.string()).nullish(),language:Sr.string().nullish(),prompt:Sr.string().nullish(),temperature:Sr.number().min(0).max(1).nullish().default(0),timestampGranularities:Sr.array(Sr.enum(["word","segment"])).nullish().default(["segment"])}),Qr={afrikaans:"af",arabic:"ar",armenian:"hy",azerbaijani:"az",belarusian:"be",bosnian:"bs",bulgarian:"bg",catalan:"ca",chinese:"zh",croatian:"hr",czech:"cs",danish:"da",dutch:"nl",english:"en",estonian:"et",finnish:"fi",french:"fr",galician:"gl",german:"de",greek:"el",hebrew:"he",hindi:"hi",hungarian:"hu",icelandic:"is",indonesian:"id",italian:"it",japanese:"ja",kannada:"kn",kazakh:"kk",korean:"ko",latvian:"lv",lithuanian:"lt",macedonian:"mk",malay:"ms",marathi:"mr",maori:"mi",nepali:"ne",norwegian:"no",persian:"fa",polish:"pl",portuguese:"pt",romanian:"ro",russian:"ru",serbian:"sr",slovak:"sk",slovenian:"sl",spanish:"es",swahili:"sw",swedish:"sv",tagalog:"tl",tamil:"ta",thai:"th",turkish:"tr",ukrainian:"uk",urdu:"ur",vietnamese:"vi",welsh:"cy"},es=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v1"}get provider(){return this.config.provider}getArgs({audio:e,mediaType:t,providerOptions:n}){var r,s,o,a,i;const l=Ze({provider:"openai",providerOptions:n,schema:Yr}),u=new FormData,c=e instanceof Uint8Array?new Blob([e]):new Blob([nt(e)]);if(u.append("model",this.modelId),u.append("file",new File([c],"audio",{type:t})),l){const e={include:null!=(r=l.include)?r:void 0,language:null!=(s=l.language)?s:void 0,prompt:null!=(o=l.prompt)?o:void 0,temperature:null!=(a=l.temperature)?a:void 0,timestamp_granularities:null!=(i=l.timestampGranularities)?i:void 0};for(const t in e){const n=e[t];void 0!==n&&u.append(t,String(n))}}return{formData:u,warnings:[]}}async doGenerate(e){var t,n,r,s,o,a;const i=null!=(r=null==(n=null==(t=this.config._internal)?void 0:t.currentDate)?void 0:n.call(t))?r:new Date,{formData:l,warnings:u}=this.getArgs(e),{value:c,responseHeaders:d,rawValue:p}=await(async({url:e,headers:t,formData:n,failedResponseHandler:r,successfulResponseHandler:s,abortSignal:o,fetch:a})=>ze({url:e,headers:t,body:{content:n,values:Object.fromEntries(n.entries())},failedResponseHandler:r,successfulResponseHandler:s,abortSignal:o,fetch:a}))({url:this.config.url({path:"/audio/transcriptions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),formData:l,failedResponseHandler:jr,successfulResponseHandler:Qe(ts),abortSignal:e.abortSignal,fetch:this.config.fetch}),h=null!=c.language&&c.language in Qr?Qr[c.language]:void 0;return{text:c.text,segments:null!=(o=null==(s=c.words)?void 0:s.map(e=>({text:e.word,startSecond:e.start,endSecond:e.end})))?o:[],language:h,durationInSeconds:null!=(a=c.duration)?a:void 0,warnings:u,response:{timestamp:i,modelId:this.modelId,headers:d,body:p}}}},ts=Sr.object({text:Sr.string(),language:Sr.string().nullish(),duration:Sr.number().nullish(),words:Sr.array(Sr.object({word:Sr.string(),start:Sr.number(),end:Sr.number()})).nullish()});function ns({finishReason:e,hasToolCalls:t}){switch(e){case void 0:case null:return t?"tool-calls":"stop";case"max_output_tokens":return"length";case"content_filter":return"content-filter";default:return t?"tool-calls":"unknown"}}var rs=class{constructor(e,t){this.specificationVersion="v1",this.defaultObjectGenerationMode="json",this.supportsStructuredOutputs=!0,this.modelId=e,this.config=t}get provider(){return this.config.provider}getArgs({mode:e,maxTokens:t,temperature:n,stopSequences:r,topP:s,topK:o,presencePenalty:a,frequencyPenalty:i,seed:l,prompt:u,providerMetadata:c,responseFormat:d}){var p,h,m;const g=[],f=(b=this.modelId).startsWith("o")?b.startsWith("o1-mini")||b.startsWith("o1-preview")?{isReasoningModel:!0,systemMessageMode:"remove",requiredAutoTruncation:!1}:{isReasoningModel:!0,systemMessageMode:"developer",requiredAutoTruncation:!1}:{isReasoningModel:!1,systemMessageMode:"system",requiredAutoTruncation:!1},y=e.type;var b;null!=o&&g.push({type:"unsupported-setting",setting:"topK"}),null!=l&&g.push({type:"unsupported-setting",setting:"seed"}),null!=a&&g.push({type:"unsupported-setting",setting:"presencePenalty"}),null!=i&&g.push({type:"unsupported-setting",setting:"frequencyPenalty"}),null!=r&&g.push({type:"unsupported-setting",setting:"stopSequences"});const{messages:v,warnings:w}=function({prompt:e,systemMessageMode:t}){const n=[],r=[];for(const{role:s,content:o}of e)switch(s){case"system":switch(t){case"system":n.push({role:"system",content:o});break;case"developer":n.push({role:"developer",content:o});break;case"remove":r.push({type:"other",message:"system messages are removed for this model"});break;default:throw new Error(`Unsupported system message mode: ${t}`)}break;case"user":n.push({role:"user",content:o.map((e,t)=>{var n,r,s,o;switch(e.type){case"text":return{type:"input_text",text:e.text};case"image":return{type:"input_image",image_url:e.image instanceof URL?e.image.toString():`data:${null!=(n=e.mimeType)?n:"image/jpeg"};base64,${rt(e.image)}`,detail:null==(s=null==(r=e.providerMetadata)?void 0:r.openai)?void 0:s.imageDetail};case"file":if(e.data instanceof URL)throw new Ne({functionality:"File URLs in user messages"});if("application/pdf"===e.mimeType)return{type:"input_file",filename:null!=(o=e.filename)?o:`part-${t}.pdf`,file_data:`data:application/pdf;base64,${e.data}`};throw new Ne({functionality:"Only PDF files are supported in user messages"})}})});break;case"assistant":for(const e of o)switch(e.type){case"text":n.push({role:"assistant",content:[{type:"output_text",text:e.text}]});break;case"tool-call":n.push({type:"function_call",call_id:e.toolCallId,name:e.toolName,arguments:JSON.stringify(e.args)})}break;case"tool":for(const e of o)n.push({type:"function_call_output",call_id:e.toolCallId,output:JSON.stringify(e.result)});break;default:throw new Error(`Unsupported role: ${s}`)}return{messages:n,warnings:r}}({prompt:u,systemMessageMode:f.systemMessageMode});g.push(...w);const _=Ze({provider:"openai",providerOptions:c,schema:ms}),x=null==(p=null==_?void 0:_.strictSchemas)||p,k={model:this.modelId,input:v,temperature:n,top_p:s,max_output_tokens:t,..."json"===(null==d?void 0:d.type)&&{text:{format:null!=d.schema?{type:"json_schema",strict:x,name:null!=(h=d.name)?h:"response",description:d.description,schema:d.schema}:{type:"json_object"}}},metadata:null==_?void 0:_.metadata,parallel_tool_calls:null==_?void 0:_.parallelToolCalls,previous_response_id:null==_?void 0:_.previousResponseId,store:null==_?void 0:_.store,user:null==_?void 0:_.user,instructions:null==_?void 0:_.instructions,...f.isReasoningModel&&(null!=(null==_?void 0:_.reasoningEffort)||null!=(null==_?void 0:_.reasoningSummary))&&{reasoning:{...null!=(null==_?void 0:_.reasoningEffort)&&{effort:_.reasoningEffort},...null!=(null==_?void 0:_.reasoningSummary)&&{summary:_.reasoningSummary}}},...f.requiredAutoTruncation&&{truncation:"auto"}};switch(f.isReasoningModel&&(null!=k.temperature&&(k.temperature=void 0,g.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for reasoning models"})),null!=k.top_p&&(k.top_p=void 0,g.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported for reasoning models"}))),y){case"regular":{const{tools:t,tool_choice:n,toolWarnings:r}=function({mode:e,strict:t}){var n;const r=(null==(n=e.tools)?void 0:n.length)?e.tools:void 0,s=[];if(null==r)return{tools:void 0,tool_choice:void 0,toolWarnings:s};const o=e.toolChoice,a=[];for(const e of r)switch(e.type){case"function":a.push({type:"function",name:e.name,description:e.description,parameters:e.parameters,strict:!!t||void 0});break;case"provider-defined":"openai.web_search_preview"===e.id?a.push({type:"web_search_preview",search_context_size:e.args.searchContextSize,user_location:e.args.userLocation}):s.push({type:"unsupported-tool",tool:e});break;default:s.push({type:"unsupported-tool",tool:e})}if(null==o)return{tools:a,tool_choice:void 0,toolWarnings:s};const i=o.type;switch(i){case"auto":case"none":case"required":return{tools:a,tool_choice:i,toolWarnings:s};case"tool":return"web_search_preview"===o.toolName?{tools:a,tool_choice:{type:"web_search_preview"},toolWarnings:s}:{tools:a,tool_choice:{type:"function",name:o.toolName},toolWarnings:s};default:throw new Ne({functionality:`Unsupported tool choice type: ${i}`})}}({mode:e,strict:x});return{args:{...k,tools:t,tool_choice:n},warnings:[...g,...r]}}case"object-json":return{args:{...k,text:{format:null!=e.schema?{type:"json_schema",strict:x,name:null!=(m=e.name)?m:"response",description:e.description,schema:e.schema}:{type:"json_object"}}},warnings:g};case"object-tool":return{args:{...k,tool_choice:{type:"function",name:e.tool.name},tools:[{type:"function",name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters,strict:x}]},warnings:g};default:throw new Error(`Unsupported type: ${y}`)}}async doGenerate(e){var t,n,r,s,o,a,i;const{args:l,warnings:u}=this.getArgs(e),{responseHeaders:c,value:d,rawValue:p}=await Ve({url:this.config.url({path:"/responses",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:l,failedResponseHandler:jr,successfulResponseHandler:Qe(Sr.object({id:Sr.string(),created_at:Sr.number(),model:Sr.string(),output:Sr.array(Sr.discriminatedUnion("type",[Sr.object({type:Sr.literal("message"),role:Sr.literal("assistant"),content:Sr.array(Sr.object({type:Sr.literal("output_text"),text:Sr.string(),annotations:Sr.array(Sr.object({type:Sr.literal("url_citation"),start_index:Sr.number(),end_index:Sr.number(),url:Sr.string(),title:Sr.string()}))}))}),Sr.object({type:Sr.literal("function_call"),call_id:Sr.string(),name:Sr.string(),arguments:Sr.string()}),Sr.object({type:Sr.literal("web_search_call")}),Sr.object({type:Sr.literal("computer_call")}),Sr.object({type:Sr.literal("reasoning"),summary:Sr.array(Sr.object({type:Sr.literal("summary_text"),text:Sr.string()}))})])),incomplete_details:Sr.object({reason:Sr.string()}).nullable(),usage:ss})),abortSignal:e.abortSignal,fetch:this.config.fetch}),h=d.output.filter(e=>"message"===e.type).flatMap(e=>e.content).filter(e=>"output_text"===e.type),m=d.output.filter(e=>"function_call"===e.type).map(e=>({toolCallType:"function",toolCallId:e.call_id,toolName:e.name,args:e.arguments})),g=null!=(n=null==(t=d.output.find(e=>"reasoning"===e.type))?void 0:t.summary)?n:null;return{text:h.map(e=>e.text).join("\n"),sources:h.flatMap(e=>e.annotations.map(e=>{var t,n,r;return{sourceType:"url",id:null!=(r=null==(n=(t=this.config).generateId)?void 0:n.call(t))?r:Me(),url:e.url,title:e.title}})),finishReason:ns({finishReason:null==(r=d.incomplete_details)?void 0:r.reason,hasToolCalls:m.length>0}),toolCalls:m.length>0?m:void 0,reasoning:g?g.map(e=>({type:"text",text:e.text})):void 0,usage:{promptTokens:d.usage.input_tokens,completionTokens:d.usage.output_tokens},rawCall:{rawPrompt:void 0,rawSettings:{}},rawResponse:{headers:c,body:p},request:{body:JSON.stringify(l)},response:{id:d.id,timestamp:new Date(1e3*d.created_at),modelId:d.model},providerMetadata:{openai:{responseId:d.id,cachedPromptTokens:null!=(o=null==(s=d.usage.input_tokens_details)?void 0:s.cached_tokens)?o:null,reasoningTokens:null!=(i=null==(a=d.usage.output_tokens_details)?void 0:a.reasoning_tokens)?i:null}},warnings:u}}async doStream(e){const{args:t,warnings:n}=this.getArgs(e),{responseHeaders:r,value:s}=await Ve({url:this.config.url({path:"/responses",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:{...t,stream:!0},failedResponseHandler:jr,successfulResponseHandler:Ye(hs),abortSignal:e.abortSignal,fetch:this.config.fetch}),o=this;let a="unknown",i=NaN,l=NaN,u=null,c=null,d=null;const p={};let h=!1;return{stream:s.pipeThrough(new TransformStream({transform(e,t){var n,r,s,m,g,f,y,b;if(!e.success)return a="error",void t.enqueue({type:"error",error:e.error});const v=e.value;if(function(e){return"response.output_item.added"===e.type}(v))"function_call"===v.item.type&&(p[v.output_index]={toolName:v.item.name,toolCallId:v.item.call_id},t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:v.item.call_id,toolName:v.item.name,argsTextDelta:v.item.arguments}));else if(function(e){return"response.function_call_arguments.delta"===e.type}(v)){const e=p[v.output_index];null!=e&&t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,argsTextDelta:v.delta})}else!function(e){return"response.created"===e.type}(v)?function(e){return"response.output_text.delta"===e.type}(v)?t.enqueue({type:"text-delta",textDelta:v.delta}):function(e){return"response.reasoning_summary_text.delta"===e.type}(v)?t.enqueue({type:"reasoning",textDelta:v.delta}):function(e){return"response.output_item.done"===e.type}(v)&&"function_call"===v.item.type?(p[v.output_index]=void 0,h=!0,t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:v.item.call_id,toolName:v.item.name,args:v.item.arguments})):function(e){return"response.completed"===e.type||"response.incomplete"===e.type}(v)?(a=ns({finishReason:null==(n=v.response.incomplete_details)?void 0:n.reason,hasToolCalls:h}),i=v.response.usage.input_tokens,l=v.response.usage.output_tokens,u=null!=(s=null==(r=v.response.usage.input_tokens_details)?void 0:r.cached_tokens)?s:u,c=null!=(g=null==(m=v.response.usage.output_tokens_details)?void 0:m.reasoning_tokens)?g:c):function(e){return"response.output_text.annotation.added"===e.type}(v)&&t.enqueue({type:"source",source:{sourceType:"url",id:null!=(b=null==(y=(f=o.config).generateId)?void 0:y.call(f))?b:Me(),url:v.annotation.url,title:v.annotation.title}}):(d=v.response.id,t.enqueue({type:"response-metadata",id:v.response.id,timestamp:new Date(1e3*v.response.created_at),modelId:v.response.model}))},flush(e){e.enqueue({type:"finish",finishReason:a,usage:{promptTokens:i,completionTokens:l},...(null!=u||null!=c)&&{providerMetadata:{openai:{responseId:d,cachedPromptTokens:u,reasoningTokens:c}}}})}})),rawCall:{rawPrompt:void 0,rawSettings:{}},rawResponse:{headers:r},request:{body:JSON.stringify(t)},warnings:n}}},ss=Sr.object({input_tokens:Sr.number(),input_tokens_details:Sr.object({cached_tokens:Sr.number().nullish()}).nullish(),output_tokens:Sr.number(),output_tokens_details:Sr.object({reasoning_tokens:Sr.number().nullish()}).nullish()}),os=Sr.object({type:Sr.literal("response.output_text.delta"),delta:Sr.string()}),as=Sr.object({type:Sr.enum(["response.completed","response.incomplete"]),response:Sr.object({incomplete_details:Sr.object({reason:Sr.string()}).nullish(),usage:ss})}),is=Sr.object({type:Sr.literal("response.created"),response:Sr.object({id:Sr.string(),created_at:Sr.number(),model:Sr.string()})}),ls=Sr.object({type:Sr.literal("response.output_item.done"),output_index:Sr.number(),item:Sr.discriminatedUnion("type",[Sr.object({type:Sr.literal("message")}),Sr.object({type:Sr.literal("function_call"),id:Sr.string(),call_id:Sr.string(),name:Sr.string(),arguments:Sr.string(),status:Sr.literal("completed")})])}),us=Sr.object({type:Sr.literal("response.function_call_arguments.delta"),item_id:Sr.string(),output_index:Sr.number(),delta:Sr.string()}),cs=Sr.object({type:Sr.literal("response.output_item.added"),output_index:Sr.number(),item:Sr.discriminatedUnion("type",[Sr.object({type:Sr.literal("message")}),Sr.object({type:Sr.literal("function_call"),id:Sr.string(),call_id:Sr.string(),name:Sr.string(),arguments:Sr.string()})])}),ds=Sr.object({type:Sr.literal("response.output_text.annotation.added"),annotation:Sr.object({type:Sr.literal("url_citation"),url:Sr.string(),title:Sr.string()})}),ps=Sr.object({type:Sr.literal("response.reasoning_summary_text.delta"),item_id:Sr.string(),output_index:Sr.number(),summary_index:Sr.number(),delta:Sr.string()}),hs=Sr.union([os,as,is,ls,us,cs,ds,ps,Sr.object({type:Sr.string()}).passthrough()]),ms=Sr.object({metadata:Sr.any().nullish(),parallelToolCalls:Sr.boolean().nullish(),previousResponseId:Sr.string().nullish(),store:Sr.boolean().nullish(),user:Sr.string().nullish(),reasoningEffort:Sr.string().nullish(),strictSchemas:Sr.boolean().nullish(),instructions:Sr.string().nullish(),reasoningSummary:Sr.string().nullish()}),gs=Sr.object({}),fs={webSearchPreview:function({searchContextSize:e,userLocation:t}={}){return{type:"provider-defined",id:"openai.web_search_preview",args:{searchContextSize:e,userLocation:t},parameters:gs}}},ys=Sr.object({instructions:Sr.string().nullish(),speed:Sr.number().min(.25).max(4).default(1).nullish()}),bs=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v1"}get provider(){return this.config.provider}getArgs({text:e,voice:t="alloy",outputFormat:n="mp3",speed:r,instructions:s,providerOptions:o}){const a=[],i=Ze({provider:"openai",providerOptions:o,schema:ys}),l={model:this.modelId,input:e,voice:t,response_format:"mp3",speed:r,instructions:s};if(n&&(["mp3","opus","aac","flac","wav","pcm"].includes(n)?l.response_format=n:a.push({type:"unsupported-setting",setting:"outputFormat",details:`Unsupported output format: ${n}. Using mp3 instead.`})),i){const e={};for(const t in e){const n=e[t];void 0!==n&&(l[t]=n)}}return{requestBody:l,warnings:a}}async doGenerate(e){var t,n,r;const s=null!=(r=null==(n=null==(t=this.config._internal)?void 0:t.currentDate)?void 0:n.call(t))?r:new Date,{requestBody:o,warnings:a}=this.getArgs(e),{value:i,responseHeaders:l,rawValue:u}=await Ve({url:this.config.url({path:"/audio/speech",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:o,failedResponseHandler:jr,successfulResponseHandler:async({response:e,url:t,requestBodyValues:n})=>{const r=Oe(e);if(!e.body)throw new k({message:"Response body is empty",url:t,requestBodyValues:n,statusCode:e.status,responseHeaders:r,responseBody:void 0});try{const t=await e.arrayBuffer();return{responseHeaders:r,value:new Uint8Array(t)}}catch(s){throw new k({message:"Failed to read response as array buffer",url:t,requestBodyValues:n,statusCode:e.status,responseHeaders:r,responseBody:void 0,cause:s})}},abortSignal:e.abortSignal,fetch:this.config.fetch});return{audio:i,warnings:a,request:{body:JSON.stringify(o)},response:{timestamp:s,modelId:this.modelId,headers:l,body:u}}}};function vs(e={}){var t,n,r;const s=null!=(t=st(e.baseURL))?t:"https://api.openai.com/v1",o=null!=(n=e.compatibility)?n:"compatible",a=null!=(r=e.name)?r:"openai",i=()=>({Authorization:`Bearer ${$e({apiKey:e.apiKey,environmentVariableName:"OPENAI_API_KEY",description:"OpenAI"})}`,"OpenAI-Organization":e.organization,"OpenAI-Project":e.project,...e.headers}),l=(t,n={})=>new Pr(t,n,{provider:`${a}.chat`,url:({path:e})=>`${s}${e}`,headers:i,compatibility:o,fetch:e.fetch}),u=(t,n={})=>new Hr(t,n,{provider:`${a}.completion`,url:({path:e})=>`${s}${e}`,headers:i,compatibility:o,fetch:e.fetch}),c=(t,n={})=>new Vr(t,n,{provider:`${a}.embedding`,url:({path:e})=>`${s}${e}`,headers:i,fetch:e.fetch}),d=(t,n={})=>new Jr(t,n,{provider:`${a}.image`,url:({path:e})=>`${s}${e}`,headers:i,fetch:e.fetch}),p=t=>new es(t,{provider:`${a}.transcription`,url:({path:e})=>`${s}${e}`,headers:i,fetch:e.fetch}),h=t=>new bs(t,{provider:`${a}.speech`,url:({path:e})=>`${s}${e}`,headers:i,fetch:e.fetch}),m=(e,t)=>{if(new.target)throw new Error("The OpenAI model function cannot be called with the new keyword.");return"gpt-3.5-turbo-instruct"===e?u(e,t):l(e,t)},g=function(e,t){return m(e,t)};return g.languageModel=m,g.chat=l,g.completion=u,g.responses=t=>new rs(t,{provider:`${a}.responses`,url:({path:e})=>`${s}${e}`,headers:i,fetch:e.fetch}),g.embedding=c,g.textEmbedding=c,g.textEmbeddingModel=c,g.image=d,g.imageModel=d,g.transcription=p,g.transcriptionModel=p,g.speech=h,g.speechModel=h,g.tools=fs,g}vs({compatibility:"strict"});var ws=Sr.object({type:Sr.literal("error"),error:Sr.object({type:Sr.string(),message:Sr.string()})}),_s=Xe({errorSchema:ws,errorToMessage:e=>e.error.message});function xs(e){switch(e){case"end_turn":case"stop_sequence":return"stop";case"tool_use":return"tool-calls";case"max_tokens":return"length";default:return"unknown"}}var ks=class{constructor(e,t,n){this.specificationVersion="v1",this.defaultObjectGenerationMode="tool",this.modelId=e,this.settings=t,this.config=n}supportsUrl(e){return"https:"===e.protocol}get provider(){return this.config.provider}get supportsImageUrls(){return this.config.supportsImageUrls}async getArgs({mode:e,prompt:t,maxTokens:n=4096,temperature:r,topP:s,topK:o,frequencyPenalty:a,presencePenalty:i,stopSequences:l,responseFormat:u,seed:c,providerMetadata:d}){var p,h,m;const g=e.type,f=[];null!=a&&f.push({type:"unsupported-setting",setting:"frequencyPenalty"}),null!=i&&f.push({type:"unsupported-setting",setting:"presencePenalty"}),null!=c&&f.push({type:"unsupported-setting",setting:"seed"}),null!=u&&"text"!==u.type&&f.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});const{prompt:y,betas:b}=function({prompt:e,sendReasoning:t,warnings:n}){var r,s,o,a;const i=new Set,l=function(e){const t=[];let n;for(const r of e){const{role:e}=r;switch(e){case"system":"system"!==(null==n?void 0:n.type)&&(n={type:"system",messages:[]},t.push(n)),n.messages.push(r);break;case"assistant":"assistant"!==(null==n?void 0:n.type)&&(n={type:"assistant",messages:[]},t.push(n)),n.messages.push(r);break;case"user":case"tool":"user"!==(null==n?void 0:n.type)&&(n={type:"user",messages:[]},t.push(n)),n.messages.push(r);break;default:throw new Error(`Unsupported role: ${e}`)}}return t}(e);let u;const c=[];function d(e){var t;const n=null==e?void 0:e.anthropic;return null!=(t=null==n?void 0:n.cacheControl)?t:null==n?void 0:n.cache_control}for(let e=0;e<l.length;e++){const p=l[e],h=e===l.length-1,m=p.type;switch(m){case"system":if(null!=u)throw new Ne({functionality:"Multiple system messages that are separated by user/assistant messages"});u=p.messages.map(({content:e,providerMetadata:t})=>({type:"text",text:e,cache_control:d(t)}));break;case"user":{const e=[];for(const t of p.messages){const{role:n,content:a}=t;switch(n){case"user":for(let n=0;n<a.length;n++){const o=a[n],l=n===a.length-1,u=null!=(r=d(o.providerMetadata))?r:l?d(t.providerMetadata):void 0;switch(o.type){case"text":e.push({type:"text",text:o.text,cache_control:u});break;case"image":e.push({type:"image",source:o.image instanceof URL?{type:"url",url:o.image.toString()}:{type:"base64",media_type:null!=(s=o.mimeType)?s:"image/jpeg",data:rt(o.image)},cache_control:u});break;case"file":if("application/pdf"!==o.mimeType)throw new Ne({functionality:"Non-PDF files in user messages"});i.add("pdfs-2024-09-25"),e.push({type:"document",source:o.data instanceof URL?{type:"url",url:o.data.toString()}:{type:"base64",media_type:"application/pdf",data:o.data},cache_control:u})}}break;case"tool":for(let n=0;n<a.length;n++){const r=a[n],s=n===a.length-1,i=null!=(o=d(r.providerMetadata))?o:s?d(t.providerMetadata):void 0,l=null!=r.content?r.content.map(e=>{var t;switch(e.type){case"text":return{type:"text",text:e.text,cache_control:void 0};case"image":return{type:"image",source:{type:"base64",media_type:null!=(t=e.mimeType)?t:"image/jpeg",data:e.data},cache_control:void 0}}}):JSON.stringify(r.result);e.push({type:"tool_result",tool_use_id:r.toolCallId,content:l,is_error:r.isError,cache_control:i})}break;default:throw new Error(`Unsupported role: ${n}`)}}c.push({role:"user",content:e});break}case"assistant":{const e=[];for(let r=0;r<p.messages.length;r++){const s=p.messages[r],o=r===p.messages.length-1,{content:i}=s;for(let r=0;r<i.length;r++){const l=i[r],u=r===i.length-1,c=null!=(a=d(l.providerMetadata))?a:u?d(s.providerMetadata):void 0;switch(l.type){case"text":e.push({type:"text",text:h&&o&&u?l.text.trim():l.text,cache_control:c});break;case"reasoning":t?e.push({type:"thinking",thinking:l.text,signature:l.signature,cache_control:c}):n.push({type:"other",message:"sending reasoning content is disabled for this model"});break;case"redacted-reasoning":e.push({type:"redacted_thinking",data:l.data,cache_control:c});break;case"tool-call":e.push({type:"tool_use",id:l.toolCallId,name:l.toolName,input:l.args,cache_control:c})}}}c.push({role:"assistant",content:e});break}default:throw new Error(`Unsupported type: ${m}`)}}return{prompt:{system:u,messages:c},betas:i}}({prompt:t,sendReasoning:null==(p=this.settings.sendReasoning)||p,warnings:f}),v=Ze({provider:"anthropic",providerOptions:d,schema:Is}),w="enabled"===(null==(h=null==v?void 0:v.thinking)?void 0:h.type),_=null==(m=null==v?void 0:v.thinking)?void 0:m.budgetTokens,x={model:this.modelId,max_tokens:n,temperature:r,top_k:o,top_p:s,stop_sequences:l,...w&&{thinking:{type:"enabled",budget_tokens:_}},system:y.system,messages:y.messages};if(w){if(null==_)throw new Ne({functionality:"thinking requires a budget"});null!=x.temperature&&(x.temperature=void 0,f.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported when thinking is enabled"})),null!=o&&(x.top_k=void 0,f.push({type:"unsupported-setting",setting:"topK",details:"topK is not supported when thinking is enabled"})),null!=s&&(x.top_p=void 0,f.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported when thinking is enabled"})),x.max_tokens=n+_}switch(g){case"regular":{const{tools:t,tool_choice:n,toolWarnings:r,betas:s}=function(e){var t;const n=(null==(t=e.tools)?void 0:t.length)?e.tools:void 0,r=[],s=new Set;if(null==n)return{tools:void 0,tool_choice:void 0,toolWarnings:r,betas:s};const o=[];for(const e of n)switch(e.type){case"function":o.push({name:e.name,description:e.description,input_schema:e.parameters});break;case"provider-defined":switch(e.id){case"anthropic.computer_20250124":s.add("computer-use-2025-01-24"),o.push({name:e.name,type:"computer_20250124",display_width_px:e.args.displayWidthPx,display_height_px:e.args.displayHeightPx,display_number:e.args.displayNumber});break;case"anthropic.computer_20241022":s.add("computer-use-2024-10-22"),o.push({name:e.name,type:"computer_20241022",display_width_px:e.args.displayWidthPx,display_height_px:e.args.displayHeightPx,display_number:e.args.displayNumber});break;case"anthropic.text_editor_20250124":s.add("computer-use-2025-01-24"),o.push({name:e.name,type:"text_editor_20250124"});break;case"anthropic.text_editor_20241022":s.add("computer-use-2024-10-22"),o.push({name:e.name,type:"text_editor_20241022"});break;case"anthropic.bash_20250124":s.add("computer-use-2025-01-24"),o.push({name:e.name,type:"bash_20250124"});break;case"anthropic.bash_20241022":s.add("computer-use-2024-10-22"),o.push({name:e.name,type:"bash_20241022"});break;default:r.push({type:"unsupported-tool",tool:e})}break;default:r.push({type:"unsupported-tool",tool:e})}const a=e.toolChoice;if(null==a)return{tools:o,tool_choice:void 0,toolWarnings:r,betas:s};const i=a.type;switch(i){case"auto":return{tools:o,tool_choice:{type:"auto"},toolWarnings:r,betas:s};case"required":return{tools:o,tool_choice:{type:"any"},toolWarnings:r,betas:s};case"none":return{tools:void 0,tool_choice:void 0,toolWarnings:r,betas:s};case"tool":return{tools:o,tool_choice:{type:"tool",name:a.toolName},toolWarnings:r,betas:s};default:throw new Ne({functionality:`Unsupported tool choice type: ${i}`})}}(e);return{args:{...x,tools:t,tool_choice:n},warnings:[...f,...r],betas:new Set([...b,...s])}}case"object-json":throw new Ne({functionality:"json-mode object generation"});case"object-tool":{const{name:t,description:n,parameters:r}=e.tool;return{args:{...x,tools:[{name:t,description:n,input_schema:r}],tool_choice:{type:"tool",name:t}},warnings:f,betas:b}}default:throw new Error(`Unsupported type: ${g}`)}}async getHeaders({betas:e,headers:t}){return Ae(await Ge(this.config.headers),e.size>0?{"anthropic-beta":Array.from(e).join(",")}:{},t)}buildRequestUrl(e){var t,n,r;return null!=(r=null==(n=(t=this.config).buildRequestUrl)?void 0:n.call(t,this.config.baseURL,e))?r:`${this.config.baseURL}/messages`}transformRequestBody(e){var t,n,r;return null!=(r=null==(n=(t=this.config).transformRequestBody)?void 0:n.call(t,e))?r:e}async doGenerate(e){var t,n,r,s;const{args:o,warnings:a,betas:i}=await this.getArgs(e),{responseHeaders:l,value:u,rawValue:c}=await Ve({url:this.buildRequestUrl(!1),headers:await this.getHeaders({betas:i,headers:e.headers}),body:this.transformRequestBody(o),failedResponseHandler:_s,successfulResponseHandler:Qe(Ts),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:d,...p}=o;let h,m="";for(const e of u.content)"text"===e.type&&(m+=e.text);if(u.content.some(e=>"tool_use"===e.type)){h=[];for(const e of u.content)"tool_use"===e.type&&h.push({toolCallType:"function",toolCallId:e.id,toolName:e.name,args:JSON.stringify(e.input)})}const g=u.content.filter(e=>"redacted_thinking"===e.type||"thinking"===e.type).map(e=>"thinking"===e.type?{type:"text",text:e.thinking,signature:e.signature}:{type:"redacted",data:e.data});return{text:m,reasoning:g.length>0?g:void 0,toolCalls:h,finishReason:xs(u.stop_reason),usage:{promptTokens:u.usage.input_tokens,completionTokens:u.usage.output_tokens},rawCall:{rawPrompt:d,rawSettings:p},rawResponse:{headers:l,body:c},response:{id:null!=(t=u.id)?t:void 0,modelId:null!=(n=u.model)?n:void 0},warnings:a,providerMetadata:{anthropic:{cacheCreationInputTokens:null!=(r=u.usage.cache_creation_input_tokens)?r:null,cacheReadInputTokens:null!=(s=u.usage.cache_read_input_tokens)?s:null}},request:{body:JSON.stringify(o)}}}async doStream(e){const{args:t,warnings:n,betas:r}=await this.getArgs(e),s={...t,stream:!0},{responseHeaders:o,value:a}=await Ve({url:this.buildRequestUrl(!0),headers:await this.getHeaders({betas:r,headers:e.headers}),body:this.transformRequestBody(s),failedResponseHandler:_s,successfulResponseHandler:Ye(Ns),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:i,...l}=t;let u="unknown";const c={promptTokens:Number.NaN,completionTokens:Number.NaN},d={};let p,h;return{stream:a.pipeThrough(new TransformStream({transform(e,t){var n,r,s,o;if(!e.success)return void t.enqueue({type:"error",error:e.error});const a=e.value;switch(a.type){case"ping":return;case"content_block_start":{const e=a.content_block.type;switch(h=e,e){case"text":case"thinking":return;case"redacted_thinking":return void t.enqueue({type:"redacted-reasoning",data:a.content_block.data});case"tool_use":return void(d[a.index]={toolCallId:a.content_block.id,toolName:a.content_block.name,jsonText:""});default:throw new Error(`Unsupported content block type: ${e}`)}}case"content_block_stop":if(null!=d[a.index]){const e=d[a.index];t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,args:e.jsonText}),delete d[a.index]}return void(h=void 0);case"content_block_delta":{const e=a.delta.type;switch(e){case"text_delta":return void t.enqueue({type:"text-delta",textDelta:a.delta.text});case"thinking_delta":return void t.enqueue({type:"reasoning",textDelta:a.delta.thinking});case"signature_delta":return void("thinking"===h&&t.enqueue({type:"reasoning-signature",signature:a.delta.signature}));case"input_json_delta":{const e=d[a.index];return t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,argsTextDelta:a.delta.partial_json}),void(e.jsonText+=a.delta.partial_json)}default:throw new Error(`Unsupported delta type: ${e}`)}}case"message_start":return c.promptTokens=a.message.usage.input_tokens,c.completionTokens=a.message.usage.output_tokens,p={anthropic:{cacheCreationInputTokens:null!=(n=a.message.usage.cache_creation_input_tokens)?n:null,cacheReadInputTokens:null!=(r=a.message.usage.cache_read_input_tokens)?r:null}},void t.enqueue({type:"response-metadata",id:null!=(s=a.message.id)?s:void 0,modelId:null!=(o=a.message.model)?o:void 0});case"message_delta":return c.completionTokens=a.usage.output_tokens,void(u=xs(a.delta.stop_reason));case"message_stop":return void t.enqueue({type:"finish",finishReason:u,usage:c,providerMetadata:p});case"error":return void t.enqueue({type:"error",error:a.error});default:throw new Error(`Unsupported chunk type: ${a}`)}}})),rawCall:{rawPrompt:i,rawSettings:l},rawResponse:{headers:o},warnings:n,request:{body:JSON.stringify(s)}}}},Ts=Sr.object({type:Sr.literal("message"),id:Sr.string().nullish(),model:Sr.string().nullish(),content:Sr.array(Sr.discriminatedUnion("type",[Sr.object({type:Sr.literal("text"),text:Sr.string()}),Sr.object({type:Sr.literal("thinking"),thinking:Sr.string(),signature:Sr.string()}),Sr.object({type:Sr.literal("redacted_thinking"),data:Sr.string()}),Sr.object({type:Sr.literal("tool_use"),id:Sr.string(),name:Sr.string(),input:Sr.unknown()})])),stop_reason:Sr.string().nullish(),usage:Sr.object({input_tokens:Sr.number(),output_tokens:Sr.number(),cache_creation_input_tokens:Sr.number().nullish(),cache_read_input_tokens:Sr.number().nullish()})}),Ns=Sr.discriminatedUnion("type",[Sr.object({type:Sr.literal("message_start"),message:Sr.object({id:Sr.string().nullish(),model:Sr.string().nullish(),usage:Sr.object({input_tokens:Sr.number(),output_tokens:Sr.number(),cache_creation_input_tokens:Sr.number().nullish(),cache_read_input_tokens:Sr.number().nullish()})})}),Sr.object({type:Sr.literal("content_block_start"),index:Sr.number(),content_block:Sr.discriminatedUnion("type",[Sr.object({type:Sr.literal("text"),text:Sr.string()}),Sr.object({type:Sr.literal("thinking"),thinking:Sr.string()}),Sr.object({type:Sr.literal("tool_use"),id:Sr.string(),name:Sr.string()}),Sr.object({type:Sr.literal("redacted_thinking"),data:Sr.string()})])}),Sr.object({type:Sr.literal("content_block_delta"),index:Sr.number(),delta:Sr.discriminatedUnion("type",[Sr.object({type:Sr.literal("input_json_delta"),partial_json:Sr.string()}),Sr.object({type:Sr.literal("text_delta"),text:Sr.string()}),Sr.object({type:Sr.literal("thinking_delta"),thinking:Sr.string()}),Sr.object({type:Sr.literal("signature_delta"),signature:Sr.string()})])}),Sr.object({type:Sr.literal("content_block_stop"),index:Sr.number()}),Sr.object({type:Sr.literal("error"),error:Sr.object({type:Sr.string(),message:Sr.string()})}),Sr.object({type:Sr.literal("message_delta"),delta:Sr.object({stop_reason:Sr.string().nullish()}),usage:Sr.object({output_tokens:Sr.number()})}),Sr.object({type:Sr.literal("message_stop")}),Sr.object({type:Sr.literal("ping")})]),Is=Sr.object({thinking:Sr.object({type:Sr.union([Sr.literal("enabled"),Sr.literal("disabled")]),budgetTokens:Sr.number().optional()}).optional()}),Es=Sr.object({command:Sr.string(),restart:Sr.boolean().optional()}),Cs=Sr.object({command:Sr.string(),restart:Sr.boolean().optional()}),Ss=Sr.object({command:Sr.enum(["view","create","str_replace","insert","undo_edit"]),path:Sr.string(),file_text:Sr.string().optional(),insert_line:Sr.number().int().optional(),new_str:Sr.string().optional(),old_str:Sr.string().optional(),view_range:Sr.array(Sr.number().int()).optional()}),As=Sr.object({command:Sr.enum(["view","create","str_replace","insert","undo_edit"]),path:Sr.string(),file_text:Sr.string().optional(),insert_line:Sr.number().int().optional(),new_str:Sr.string().optional(),old_str:Sr.string().optional(),view_range:Sr.array(Sr.number().int()).optional()}),Rs=Sr.object({action:Sr.enum(["key","type","mouse_move","left_click","left_click_drag","right_click","middle_click","double_click","screenshot","cursor_position"]),coordinate:Sr.array(Sr.number().int()).optional(),text:Sr.string().optional()}),Os=Sr.object({action:Sr.enum(["key","hold_key","type","cursor_position","mouse_move","left_mouse_down","left_mouse_up","left_click","left_click_drag","right_click","middle_click","double_click","triple_click","scroll","wait","screenshot"]),coordinate:Sr.tuple([Sr.number().int(),Sr.number().int()]).optional(),duration:Sr.number().optional(),scroll_amount:Sr.number().optional(),scroll_direction:Sr.enum(["up","down","left","right"]).optional(),start_coordinate:Sr.tuple([Sr.number().int(),Sr.number().int()]).optional(),text:Sr.string().optional()}),js={bash_20241022:function(e={}){return{type:"provider-defined",id:"anthropic.bash_20241022",args:{},parameters:Es,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}},bash_20250124:function(e={}){return{type:"provider-defined",id:"anthropic.bash_20250124",args:{},parameters:Cs,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}},textEditor_20241022:function(e={}){return{type:"provider-defined",id:"anthropic.text_editor_20241022",args:{},parameters:Ss,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}},textEditor_20250124:function(e={}){return{type:"provider-defined",id:"anthropic.text_editor_20250124",args:{},parameters:As,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}},computer_20241022:function(e){return{type:"provider-defined",id:"anthropic.computer_20241022",args:{displayWidthPx:e.displayWidthPx,displayHeightPx:e.displayHeightPx,displayNumber:e.displayNumber},parameters:Rs,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}},computer_20250124:function(e){return{type:"provider-defined",id:"anthropic.computer_20250124",args:{displayWidthPx:e.displayWidthPx,displayHeightPx:e.displayHeightPx,displayNumber:e.displayNumber},parameters:Os,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}}};function Ms(e={}){var t;const n=null!=(t=st(e.baseURL))?t:"https://api.anthropic.com/v1",r=()=>({"anthropic-version":"2023-06-01","x-api-key":$e({apiKey:e.apiKey,environmentVariableName:"ANTHROPIC_API_KEY",description:"Anthropic"}),...e.headers}),s=(t,s={})=>new ks(t,s,{provider:"anthropic.messages",baseURL:n,headers:r,fetch:e.fetch,supportsImageUrls:!0}),o=function(e,t){if(new.target)throw new Error("The Anthropic model function cannot be called with the new keyword.");return s(e,t)};return o.languageModel=s,o.chat=s,o.messages=s,o.textEmbeddingModel=e=>{throw new ce({modelId:e,modelType:"textEmbeddingModel"})},o.tools=js,o}function Ps(e){if(function(e){return null!=e&&"object"==typeof e&&"object"===e.type&&(null==e.properties||0===Object.keys(e.properties).length)}(e))return;if("boolean"==typeof e)return{type:"boolean",properties:{}};const{type:t,description:n,required:r,properties:s,items:o,allOf:a,anyOf:i,oneOf:l,format:u,const:c,minLength:d,enum:p}=e,h={};if(n&&(h.description=n),r&&(h.required=r),u&&(h.format=u),void 0!==c&&(h.enum=[c]),t&&(Array.isArray(t)?t.includes("null")?(h.type=t.filter(e=>"null"!==e)[0],h.nullable=!0):h.type=t:h.type="null"===t?"null":t),void 0!==p&&(h.enum=p),null!=s&&(h.properties=Object.entries(s).reduce((e,[t,n])=>(e[t]=Ps(n),e),{})),o&&(h.items=Array.isArray(o)?o.map(Ps):Ps(o)),a&&(h.allOf=a.map(Ps)),i)if(i.some(e=>"object"==typeof e&&"null"===(null==e?void 0:e.type))){const e=i.filter(e=>!("object"==typeof e&&"null"===(null==e?void 0:e.type)));if(1===e.length){const t=Ps(e[0]);"object"==typeof t&&(h.nullable=!0,Object.assign(h,t))}else h.anyOf=e.map(Ps),h.nullable=!0}else h.anyOf=i.map(Ps);return l&&(h.oneOf=l.map(Ps)),void 0!==d&&(h.minLength=d),h}function Ds(e){return e.includes("/")?e:`models/${e}`}Ms();var $s=Sr.object({error:Sr.object({code:Sr.number().nullable(),message:Sr.string(),status:Sr.string()})}),Us=Xe({errorSchema:$s,errorToMessage:e=>e.error.message});function qs({finishReason:e,hasToolCalls:t}){switch(e){case"STOP":return t?"tool-calls":"stop";case"MAX_TOKENS":return"length";case"IMAGE_SAFETY":case"RECITATION":case"SAFETY":case"BLOCKLIST":case"PROHIBITED_CONTENT":case"SPII":return"content-filter";case"FINISH_REASON_UNSPECIFIED":case"OTHER":return"other";case"MALFORMED_FUNCTION_CALL":return"error";default:return"unknown"}}var Ls=class{constructor(e,t,n){this.specificationVersion="v1",this.defaultObjectGenerationMode="json",this.supportsImageUrls=!1,this.modelId=e,this.settings=t,this.config=n}get supportsStructuredOutputs(){var e;return null==(e=this.settings.structuredOutputs)||e}get provider(){return this.config.provider}async getArgs({mode:e,prompt:t,maxTokens:n,temperature:r,topP:s,topK:o,frequencyPenalty:a,presencePenalty:i,stopSequences:l,responseFormat:u,seed:c,providerMetadata:d}){var p,h,m;const g=e.type,f=[],y=Ze({provider:"google",providerOptions:d,schema:Ys});!0!==(null==(p=null==y?void 0:y.thinkingConfig)?void 0:p.includeThoughts)||this.config.provider.startsWith("google.vertex.")||f.push({type:"other",message:`The 'includeThoughts' option is only supported with the Google Vertex provider and might not be supported or could behave unexpectedly with the current Google provider (${this.config.provider}).`});const b={maxOutputTokens:n,temperature:r,topK:o,topP:s,frequencyPenalty:a,presencePenalty:i,stopSequences:l,seed:c,responseMimeType:"json"===(null==u?void 0:u.type)?"application/json":void 0,responseSchema:"json"===(null==u?void 0:u.type)&&null!=u.schema&&this.supportsStructuredOutputs?Ps(u.schema):void 0,...this.settings.audioTimestamp&&{audioTimestamp:this.settings.audioTimestamp},responseModalities:null==y?void 0:y.responseModalities,thinkingConfig:null==y?void 0:y.thinkingConfig},{contents:v,systemInstruction:w}=function(e){var t,n;const r=[],s=[];let o=!0;for(const{role:a,content:i}of e)switch(a){case"system":if(!o)throw new Ne({functionality:"system messages are only supported at the beginning of the conversation"});r.push({text:i});break;case"user":{o=!1;const e=[];for(const r of i)switch(r.type){case"text":e.push({text:r.text});break;case"image":e.push(r.image instanceof URL?{fileData:{mimeType:null!=(t=r.mimeType)?t:"image/jpeg",fileUri:r.image.toString()}}:{inlineData:{mimeType:null!=(n=r.mimeType)?n:"image/jpeg",data:rt(r.image)}});break;case"file":e.push(r.data instanceof URL?{fileData:{mimeType:r.mimeType,fileUri:r.data.toString()}}:{inlineData:{mimeType:r.mimeType,data:r.data}})}s.push({role:"user",parts:e});break}case"assistant":o=!1,s.push({role:"model",parts:i.map(e=>{switch(e.type){case"text":return 0===e.text.length?void 0:{text:e.text};case"file":if("image/png"!==e.mimeType)throw new Ne({functionality:"Only PNG images are supported in assistant messages"});if(e.data instanceof URL)throw new Ne({functionality:"File data URLs in assistant messages are not supported"});return{inlineData:{mimeType:e.mimeType,data:e.data}};case"tool-call":return{functionCall:{name:e.toolName,args:e.args}}}}).filter(e=>void 0!==e)});break;case"tool":o=!1,s.push({role:"user",parts:i.map(e=>({functionResponse:{name:e.toolName,response:{name:e.toolName,content:e.result}}}))})}return{systemInstruction:r.length>0?{parts:r}:void 0,contents:s}}(t);switch(g){case"regular":{const{tools:t,toolConfig:n,toolWarnings:r}=function(e,t,n,r){var s,o;const a=(null==(s=e.tools)?void 0:s.length)?e.tools:void 0,i=[],l=r.includes("gemini-2"),u=r.includes("gemini-1.5-flash")&&!r.includes("-8b");if(t)return{tools:l?{googleSearch:{}}:{googleSearchRetrieval:u&&n?{dynamicRetrievalConfig:n}:{}},toolConfig:void 0,toolWarnings:i};if(null==a)return{tools:void 0,toolConfig:void 0,toolWarnings:i};const c=[];for(const e of a)"provider-defined"===e.type?i.push({type:"unsupported-tool",tool:e}):c.push({name:e.name,description:null!=(o=e.description)?o:"",parameters:Ps(e.parameters)});const d=e.toolChoice;if(null==d)return{tools:{functionDeclarations:c},toolConfig:void 0,toolWarnings:i};const p=d.type;switch(p){case"auto":return{tools:{functionDeclarations:c},toolConfig:{functionCallingConfig:{mode:"AUTO"}},toolWarnings:i};case"none":return{tools:{functionDeclarations:c},toolConfig:{functionCallingConfig:{mode:"NONE"}},toolWarnings:i};case"required":return{tools:{functionDeclarations:c},toolConfig:{functionCallingConfig:{mode:"ANY"}},toolWarnings:i};case"tool":return{tools:{functionDeclarations:c},toolConfig:{functionCallingConfig:{mode:"ANY",allowedFunctionNames:[d.toolName]}},toolWarnings:i};default:throw new Ne({functionality:`Unsupported tool choice type: ${p}`})}}(e,null!=(h=this.settings.useSearchGrounding)&&h,this.settings.dynamicRetrievalConfig,this.modelId);return{args:{generationConfig:b,contents:v,systemInstruction:w,safetySettings:this.settings.safetySettings,tools:t,toolConfig:n,cachedContent:this.settings.cachedContent},warnings:[...f,...r]}}case"object-json":return{args:{generationConfig:{...b,responseMimeType:"application/json",responseSchema:null!=e.schema&&this.supportsStructuredOutputs?Ps(e.schema):void 0},contents:v,systemInstruction:w,safetySettings:this.settings.safetySettings,cachedContent:this.settings.cachedContent},warnings:f};case"object-tool":return{args:{generationConfig:b,contents:v,tools:{functionDeclarations:[{name:e.tool.name,description:null!=(m=e.tool.description)?m:"",parameters:Ps(e.tool.parameters)}]},toolConfig:{functionCallingConfig:{mode:"ANY"}},safetySettings:this.settings.safetySettings,cachedContent:this.settings.cachedContent},warnings:f};default:throw new Error(`Unsupported type: ${g}`)}}supportsUrl(e){return this.config.isSupportedUrl(e)}async doGenerate(e){var t,n,r,s,o;const{args:a,warnings:i}=await this.getArgs(e),l=JSON.stringify(a),u=Ae(await Ge(this.config.headers),e.headers),{responseHeaders:c,value:d,rawValue:p}=await Ve({url:`${this.config.baseURL}/${Ds(this.modelId)}:generateContent`,headers:u,body:a,failedResponseHandler:Us,successfulResponseHandler:Qe(Js),abortSignal:e.abortSignal,fetch:this.config.fetch}),{contents:h,...m}=a,g=d.candidates[0],f=null!=g.content&&"object"==typeof g.content&&"parts"in g.content?g.content.parts:[],y=Fs({parts:f,generateId:this.config.generateId}),b=d.usageMetadata;return{text:Bs(f),reasoning:Hs(f),files:null==(t=Zs(f))?void 0:t.map(e=>({data:e.inlineData.data,mimeType:e.inlineData.mimeType})),toolCalls:y,finishReason:qs({finishReason:g.finishReason,hasToolCalls:null!=y&&y.length>0}),usage:{promptTokens:null!=(n=null==b?void 0:b.promptTokenCount)?n:NaN,completionTokens:null!=(r=null==b?void 0:b.candidatesTokenCount)?r:NaN},rawCall:{rawPrompt:h,rawSettings:m},rawResponse:{headers:c,body:p},warnings:i,providerMetadata:{google:{groundingMetadata:null!=(s=g.groundingMetadata)?s:null,safetyRatings:null!=(o=g.safetyRatings)?o:null}},sources:Ws({groundingMetadata:g.groundingMetadata,generateId:this.config.generateId}),request:{body:l}}}async doStream(e){const{args:t,warnings:n}=await this.getArgs(e),r=JSON.stringify(t),s=Ae(await Ge(this.config.headers),e.headers),{responseHeaders:o,value:a}=await Ve({url:`${this.config.baseURL}/${Ds(this.modelId)}:streamGenerateContent?alt=sse`,headers:s,body:t,failedResponseHandler:Us,successfulResponseHandler:Ye(Xs),abortSignal:e.abortSignal,fetch:this.config.fetch}),{contents:i,...l}=t;let u,c="unknown",d={promptTokens:Number.NaN,completionTokens:Number.NaN};const p=this.config.generateId;let h=!1;return{stream:a.pipeThrough(new TransformStream({transform(e,t){var n,r,s,o,a,i;if(!e.success)return void t.enqueue({type:"error",error:e.error});const l=e.value,m=l.usageMetadata;null!=m&&(d={promptTokens:null!=(n=m.promptTokenCount)?n:NaN,completionTokens:null!=(r=m.candidatesTokenCount)?r:NaN});const g=null==(s=l.candidates)?void 0:s[0];if(null==g)return;const f=g.content;if(null!=f){const e=Bs(f.parts);null!=e&&t.enqueue({type:"text-delta",textDelta:e});const n=Hs(f.parts);if(null!=n)for(const e of n)t.enqueue({type:"reasoning",textDelta:e.text});const r=Zs(f.parts);if(null!=r)for(const e of r)t.enqueue({type:"file",mimeType:e.inlineData.mimeType,data:e.inlineData.data});const s=Fs({parts:f.parts,generateId:p});if(null!=s)for(const e of s)t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,argsTextDelta:e.args}),t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,args:e.args}),h=!0}if(null!=g.finishReason){c=qs({finishReason:g.finishReason,hasToolCalls:h});const e=null!=(o=Ws({groundingMetadata:g.groundingMetadata,generateId:p}))?o:[];for(const n of e)t.enqueue({type:"source",source:n});u={google:{groundingMetadata:null!=(a=g.groundingMetadata)?a:null,safetyRatings:null!=(i=g.safetyRatings)?i:null}}}},flush(e){e.enqueue({type:"finish",finishReason:c,usage:d,providerMetadata:u})}})),rawCall:{rawPrompt:i,rawSettings:l},rawResponse:{headers:o},warnings:n,request:{body:r}}}};function Fs({parts:e,generateId:t}){const n=null==e?void 0:e.filter(e=>"functionCall"in e);return null==n||0===n.length?void 0:n.map(e=>({toolCallType:"function",toolCallId:t(),toolName:e.functionCall.name,args:JSON.stringify(e.functionCall.args)}))}function Bs(e){const t=null==e?void 0:e.filter(e=>"text"in e&&!0!==e.thought);return null==t||0===t.length?void 0:t.map(e=>e.text).join("")}function Hs(e){const t=null==e?void 0:e.filter(e=>"text"in e&&!0===e.thought&&null!=e.text);return null==t||0===t.length?void 0:t.map(e=>({type:"text",text:e.text}))}function Zs(e){return null==e?void 0:e.filter(e=>"inlineData"in e)}function Ws({groundingMetadata:e,generateId:t}){var n;return null==(n=null==e?void 0:e.groundingChunks)?void 0:n.filter(e=>null!=e.web).map(e=>({sourceType:"url",id:t(),url:e.web.uri,title:e.web.title}))}var Vs=Sr.object({parts:Sr.array(Sr.union([Sr.object({functionCall:Sr.object({name:Sr.string(),args:Sr.unknown()})}),Sr.object({inlineData:Sr.object({mimeType:Sr.string(),data:Sr.string()})}),Sr.object({text:Sr.string().nullish(),thought:Sr.boolean().nullish()})])).nullish()}),zs=Sr.object({web:Sr.object({uri:Sr.string(),title:Sr.string()}).nullish(),retrievedContext:Sr.object({uri:Sr.string(),title:Sr.string()}).nullish()}),Gs=Sr.object({webSearchQueries:Sr.array(Sr.string()).nullish(),retrievalQueries:Sr.array(Sr.string()).nullish(),searchEntryPoint:Sr.object({renderedContent:Sr.string()}).nullish(),groundingChunks:Sr.array(zs).nullish(),groundingSupports:Sr.array(Sr.object({segment:Sr.object({startIndex:Sr.number().nullish(),endIndex:Sr.number().nullish(),text:Sr.string().nullish()}),segment_text:Sr.string().nullish(),groundingChunkIndices:Sr.array(Sr.number()).nullish(),supportChunkIndices:Sr.array(Sr.number()).nullish(),confidenceScores:Sr.array(Sr.number()).nullish(),confidenceScore:Sr.array(Sr.number()).nullish()})).nullish(),retrievalMetadata:Sr.union([Sr.object({webDynamicRetrievalScore:Sr.number()}),Sr.object({})]).nullish()}),Ks=Sr.object({category:Sr.string().nullish(),probability:Sr.string().nullish(),probabilityScore:Sr.number().nullish(),severity:Sr.string().nullish(),severityScore:Sr.number().nullish(),blocked:Sr.boolean().nullish()}),Js=Sr.object({candidates:Sr.array(Sr.object({content:Vs.nullish().or(Sr.object({}).strict()),finishReason:Sr.string().nullish(),safetyRatings:Sr.array(Ks).nullish(),groundingMetadata:Gs.nullish()})),usageMetadata:Sr.object({promptTokenCount:Sr.number().nullish(),candidatesTokenCount:Sr.number().nullish(),totalTokenCount:Sr.number().nullish()}).nullish()}),Xs=Sr.object({candidates:Sr.array(Sr.object({content:Vs.nullish(),finishReason:Sr.string().nullish(),safetyRatings:Sr.array(Ks).nullish(),groundingMetadata:Gs.nullish()})).nullish(),usageMetadata:Sr.object({promptTokenCount:Sr.number().nullish(),candidatesTokenCount:Sr.number().nullish(),totalTokenCount:Sr.number().nullish()}).nullish()}),Ys=Sr.object({responseModalities:Sr.array(Sr.enum(["TEXT","IMAGE"])).nullish(),thinkingConfig:Sr.object({thinkingBudget:Sr.number().nullish(),includeThoughts:Sr.boolean().nullish()}).nullish()}),Qs=class{constructor(e,t,n){this.specificationVersion="v1",this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){return 2048}get supportsParallelCalls(){return!0}async doEmbed({values:e,headers:t,abortSignal:n}){if(e.length>this.maxEmbeddingsPerCall)throw new ge({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const r=Ae(await Ge(this.config.headers),t),{responseHeaders:s,value:o}=await Ve({url:`${this.config.baseURL}/models/${this.modelId}:batchEmbedContents`,headers:r,body:{requests:e.map(e=>({model:`models/${this.modelId}`,content:{role:"user",parts:[{text:e}]},outputDimensionality:this.settings.outputDimensionality,taskType:this.settings.taskType}))},failedResponseHandler:Us,successfulResponseHandler:Qe(eo),abortSignal:n,fetch:this.config.fetch});return{embeddings:o.embeddings.map(e=>e.values),usage:void 0,rawResponse:{headers:s}}}},eo=Sr.object({embeddings:Sr.array(Sr.object({values:Sr.array(Sr.number())}))});function to(e){return e.toString().startsWith("https://generativelanguage.googleapis.com/v1beta/files/")}function no(e={}){var t;const n=null!=(t=st(e.baseURL))?t:"https://generativelanguage.googleapis.com/v1beta",r=()=>({"x-goog-api-key":$e({apiKey:e.apiKey,environmentVariableName:"GOOGLE_GENERATIVE_AI_API_KEY",description:"Google Generative AI"}),...e.headers}),s=(t,s={})=>{var o;return new Ls(t,s,{provider:"google.generative-ai",baseURL:n,headers:r,generateId:null!=(o=e.generateId)?o:Me,isSupportedUrl:to,fetch:e.fetch})},o=(t,s={})=>new Qs(t,s,{provider:"google.generative-ai",baseURL:n,headers:r,fetch:e.fetch}),a=function(e,t){if(new.target)throw new Error("The Google Generative AI model function cannot be called with the new keyword.");return s(e,t)};return a.languageModel=s,a.chat=s,a.generativeAI=s,a.embedding=o,a.textEmbedding=o,a.textEmbeddingModel=o,a}no(),"function"==typeof SuppressedError&&SuppressedError,"undefined"!=typeof Buffer&&Buffer.from;var ro=function(){function e(){this.checksum=4294967295}return e.prototype.update=function(e){var t,n;try{for(var r=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(e),s=r.next();!s.done;s=r.next()){var o=s.value;this.checksum=this.checksum>>>8^so[255&(this.checksum^o)]}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return this},e.prototype.digest=function(){return(4294967295^this.checksum)>>>0},e}(),so=function(e){if(!Uint32Array.from){for(var t=new Uint32Array(e.length),n=0;n<e.length;)t[n]=e[n],n+=1;return t}return Uint32Array.from(e)}([0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117]);const oo={},ao={};for(let e=0;e<256;e++){let t=e.toString(16).toLowerCase();1===t.length&&(t=`0${t}`),oo[e]=t,ao[t]=e}function io(e){let t="";for(let n=0;n<e.byteLength;n++)t+=oo[e[n]];return t}class lo{constructor(e){if(this.bytes=e,8!==e.byteLength)throw new Error("Int64 buffers must be exactly 8 bytes")}static fromNumber(e){if(e>0x8000000000000000||e<-0x8000000000000000)throw new Error(`${e} is too large (or, if negative, too small) to represent as an Int64`);const t=new Uint8Array(8);for(let n=7,r=Math.abs(Math.round(e));n>-1&&r>0;n--,r/=256)t[n]=r;return e<0&&uo(t),new lo(t)}valueOf(){const e=this.bytes.slice(0),t=128&e[0];return t&&uo(e),parseInt(io(e),16)*(t?-1:1)}toString(){return String(this.valueOf())}}function uo(e){for(let t=0;t<8;t++)e[t]^=255;for(let t=7;t>-1&&(e[t]++,0===e[t]);t--);}class co{constructor(e,t){this.toUtf8=e,this.fromUtf8=t}format(e){const t=[];for(const n of Object.keys(e)){const r=this.fromUtf8(n);t.push(Uint8Array.from([r.byteLength]),r,this.formatHeaderValue(e[n]))}const n=new Uint8Array(t.reduce((e,t)=>e+t.byteLength,0));let r=0;for(const e of t)n.set(e,r),r+=e.byteLength;return n}formatHeaderValue(e){switch(e.type){case"boolean":return Uint8Array.from([e.value?0:1]);case"byte":return Uint8Array.from([2,e.value]);case"short":const t=new DataView(new ArrayBuffer(3));return t.setUint8(0,3),t.setInt16(1,e.value,!1),new Uint8Array(t.buffer);case"integer":const n=new DataView(new ArrayBuffer(5));return n.setUint8(0,4),n.setInt32(1,e.value,!1),new Uint8Array(n.buffer);case"long":const r=new Uint8Array(9);return r[0]=5,r.set(e.value.bytes,1),r;case"binary":const s=new DataView(new ArrayBuffer(3+e.value.byteLength));s.setUint8(0,6),s.setUint16(1,e.value.byteLength,!1);const o=new Uint8Array(s.buffer);return o.set(e.value,3),o;case"string":const a=this.fromUtf8(e.value),i=new DataView(new ArrayBuffer(3+a.byteLength));i.setUint8(0,7),i.setUint16(1,a.byteLength,!1);const l=new Uint8Array(i.buffer);return l.set(a,3),l;case"timestamp":const u=new Uint8Array(9);return u[0]=8,u.set(lo.fromNumber(e.value.valueOf()).bytes,1),u;case"uuid":if(!xo.test(e.value))throw new Error(`Invalid UUID received: ${e.value}`);const c=new Uint8Array(17);return c[0]=9,c.set(function(e){if(e.length%2!=0)throw new Error("Hex encoded strings must have an even number length");const t=new Uint8Array(e.length/2);for(let n=0;n<e.length;n+=2){const r=e.slice(n,n+2).toLowerCase();if(!(r in ao))throw new Error(`Cannot decode unrecognized sequence ${r} as hexadecimal`);t[n/2]=ao[r]}return t}(e.value.replace(/\-/g,"")),1),c}}parse(e){const t={};let n=0;for(;n<e.byteLength;){const r=e.getUint8(n++),s=this.toUtf8(new Uint8Array(e.buffer,e.byteOffset+n,r));switch(n+=r,e.getUint8(n++)){case 0:t[s]={type:ho,value:!0};break;case 1:t[s]={type:ho,value:!1};break;case 2:t[s]={type:mo,value:e.getInt8(n++)};break;case 3:t[s]={type:go,value:e.getInt16(n,!1)},n+=2;break;case 4:t[s]={type:fo,value:e.getInt32(n,!1)},n+=4;break;case 5:t[s]={type:yo,value:new lo(new Uint8Array(e.buffer,e.byteOffset+n,8))},n+=8;break;case 6:const r=e.getUint16(n,!1);n+=2,t[s]={type:bo,value:new Uint8Array(e.buffer,e.byteOffset+n,r)},n+=r;break;case 7:const o=e.getUint16(n,!1);n+=2,t[s]={type:vo,value:this.toUtf8(new Uint8Array(e.buffer,e.byteOffset+n,o))},n+=o;break;case 8:t[s]={type:wo,value:new Date(new lo(new Uint8Array(e.buffer,e.byteOffset+n,8)).valueOf())},n+=8;break;case 9:const a=new Uint8Array(e.buffer,e.byteOffset+n,16);n+=16,t[s]={type:_o,value:`${io(a.subarray(0,4))}-${io(a.subarray(4,6))}-${io(a.subarray(6,8))}-${io(a.subarray(8,10))}-${io(a.subarray(10))}`};break;default:throw new Error("Unrecognized header type tag")}}return t}}var po;!function(e){e[e.boolTrue=0]="boolTrue",e[e.boolFalse=1]="boolFalse",e[e.byte=2]="byte",e[e.short=3]="short",e[e.integer=4]="integer",e[e.long=5]="long",e[e.byteArray=6]="byteArray",e[e.string=7]="string",e[e.timestamp=8]="timestamp",e[e.uuid=9]="uuid"}(po||(po={}));const ho="boolean",mo="byte",go="short",fo="integer",yo="long",bo="binary",vo="string",wo="timestamp",_o="uuid",xo=/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/;class ko{constructor(e,t){this.headerMarshaller=new co(e,t),this.messageBuffer=[],this.isEndOfStream=!1}feed(e){this.messageBuffer.push(this.decode(e))}endOfStream(){this.isEndOfStream=!0}getMessage(){const e=this.messageBuffer.pop(),t=this.isEndOfStream;return{getMessage:()=>e,isEndOfStream:()=>t}}getAvailableMessages(){const e=this.messageBuffer;this.messageBuffer=[];const t=this.isEndOfStream;return{getMessages:()=>e,isEndOfStream:()=>t}}encode({headers:e,body:t}){const n=this.headerMarshaller.format(e),r=n.byteLength+t.byteLength+16,s=new Uint8Array(r),o=new DataView(s.buffer,s.byteOffset,s.byteLength),a=new ro;return o.setUint32(0,r,!1),o.setUint32(4,n.byteLength,!1),o.setUint32(8,a.update(s.subarray(0,8)).digest(),!1),s.set(n,12),s.set(t,n.byteLength+12),o.setUint32(r-4,a.update(s.subarray(8,r-4)).digest(),!1),s}decode(e){const{headers:t,body:n}=function({byteLength:e,byteOffset:t,buffer:n}){if(e<16)throw new Error("Provided message too short to accommodate event stream message overhead");const r=new DataView(n,t,e),s=r.getUint32(0,!1);if(e!==s)throw new Error("Reported message length does not match received message length");const o=r.getUint32(4,!1),a=r.getUint32(8,!1),i=r.getUint32(e-4,!1),l=(new ro).update(new Uint8Array(n,t,8));if(a!==l.digest())throw new Error(`The prelude checksum specified in the message (${a}) does not match the calculated CRC32 checksum (${l.digest()})`);if(l.update(new Uint8Array(n,t+8,e-12)),i!==l.digest())throw new Error(`The message checksum (${l.digest()}) did not match the expected value of ${i}`);return{headers:new DataView(n,t+8+4,o),body:new Uint8Array(n,t+8+4+o,s-o-16)}}(e);return{headers:this.headerMarshaller.parse(t),body:n}}formatHeaders(e){return this.headerMarshaller.format(e)}}const To=e=>(new TextEncoder).encode(e),No=e=>{if("string"==typeof e)return e;if("object"!=typeof e||"number"!=typeof e.byteOffset||"number"!=typeof e.byteLength)throw new Error("@smithy/util-utf8: toUtf8 encoder function only accepts string | Uint8Array.");return new TextDecoder("utf-8").decode(e)},Io=new TextEncoder,Eo={appstream2:"appstream",cloudhsmv2:"cloudhsm",email:"ses",marketplace:"aws-marketplace",mobile:"AWSMobileHubService",pinpoint:"mobiletargeting",queue:"sqs","git-codecommit":"codecommit","mturk-requester-sandbox":"mturk-requester","personalize-runtime":"personalize"},Co=new Set(["authorization","content-type","content-length","user-agent","presigned-expires","expect","x-amzn-trace-id","range","connection"]);class So{constructor({method:e,url:t,headers:n,body:r,accessKeyId:s,secretAccessKey:o,sessionToken:a,service:i,region:l,cache:u,datetime:c,signQuery:d,appendSessionToken:p,allHeaders:h,singleEncode:m}){if(null==t)throw new TypeError("url is a required option");if(null==s)throw new TypeError("accessKeyId is a required option");if(null==o)throw new TypeError("secretAccessKey is a required option");let g,f;this.method=e||(r?"POST":"GET"),this.url=new URL(t),this.headers=new Headers(n||{}),this.body=r,this.accessKeyId=s,this.secretAccessKey=o,this.sessionToken=a,i&&l||([g,f]=function(e,t){const{hostname:n,pathname:r}=e;if(n.endsWith(".on.aws")){const e=n.match(/^[^.]{1,63}\.lambda-url\.([^.]{1,63})\.on\.aws$/);return null!=e?["lambda",e[1]||""]:["",""]}if(n.endsWith(".r2.cloudflarestorage.com"))return["s3","auto"];if(n.endsWith(".backblazeb2.com")){const e=n.match(/^(?:[^.]{1,63}\.)?s3\.([^.]{1,63})\.backblazeb2\.com$/);return null!=e?["s3",e[1]||""]:["",""]}const s=n.replace("dualstack.","").match(/([^.]{1,63})\.(?:([^.]{0,63})\.)?amazonaws\.com(?:\.cn)?$/);let o=s&&s[1]||"",a=s&&s[2];if("us-gov"===a)a="us-gov-west-1";else if("s3"===a||"s3-accelerate"===a)a="us-east-1",o="s3";else if("iot"===o)o=n.startsWith("iot.")?"execute-api":n.startsWith("data.jobs.iot.")?"iot-jobs-data":"/mqtt"===r?"iotdevicegateway":"iotdata";else if("autoscaling"===o){const e=(t.get("X-Amz-Target")||"").split(".")[0];"AnyScaleFrontendService"===e?o="application-autoscaling":"AnyScaleScalingPlannerFrontendService"===e&&(o="autoscaling-plans")}else null==a&&o.startsWith("s3-")?(a=o.slice(3).replace(/^fips-|^external-1/,""),o="s3"):o.endsWith("-fips")?o=o.slice(0,-5):a&&/-\d$/.test(o)&&!/-\d$/.test(a)&&([o,a]=[a,o]);return[Eo[o]||o,a||""]}(this.url,this.headers)),this.service=i||g||"",this.region=l||f||"us-east-1",this.cache=u||new Map,this.datetime=c||(new Date).toISOString().replace(/[:-]|\.\d{3}/g,""),this.signQuery=d,this.appendSessionToken=p||"iotdevicegateway"===this.service,this.headers.delete("Host"),"s3"!==this.service||this.signQuery||this.headers.has("X-Amz-Content-Sha256")||this.headers.set("X-Amz-Content-Sha256","UNSIGNED-PAYLOAD");const y=this.signQuery?this.url.searchParams:this.headers;if(y.set("X-Amz-Date",this.datetime),this.sessionToken&&!this.appendSessionToken&&y.set("X-Amz-Security-Token",this.sessionToken),this.signableHeaders=["host",...this.headers.keys()].filter(e=>h||!Co.has(e)).sort(),this.signedHeaders=this.signableHeaders.join(";"),this.canonicalHeaders=this.signableHeaders.map(e=>e+":"+("host"===e?this.url.host:(this.headers.get(e)||"").replace(/\s+/g," "))).join("\n"),this.credentialString=[this.datetime.slice(0,8),this.region,this.service,"aws4_request"].join("/"),this.signQuery&&("s3"!==this.service||y.has("X-Amz-Expires")||y.set("X-Amz-Expires","86400"),y.set("X-Amz-Algorithm","AWS4-HMAC-SHA256"),y.set("X-Amz-Credential",this.accessKeyId+"/"+this.credentialString),y.set("X-Amz-SignedHeaders",this.signedHeaders)),"s3"===this.service)try{this.encodedPath=decodeURIComponent(this.url.pathname.replace(/\+/g," "))}catch(e){this.encodedPath=this.url.pathname}else this.encodedPath=this.url.pathname.replace(/\/+/g,"/");m||(this.encodedPath=encodeURIComponent(this.encodedPath).replace(/%2F/g,"/")),this.encodedPath=Mo(this.encodedPath);const b=new Set;this.encodedSearch=[...this.url.searchParams].filter(([e])=>{if(!e)return!1;if("s3"===this.service){if(b.has(e))return!1;b.add(e)}return!0}).map(e=>e.map(e=>Mo(encodeURIComponent(e)))).sort(([e,t],[n,r])=>e<n?-1:e>n?1:t<r?-1:t>r?1:0).map(e=>e.join("=")).join("&")}async sign(){return this.signQuery?(this.url.searchParams.set("X-Amz-Signature",await this.signature()),this.sessionToken&&this.appendSessionToken&&this.url.searchParams.set("X-Amz-Security-Token",this.sessionToken)):this.headers.set("Authorization",await this.authHeader()),{method:this.method,url:this.url,headers:this.headers,body:this.body}}async authHeader(){return["AWS4-HMAC-SHA256 Credential="+this.accessKeyId+"/"+this.credentialString,"SignedHeaders="+this.signedHeaders,"Signature="+await this.signature()].join(", ")}async signature(){const e=this.datetime.slice(0,8),t=[this.secretAccessKey,e,this.region,this.service].join();let n=this.cache.get(t);if(!n){const r=await Ao("AWS4"+this.secretAccessKey,e),s=await Ao(r,this.region),o=await Ao(s,this.service);n=await Ao(o,"aws4_request"),this.cache.set(t,n)}return jo(await Ao(n,await this.stringToSign()))}async stringToSign(){return["AWS4-HMAC-SHA256",this.datetime,this.credentialString,jo(await Ro(await this.canonicalString()))].join("\n")}async canonicalString(){return[this.method.toUpperCase(),this.encodedPath,this.encodedSearch,this.canonicalHeaders+"\n",this.signedHeaders,await this.hexBodyHash()].join("\n")}async hexBodyHash(){let e=this.headers.get("X-Amz-Content-Sha256")||("s3"===this.service&&this.signQuery?"UNSIGNED-PAYLOAD":null);if(null==e){if(this.body&&"string"!=typeof this.body&&!("byteLength"in this.body))throw new Error("body must be a string, ArrayBuffer or ArrayBufferView, unless you include the X-Amz-Content-Sha256 header");e=jo(await Ro(this.body||""))}return e}}async function Ao(e,t){const n=await crypto.subtle.importKey("raw","string"==typeof e?Io.encode(e):e,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);return crypto.subtle.sign("HMAC",n,Io.encode(t))}async function Ro(e){return crypto.subtle.digest("SHA-256","string"==typeof e?Io.encode(e):e)}const Oo=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function jo(e){const t=new Uint8Array(e);let n="";for(let e=0;e<t.length;e++){const r=t[e];n+=Oo[r>>>4&15],n+=Oo[15&r]}return n}function Mo(e){return e.replace(/[!'()*]/g,e=>"%"+e.charCodeAt(0).toString(16).toUpperCase())}var Po={cachePoint:{type:"default"}},Do=Sr.object({message:Sr.string(),type:Sr.string().nullish()}),$o=e=>async({response:t})=>{const n=Oe(t);if(null==t.body)throw new C({});const r=new ko(No,To);let s=new Uint8Array(0);const o=new TextDecoder;return{responseHeaders:n,value:t.body.pipeThrough(new TransformStream({transform(t,n){var a,i;const l=new Uint8Array(s.length+t.length);for(l.set(s),l.set(t,s.length),s=l;s.length>=4;){const t=new DataView(s.buffer,s.byteOffset,s.byteLength).getUint32(0,!1);if(s.length<t)break;try{const l=s.subarray(0,t),u=r.decode(l);if(s=s.slice(t),"event"===(null==(a=u.headers[":message-type"])?void 0:a.value)){const t=Be({text:o.decode(u.body)});if(!t.success){n.enqueue(t);break}delete t.value.p;let r={[null==(i=u.headers[":event-type"])?void 0:i.value]:t.value};const s=Fe({value:r,schema:e});s.success?n.enqueue({success:!0,value:s.value,rawValue:r}):n.enqueue(s)}}catch(e){break}}}}))}},Uo=je({prefix:"file",size:16});function qo(e){var t;return null==(t=null==e?void 0:e.bedrock)?void 0:t.cachePoint}function Lo(e){return["jpeg","png","gif"].includes(e)}function Fo(e,t,n,r){return e&&t&&n?r.trim():r}function Bo(e){switch(e){case"stop_sequence":case"end_turn":return"stop";case"max_tokens":return"length";case"content_filtered":case"guardrail_intervened":return"content-filter";case"tool_use":return"tool-calls";default:return"unknown"}}var Ho=class{constructor(e,t,n){this.modelId=e,this.settings=t,this.config=n,this.specificationVersion="v1",this.provider="amazon-bedrock",this.defaultObjectGenerationMode="tool",this.supportsImageUrls=!1}getArgs({mode:e,prompt:t,maxTokens:n,temperature:r,topP:s,topK:o,frequencyPenalty:a,presencePenalty:i,stopSequences:l,responseFormat:u,seed:c,providerMetadata:d}){var p,h,m,g,f,y,b;const v=e.type,w=[];null!=a&&w.push({type:"unsupported-setting",setting:"frequencyPenalty"}),null!=i&&w.push({type:"unsupported-setting",setting:"presencePenalty"}),null!=c&&w.push({type:"unsupported-setting",setting:"seed"}),null!=o&&w.push({type:"unsupported-setting",setting:"topK"}),null!=u&&"text"!==u.type&&w.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});const{system:_,messages:x}=function(e){var t,n,r,s,o;const a=function(e){const t=[];let n;for(const r of e){const{role:e}=r;switch(e){case"system":"system"!==(null==n?void 0:n.type)&&(n={type:"system",messages:[]},t.push(n)),n.messages.push(r);break;case"assistant":"assistant"!==(null==n?void 0:n.type)&&(n={type:"assistant",messages:[]},t.push(n)),n.messages.push(r);break;case"user":case"tool":"user"!==(null==n?void 0:n.type)&&(n={type:"user",messages:[]},t.push(n)),n.messages.push(r);break;default:throw new Error(`Unsupported role: ${e}`)}}return t}(e);let i=[];const l=[];for(let e=0;e<a.length;e++){const u=a[e],c=e===a.length-1,d=u.type;switch(d){case"system":if(l.length>0)throw new Ne({functionality:"Multiple system messages that are separated by user/assistant messages"});for(const e of u.messages)i.push({text:e.content}),qo(e.providerMetadata)&&i.push(Po);break;case"user":{const e=[];for(const a of u.messages){const{role:i,content:l,providerMetadata:u}=a;switch(i){case"user":for(let a=0;a<l.length;a++){const i=l[a];switch(i.type){case"text":e.push({text:i.text});break;case"image":if(i.image instanceof URL)throw new Ne({functionality:"Image URLs in user messages"});e.push({image:{format:null==(n=null==(t=i.mimeType)?void 0:t.split("/"))?void 0:n[1],source:{bytes:rt(null!=(r=i.image)?r:i.image)}}});break;case"file":if(i.data instanceof URL)throw new Ne({functionality:"File URLs in user messages"});e.push({document:{format:null==(o=null==(s=i.mimeType)?void 0:s.split("/"))?void 0:o[1],name:Uo(),source:{bytes:i.data}}})}}break;case"tool":for(let t=0;t<l.length;t++){const n=l[t],r=null!=n.content?n.content.map(e=>{switch(e.type){case"text":return{text:e.text};case"image":if(!e.mimeType)throw new Error("Image mime type is required in tool result part content");const t=e.mimeType.split("/")[1];if(!Lo(t))throw new Error(`Unsupported image format: ${t}`);return{image:{format:t,source:{bytes:e.data}}}}}):[{text:JSON.stringify(n.result)}];e.push({toolResult:{toolUseId:n.toolCallId,content:r}})}break;default:throw new Error(`Unsupported role: ${i}`)}qo(u)&&e.push(Po)}l.push({role:"user",content:e});break}case"assistant":{const e=[];for(let t=0;t<u.messages.length;t++){const n=u.messages[t],r=t===u.messages.length-1,{content:s}=n;for(let t=0;t<s.length;t++){const n=s[t],o=t===s.length-1;switch(n.type){case"text":e.push({text:Fo(c,r,o,n.text)});break;case"reasoning":e.push({reasoningContent:{reasoningText:{text:Fo(c,r,o,n.text),signature:n.signature}}});break;case"redacted-reasoning":e.push({reasoningContent:{redactedReasoning:{data:n.data}}});break;case"tool-call":e.push({toolUse:{toolUseId:n.toolCallId,name:n.toolName,input:n.args}})}}qo(n.providerMetadata)&&e.push(Po)}l.push({role:"assistant",content:e});break}default:throw new Error(`Unsupported type: ${d}`)}}return{system:i,messages:l}}(t),k=Zo.safeParse(null==(p=null==d?void 0:d.bedrock)?void 0:p.reasoning_config);if(!k.success)throw new M({argument:"providerOptions.bedrock.reasoning_config",message:"invalid reasoning configuration options",cause:k.error});const T="enabled"===(null==(h=k.data)?void 0:h.type),N=null!=(f=null==(m=k.data)?void 0:m.budgetTokens)?f:null==(g=k.data)?void 0:g.budget_tokens,I={...null!=n&&{maxTokens:n},...null!=r&&{temperature:r},...null!=s&&{topP:s},...null!=l&&{stopSequences:l}};T&&null!=N&&(null!=I.maxTokens?I.maxTokens+=N:I.maxTokens=N+4096,this.settings.additionalModelRequestFields={...this.settings.additionalModelRequestFields,reasoning_config:{type:null==(y=k.data)?void 0:y.type,budget_tokens:N}}),T&&null!=I.temperature&&(delete I.temperature,w.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported when thinking is enabled"})),T&&null!=I.topP&&(delete I.topP,w.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported when thinking is enabled"}));const E={system:_,additionalModelRequestFields:this.settings.additionalModelRequestFields,...Object.keys(I).length>0&&{inferenceConfig:I},messages:x,...null==d?void 0:d.bedrock};switch(v){case"regular":{const{toolConfig:t,toolWarnings:n}=function(e){var t;const n=(null==(t=e.tools)?void 0:t.length)?e.tools:void 0;if(null==n)return{toolConfig:{tools:void 0,toolChoice:void 0},toolWarnings:[]};const r=[],s=[];for(const e of n)"provider-defined"===e.type?r.push({type:"unsupported-tool",tool:e}):s.push({toolSpec:{name:e.name,description:e.description,inputSchema:{json:e.parameters}}});const o=e.toolChoice;if(null==o)return{toolConfig:{tools:s,toolChoice:void 0},toolWarnings:r};const a=o.type;switch(a){case"auto":return{toolConfig:{tools:s,toolChoice:{auto:{}}},toolWarnings:r};case"required":return{toolConfig:{tools:s,toolChoice:{any:{}}},toolWarnings:r};case"none":return{toolConfig:{tools:void 0,toolChoice:void 0},toolWarnings:r};case"tool":return{toolConfig:{tools:s,toolChoice:{tool:{name:o.toolName}}},toolWarnings:r};default:throw new Ne({functionality:`Unsupported tool choice type: ${a}`})}}(e);return{command:{...E,...(null==(b=t.tools)?void 0:b.length)?{toolConfig:t}:{}},warnings:[...w,...n]}}case"object-json":throw new Ne({functionality:"json-mode object generation"});case"object-tool":return{command:{...E,toolConfig:{tools:[{toolSpec:{name:e.tool.name,description:e.tool.description,inputSchema:{json:e.tool.parameters}}}],toolChoice:{tool:{name:e.tool.name}}}},warnings:w};default:throw new Error(`Unsupported type: ${v}`)}}async doGenerate(e){var t,n,r,s,o,a,i,l,u,c,d,p,h,m,g,f;const{command:y,warnings:b}=this.getArgs(e),v=`${this.getUrl(this.modelId)}/converse`,{value:w,responseHeaders:_}=await Ve({url:v,headers:Ae(await Ge(this.config.headers),e.headers),body:y,failedResponseHandler:Xe({errorSchema:Do,errorToMessage:e=>{var t;return`${null!=(t=e.message)?t:"Unknown error"}`}}),successfulResponseHandler:Qe(Ko),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:x,...k}=y,T=w.trace||w.usage?{bedrock:{...w.trace&&"object"==typeof w.trace?{trace:w.trace}:{},...w.usage&&{usage:{cacheReadInputTokens:null!=(n=null==(t=w.usage)?void 0:t.cacheReadInputTokens)?n:Number.NaN,cacheWriteInputTokens:null!=(s=null==(r=w.usage)?void 0:r.cacheWriteInputTokens)?s:Number.NaN}}}}:void 0,N=w.output.message.content.filter(e=>e.reasoningContent).map(e=>{var t;return e.reasoningContent&&"reasoningText"in e.reasoningContent?{type:"text",text:e.reasoningContent.reasoningText.text,...e.reasoningContent.reasoningText.signature&&{signature:e.reasoningContent.reasoningText.signature}}:e.reasoningContent&&"redactedReasoning"in e.reasoningContent?{type:"redacted",data:null!=(t=e.reasoningContent.redactedReasoning.data)?t:""}:void 0}).filter(e=>void 0!==e);return{text:null!=(l=null==(i=null==(a=null==(o=w.output)?void 0:o.message)?void 0:a.content)?void 0:i.map(e=>{var t;return null!=(t=e.text)?t:""}).join(""))?l:void 0,toolCalls:null==(p=null==(d=null==(c=null==(u=w.output)?void 0:u.message)?void 0:c.content)?void 0:d.filter(e=>!!e.toolUse))?void 0:p.map(e=>{var t,n,r,s,o,a;return{toolCallType:"function",toolCallId:null!=(n=null==(t=e.toolUse)?void 0:t.toolUseId)?n:this.config.generateId(),toolName:null!=(s=null==(r=e.toolUse)?void 0:r.name)?s:`tool-${this.config.generateId()}`,args:JSON.stringify(null!=(a=null==(o=e.toolUse)?void 0:o.input)?a:"")}}),finishReason:Bo(w.stopReason),usage:{promptTokens:null!=(m=null==(h=w.usage)?void 0:h.inputTokens)?m:Number.NaN,completionTokens:null!=(f=null==(g=w.usage)?void 0:g.outputTokens)?f:Number.NaN},rawCall:{rawPrompt:x,rawSettings:k},rawResponse:{headers:_},warnings:b,reasoning:N.length>0?N:void 0,...T&&{providerMetadata:T}}}async doStream(e){const{command:t,warnings:n}=this.getArgs(e),r=`${this.getUrl(this.modelId)}/converse-stream`,{value:s,responseHeaders:o}=await Ve({url:r,headers:Ae(await Ge(this.config.headers),e.headers),body:t,failedResponseHandler:Xe({errorSchema:Do,errorToMessage:e=>`${e.type}: ${e.message}`}),successfulResponseHandler:$o(Jo),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:a,...i}=t;let l,u="unknown",c={promptTokens:Number.NaN,completionTokens:Number.NaN};const d={};return{stream:s.pipeThrough(new TransformStream({transform(e,t){var n,r,s,o,a,i,p,h,m,g,f,y,b,v;function w(e){u="error",t.enqueue({type:"error",error:e})}if(!e.success)return void w(e.error);const _=e.value;if(_.internalServerException)return void w(_.internalServerException);if(_.modelStreamErrorException)return void w(_.modelStreamErrorException);if(_.throttlingException)return void w(_.throttlingException);if(_.validationException)return void w(_.validationException);if(_.messageStop&&(u=Bo(_.messageStop.stopReason)),_.metadata){c={promptTokens:null!=(r=null==(n=_.metadata.usage)?void 0:n.inputTokens)?r:Number.NaN,completionTokens:null!=(o=null==(s=_.metadata.usage)?void 0:s.outputTokens)?o:Number.NaN};const e=null!=(null==(a=_.metadata.usage)?void 0:a.cacheReadInputTokens)||null!=(null==(i=_.metadata.usage)?void 0:i.cacheWriteInputTokens)?{usage:{cacheReadInputTokens:null!=(h=null==(p=_.metadata.usage)?void 0:p.cacheReadInputTokens)?h:Number.NaN,cacheWriteInputTokens:null!=(g=null==(m=_.metadata.usage)?void 0:m.cacheWriteInputTokens)?g:Number.NaN}}:void 0,t=_.metadata.trace?{trace:_.metadata.trace}:void 0;(e||t)&&(l={bedrock:{...e,...t}})}if((null==(f=_.contentBlockDelta)?void 0:f.delta)&&"text"in _.contentBlockDelta.delta&&_.contentBlockDelta.delta.text&&t.enqueue({type:"text-delta",textDelta:_.contentBlockDelta.delta.text}),(null==(y=_.contentBlockDelta)?void 0:y.delta)&&"reasoningContent"in _.contentBlockDelta.delta&&_.contentBlockDelta.delta.reasoningContent){const e=_.contentBlockDelta.delta.reasoningContent;"text"in e&&e.text?t.enqueue({type:"reasoning",textDelta:e.text}):"signature"in e&&e.signature?t.enqueue({type:"reasoning-signature",signature:e.signature}):"data"in e&&e.data&&t.enqueue({type:"redacted-reasoning",data:e.data})}const x=_.contentBlockStart;if(null!=(null==(b=null==x?void 0:x.start)?void 0:b.toolUse)){const e=x.start.toolUse;d[x.contentBlockIndex]={toolCallId:e.toolUseId,toolName:e.name,jsonText:""}}const k=_.contentBlockDelta;if((null==k?void 0:k.delta)&&"toolUse"in k.delta&&k.delta.toolUse){const e=d[k.contentBlockIndex],n=null!=(v=k.delta.toolUse.input)?v:"";t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,argsTextDelta:n}),e.jsonText+=n}const T=_.contentBlockStop;if(null!=T){const e=T.contentBlockIndex,n=d[e];null!=n&&(t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:n.toolCallId,toolName:n.toolName,args:n.jsonText}),delete d[e])}},flush(e){e.enqueue({type:"finish",finishReason:u,usage:c,...l&&{providerMetadata:l}})}})),rawCall:{rawPrompt:a,rawSettings:i},rawResponse:{headers:o},warnings:n}}getUrl(e){const t=encodeURIComponent(e);return`${this.config.baseUrl()}/model/${t}`}},Zo=Sr.object({type:Sr.union([Sr.literal("enabled"),Sr.literal("disabled")]).nullish(),budget_tokens:Sr.number().nullish(),budgetTokens:Sr.number().nullish()}).nullish(),Wo=Sr.union([Sr.enum(["stop","stop_sequence","end_turn","length","max_tokens","content-filter","content_filtered","guardrail_intervened","tool-calls","tool_use"]),Sr.string()]),Vo=Sr.object({toolUseId:Sr.string(),name:Sr.string(),input:Sr.unknown()}),zo=Sr.object({signature:Sr.string().nullish(),text:Sr.string()}),Go=Sr.object({data:Sr.string()}),Ko=Sr.object({metrics:Sr.object({latencyMs:Sr.number()}).nullish(),output:Sr.object({message:Sr.object({content:Sr.array(Sr.object({text:Sr.string().nullish(),toolUse:Vo.nullish(),reasoningContent:Sr.union([Sr.object({reasoningText:zo}),Sr.object({redactedReasoning:Go})]).nullish()})),role:Sr.string()})}),stopReason:Wo,trace:Sr.unknown().nullish(),usage:Sr.object({inputTokens:Sr.number(),outputTokens:Sr.number(),totalTokens:Sr.number(),cacheReadInputTokens:Sr.number().nullish(),cacheWriteInputTokens:Sr.number().nullish()})}),Jo=Sr.object({contentBlockDelta:Sr.object({contentBlockIndex:Sr.number(),delta:Sr.union([Sr.object({text:Sr.string()}),Sr.object({toolUse:Sr.object({input:Sr.string()})}),Sr.object({reasoningContent:Sr.object({text:Sr.string()})}),Sr.object({reasoningContent:Sr.object({signature:Sr.string()})}),Sr.object({reasoningContent:Sr.object({data:Sr.string()})})]).nullish()}).nullish(),contentBlockStart:Sr.object({contentBlockIndex:Sr.number(),start:Sr.object({toolUse:Vo.nullish()}).nullish()}).nullish(),contentBlockStop:Sr.object({contentBlockIndex:Sr.number()}).nullish(),internalServerException:Sr.record(Sr.unknown()).nullish(),messageStop:Sr.object({additionalModelResponseFields:Sr.record(Sr.unknown()).nullish(),stopReason:Wo}).nullish(),metadata:Sr.object({trace:Sr.unknown().nullish(),usage:Sr.object({cacheReadInputTokens:Sr.number().nullish(),cacheWriteInputTokens:Sr.number().nullish(),inputTokens:Sr.number(),outputTokens:Sr.number()}).nullish()}).nullish(),modelStreamErrorException:Sr.record(Sr.unknown()).nullish(),throttlingException:Sr.record(Sr.unknown()).nullish(),validationException:Sr.record(Sr.unknown()).nullish()}),Xo=class{constructor(e,t,n){this.modelId=e,this.settings=t,this.config=n,this.specificationVersion="v1",this.provider="amazon-bedrock",this.maxEmbeddingsPerCall=void 0,this.supportsParallelCalls=!0}getUrl(e){const t=encodeURIComponent(e);return`${this.config.baseUrl()}/model/${t}/invoke`}async doEmbed({values:e,headers:t,abortSignal:n}){return(await Promise.all(e.map(async e=>{const r={inputText:e,dimensions:this.settings.dimensions,normalize:this.settings.normalize},s=this.getUrl(this.modelId),{value:o}=await Ve({url:s,headers:await Ge(Ae(await Ge(this.config.headers),t)),body:r,failedResponseHandler:Xe({errorSchema:Do,errorToMessage:e=>`${e.type}: ${e.message}`}),successfulResponseHandler:Qe(Yo),fetch:this.config.fetch,abortSignal:n});return{embedding:o.embedding,inputTextTokenCount:o.inputTextTokenCount}}))).reduce((e,t)=>(e.embeddings.push(t.embedding),e.usage.tokens+=t.inputTextTokenCount,e),{embeddings:[],usage:{tokens:0}})}},Yo=Sr.object({embedding:Sr.array(Sr.number()),inputTextTokenCount:Sr.number()}),Qo={"amazon.nova-canvas-v1:0":5},ea=class{constructor(e,t,n){this.modelId=e,this.settings=t,this.config=n,this.specificationVersion="v1",this.provider="amazon-bedrock"}get maxImagesPerCall(){var e,t;return null!=(t=null!=(e=this.settings.maxImagesPerCall)?e:Qo[this.modelId])?t:1}getUrl(e){const t=encodeURIComponent(e);return`${this.config.baseUrl()}/model/${t}/invoke`}async doGenerate({prompt:e,n:t,size:n,aspectRatio:r,seed:s,providerOptions:o,headers:a,abortSignal:i}){var l,u,c,d,p,h;const m=[],[g,f]=n?n.split("x").map(Number):[],y={taskType:"TEXT_IMAGE",textToImageParams:{text:e,...(null==(l=null==o?void 0:o.bedrock)?void 0:l.negativeText)?{negativeText:o.bedrock.negativeText}:{}},imageGenerationConfig:{...g?{width:g}:{},...f?{height:f}:{},...s?{seed:s}:{},...t?{numberOfImages:t}:{},...(null==(u=null==o?void 0:o.bedrock)?void 0:u.quality)?{quality:o.bedrock.quality}:{},...(null==(c=null==o?void 0:o.bedrock)?void 0:c.cfgScale)?{cfgScale:o.bedrock.cfgScale}:{}}};null!=r&&m.push({type:"unsupported-setting",setting:"aspectRatio",details:"This model does not support aspect ratio. Use `size` instead."});const b=null!=(h=null==(p=null==(d=this.config._internal)?void 0:d.currentDate)?void 0:p.call(d))?h:new Date,{value:v,responseHeaders:w}=await Ve({url:this.getUrl(this.modelId),headers:await Ge(Ae(await Ge(this.config.headers),a)),body:y,failedResponseHandler:Xe({errorSchema:Do,errorToMessage:e=>`${e.type}: ${e.message}`}),successfulResponseHandler:Qe(ta),abortSignal:i,fetch:this.config.fetch});return{images:v.images,warnings:m,response:{timestamp:b,modelId:this.modelId,headers:w}}}},ta=Sr.object({images:Sr.array(Sr.string())});function na(e){const t={};return e.forEach((e,n)=>{t[n.toLowerCase()]=e}),t}function ra(e={}){const t=function(e,t=globalThis.fetch){return async(n,r)=>{var s;if("POST"!==(null==(s=null==r?void 0:r.method)?void 0:s.toUpperCase())||!(null==r?void 0:r.body))return t(n,r);const o="string"==typeof n?n:n instanceof URL?n.href:n.url,a=function(e){let t={};if(e)if(e instanceof Headers)t=na(e);else if(Array.isArray(e))for(const[n,r]of e)t[n.toLowerCase()]=r;else t=Object.fromEntries(Object.entries(e).map(([e,t])=>[e.toLowerCase(),t]));return t}(r.headers),i=function(e){return"string"==typeof e?e:e instanceof Uint8Array?(new TextDecoder).decode(e):e instanceof ArrayBuffer?(new TextDecoder).decode(new Uint8Array(e)):JSON.stringify(e)}(r.body),l=await e(),u=new So({url:o,method:"POST",headers:Object.entries(Pe(a)),body:i,region:l.region,accessKeyId:l.accessKeyId,secretAccessKey:l.secretAccessKey,sessionToken:l.sessionToken,service:"bedrock"}),c=na((await u.sign()).headers);return t(n,{...r,body:i,headers:Pe(Ae(a,c))})}}(async()=>{const t=qe({settingValue:e.region,settingName:"region",environmentVariableName:"AWS_REGION",description:"AWS region"});return e.credentialProvider?{...await e.credentialProvider(),region:t}:{region:t,accessKeyId:qe({settingValue:e.accessKeyId,settingName:"accessKeyId",environmentVariableName:"AWS_ACCESS_KEY_ID",description:"AWS access key ID"}),secretAccessKey:qe({settingValue:e.secretAccessKey,settingName:"secretAccessKey",environmentVariableName:"AWS_SECRET_ACCESS_KEY",description:"AWS secret access key"}),sessionToken:Ue({settingValue:e.sessionToken,environmentVariableName:"AWS_SESSION_TOKEN"})}},e.fetch),n=()=>{var t,n;return null!=(n=st(null!=(t=e.baseURL)?t:`https://bedrock-runtime.${qe({settingValue:e.region,settingName:"region",environmentVariableName:"AWS_REGION",description:"AWS region"})}.amazonaws.com`))?n:"https://bedrock-runtime.us-east-1.amazonaws.com"},r=(r,s={})=>{var o;return new Ho(r,s,{baseUrl:n,headers:null!=(o=e.headers)?o:{},fetch:t,generateId:Me})},s=function(e,t){if(new.target)throw new Error("The Amazon Bedrock model function cannot be called with the new keyword.");return r(e,t)},o=(r,s={})=>{var o;return new Xo(r,s,{baseUrl:n,headers:null!=(o=e.headers)?o:{},fetch:t})},a=(r,s={})=>{var o;return new ea(r,s,{baseUrl:n,headers:null!=(o=e.headers)?o:{},fetch:t})};return s.languageModel=r,s.embedding=o,s.textEmbedding=o,s.textEmbeddingModel=o,s.image=a,s.imageModel=a,s}ra();var sa=Object.defineProperty,oa=Object.defineProperties,aa=Object.getOwnPropertyDescriptors,ia=Object.getOwnPropertySymbols,la=Object.prototype.hasOwnProperty,ua=Object.prototype.propertyIsEnumerable,ca=(e,t,n)=>t in e?sa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,da=(e,t)=>{for(var n in t||(t={}))la.call(t,n)&&ca(e,n,t[n]);if(ia)for(var n of ia(t))ua.call(t,n)&&ca(e,n,t[n]);return e},pa=(e,t)=>oa(e,aa(t)),ha=(e,t)=>{var n={};for(var r in e)la.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&ia)for(var r of ia(e))t.indexOf(r)<0&&ua.call(e,r)&&(n[r]=e[r]);return n},ma=Sr.object({type:Sr.literal("reasoning.summary"),summary:Sr.string()}),ga=Sr.object({type:Sr.literal("reasoning.encrypted"),data:Sr.string()}),fa=Sr.object({type:Sr.literal("reasoning.text"),text:Sr.string().nullish(),signature:Sr.string().nullish()}),ya=Sr.union([ma,ga,fa]),ba=Sr.union([ya,Sr.unknown().transform(()=>null)]),va=Sr.array(ba).transform(e=>e.filter(e=>!!e));function wa(e){var t,n,r;const s=null==e?void 0:e.anthropic,o=null==e?void 0:e.openrouter;return null!=(r=null!=(n=null!=(t=null==o?void 0:o.cacheControl)?t:null==o?void 0:o.cache_control)?n:null==s?void 0:s.cacheControl)?r:null==s?void 0:s.cache_control}function _a(e){var t,n,r;const s=[];for(const{role:o,content:a,providerMetadata:i}of e)switch(o){case"system":s.push({role:"system",content:a,cache_control:wa(i)});break;case"user":{if(1===a.length&&"text"===(null==(t=a[0])?void 0:t.type)){s.push({role:"user",content:a[0].text,cache_control:null!=(n=wa(i))?n:wa(a[0].providerMetadata)});break}const e=wa(i),r=a.map(t=>{var n,r,s,o;const a=null!=(n=wa(t.providerMetadata))?n:e;switch(t.type){case"text":return{type:"text",text:t.text,cache_control:a};case"image":return{type:"image_url",image_url:{url:t.image instanceof URL?t.image.toString():`data:${null!=(r=t.mimeType)?r:"image/jpeg"};base64,${rt(t.image)}`},cache_control:a};case"file":return{type:"file",file:{filename:String(null==(o=null==(s=t.providerMetadata)?void 0:s.openrouter)?void 0:o.filename),file_data:t.data instanceof Uint8Array?`data:${t.mimeType};base64,${rt(t.data)}`:`data:${t.mimeType};base64,${t.data}`},cache_control:a};default:throw new Error(`Unsupported content part type: ${t}`)}});s.push({role:"user",content:r});break}case"assistant":{let e="",t="";const n=[],r=[];for(const s of a)switch(s.type){case"text":e+=s.text;break;case"tool-call":r.push({id:s.toolCallId,type:"function",function:{name:s.toolName,arguments:JSON.stringify(s.args)}});break;case"reasoning":t+=s.text,n.push({type:"reasoning.text",text:s.text,signature:s.signature});break;case"redacted-reasoning":n.push({type:"reasoning.encrypted",data:s.data});break;case"file":break;default:throw new Error(`Unsupported part: ${s}`)}s.push({role:"assistant",content:e,tool_calls:r.length>0?r:void 0,reasoning:t||void 0,reasoning_details:n.length>0?n:void 0,cache_control:wa(i)});break}case"tool":for(const e of a)s.push({role:"tool",tool_call_id:e.toolCallId,content:JSON.stringify(e.result),cache_control:null!=(r=wa(i))?r:wa(e.providerMetadata)});break;default:throw new Error(`Unsupported role: ${o}`)}return s}function xa(e){var t,n;return null!=(n=null==(t=null==e?void 0:e.content)?void 0:t.map(({token:e,logprob:t,top_logprobs:n})=>({token:e,logprob:t,topLogprobs:n?n.map(({token:e,logprob:t})=>({token:e,logprob:t})):[]})))?n:void 0}function ka(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var Ta=Sr.object({error:Sr.object({code:Sr.union([Sr.string(),Sr.number()]).nullable(),message:Sr.string(),type:Sr.string().nullable(),param:Sr.any().nullable()})}),Na=Xe({errorSchema:Ta,errorToMessage:e=>e.error.message}),Ia=class{constructor(e,t,n){this.specificationVersion="v1",this.defaultObjectGenerationMode="tool",this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}getArgs({mode:e,prompt:t,maxTokens:n,temperature:r,topP:s,frequencyPenalty:o,presencePenalty:a,seed:i,stopSequences:l,responseFormat:u,topK:c,providerMetadata:d}){var p;const h=e.type,m=null!=(p=null==d?void 0:d.openrouter)?p:{},g=da(da(da({model:this.modelId,models:this.settings.models,logit_bias:this.settings.logitBias,logprobs:!0===this.settings.logprobs||"number"==typeof this.settings.logprobs||void 0,top_logprobs:"number"==typeof this.settings.logprobs?this.settings.logprobs:"boolean"==typeof this.settings.logprobs&&this.settings.logprobs?0:void 0,user:this.settings.user,parallel_tool_calls:this.settings.parallelToolCalls,max_tokens:n,temperature:r,top_p:s,frequency_penalty:o,presence_penalty:a,seed:i,stop:l,response_format:u,top_k:c,messages:_a(t),include_reasoning:this.settings.includeReasoning,reasoning:this.settings.reasoning,usage:this.settings.usage},this.config.extraBody),this.settings.extraBody),m);switch(h){case"regular":return da(da({},g),function(e){var t;const n=(null==(t=e.tools)?void 0:t.length)?e.tools:void 0;if(null==n)return{tools:void 0,tool_choice:void 0};const r=n.map(e=>function(e){return"parameters"in e}(e)?{type:"function",function:{name:e.name,description:e.description,parameters:e.parameters}}:{type:"function",function:{name:e.name}}),s=e.toolChoice;if(null==s)return{tools:r,tool_choice:void 0};const o=s.type;switch(o){case"auto":case"none":case"required":return{tools:r,tool_choice:o};case"tool":return{tools:r,tool_choice:{type:"function",function:{name:s.toolName}}};default:throw new Error(`Unsupported tool choice type: ${o}`)}}(e));case"object-json":return pa(da({},g),{response_format:{type:"json_object"}});case"object-tool":return pa(da({},g),{tool_choice:{type:"function",function:{name:e.tool.name}},tools:[{type:"function",function:{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters}}]});default:throw new Ne({functionality:`${h} mode`})}}async doGenerate(e){var t,n,r,s,o,a,i,l,u;const c=this.getArgs(e),{responseHeaders:d,value:p}=await Ve({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:c,failedResponseHandler:Na,successfulResponseHandler:Qe(Ca),abortSignal:e.abortSignal,fetch:this.config.fetch}),h=c,{messages:m}=h,g=ha(h,["messages"]),f=p.choices[0];if(!f)throw new Error("No choice in response");const y=p.usage?{promptTokens:null!=(t=p.usage.prompt_tokens)?t:0,completionTokens:null!=(n=p.usage.completion_tokens)?n:0}:{promptTokens:0,completionTokens:0},b={};p.usage&&(null==(r=this.settings.usage)?void 0:r.include)&&(b.openrouter={usage:{promptTokens:p.usage.prompt_tokens,promptTokensDetails:p.usage.prompt_tokens_details?{cachedTokens:null!=(s=p.usage.prompt_tokens_details.cached_tokens)?s:0}:void 0,completionTokens:p.usage.completion_tokens,completionTokensDetails:p.usage.completion_tokens_details?{reasoningTokens:null!=(o=p.usage.completion_tokens_details.reasoning_tokens)?o:0}:void 0,cost:p.usage.cost,totalTokens:null!=(a=p.usage.total_tokens)?a:0}});const v=Object.keys(b).length>0,w=null!=(i=f.message.reasoning_details)?i:[],_=w.length>0?w.map(e=>{var t;switch(e.type){case"reasoning.text":if(e.text)return{type:"text",text:e.text,signature:null!=(t=e.signature)?t:void 0};break;case"reasoning.summary":if(e.summary)return{type:"text",text:e.summary};break;case"reasoning.encrypted":if(e.data)return{type:"redacted",data:e.data}}return null}).filter(e=>null!==e):f.message.reasoning?[{type:"text",text:f.message.reasoning}]:[];return da({response:{id:p.id,modelId:p.model},text:null!=(l=f.message.content)?l:void 0,reasoning:_,toolCalls:null==(u=f.message.tool_calls)?void 0:u.map(e=>{var t;return{toolCallType:"function",toolCallId:null!=(t=e.id)?t:Me(),toolName:e.function.name,args:e.function.arguments}}),finishReason:ka(f.finish_reason),usage:y,rawCall:{rawPrompt:m,rawSettings:g},rawResponse:{headers:d},warnings:[],logprobs:xa(f.logprobs)},v?{providerMetadata:b}:{})}async doStream(e){var t,n;const r=this.getArgs(e),{responseHeaders:s,value:o}=await Ve({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:pa(da({},r),{stream:!0,stream_options:"strict"===this.config.compatibility?da({include_usage:!0},(null==(t=this.settings.usage)?void 0:t.include)?{include_usage:!0}:{}):void 0}),failedResponseHandler:Na,successfulResponseHandler:Ye(Sa),abortSignal:e.abortSignal,fetch:this.config.fetch}),a=r,{messages:i}=a,l=ha(a,["messages"]),u=[];let c,d="other",p={promptTokens:Number.NaN,completionTokens:Number.NaN};const h={},m=!!(null==(n=this.settings.usage)?void 0:n.include);return{stream:o.pipeThrough(new TransformStream({transform(e,t){var n,r,s,o,a,i,l,m,g,f,y,b,v,w;if(!e.success)return d="error",void t.enqueue({type:"error",error:e.error});const _=e.value;if("error"in _)return d="error",void t.enqueue({type:"error",error:_.error});_.id&&t.enqueue({type:"response-metadata",id:_.id}),_.model&&t.enqueue({type:"response-metadata",modelId:_.model}),null!=_.usage&&(p={promptTokens:_.usage.prompt_tokens,completionTokens:_.usage.completion_tokens},h.promptTokens=_.usage.prompt_tokens,_.usage.prompt_tokens_details&&(h.promptTokensDetails={cachedTokens:null!=(n=_.usage.prompt_tokens_details.cached_tokens)?n:0}),h.completionTokens=_.usage.completion_tokens,_.usage.completion_tokens_details&&(h.completionTokensDetails={reasoningTokens:null!=(r=_.usage.completion_tokens_details.reasoning_tokens)?r:0}),h.cost=_.usage.cost,h.totalTokens=_.usage.total_tokens);const x=_.choices[0];if(null!=(null==x?void 0:x.finish_reason)&&(d=ka(x.finish_reason)),null==(null==x?void 0:x.delta))return;const k=x.delta;if(null!=k.content&&t.enqueue({type:"text-delta",textDelta:k.content}),null!=k.reasoning&&t.enqueue({type:"reasoning",textDelta:k.reasoning}),k.reasoning_details&&k.reasoning_details.length>0)for(const e of k.reasoning_details)switch(e.type){case"reasoning.text":e.text&&t.enqueue({type:"reasoning",textDelta:e.text}),e.signature&&t.enqueue({type:"reasoning-signature",signature:e.signature});break;case"reasoning.encrypted":e.data&&t.enqueue({type:"redacted-reasoning",data:e.data});break;case"reasoning.summary":e.summary&&t.enqueue({type:"reasoning",textDelta:e.summary})}const T=xa(null==x?void 0:x.logprobs);if((null==T?void 0:T.length)&&(void 0===c&&(c=[]),c.push(...T)),null!=k.tool_calls)for(const e of k.tool_calls){const n=e.index;if(null==u[n]){if("function"!==e.type)throw new Z({data:e,message:"Expected 'function' type."});if(null==e.id)throw new Z({data:e,message:"Expected 'id' to be a string."});if(null==(null==(s=e.function)?void 0:s.name))throw new Z({data:e,message:"Expected 'function.name' to be a string."});u[n]={id:e.id,type:"function",function:{name:e.function.name,arguments:null!=(o=e.function.arguments)?o:""},sent:!1};const r=u[n];if(null==r)throw new Error("Tool call is missing");null!=(null==(a=r.function)?void 0:a.name)&&null!=(null==(i=r.function)?void 0:i.arguments)&&He(r.function.arguments)&&(t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:r.id,toolName:r.function.name,argsTextDelta:r.function.arguments}),t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:null!=(l=r.id)?l:Me(),toolName:r.function.name,args:r.function.arguments}),r.sent=!0);continue}const r=u[n];if(null==r)throw new Error("Tool call is missing");null!=(null==(m=e.function)?void 0:m.arguments)&&(r.function.arguments+=null!=(f=null==(g=e.function)?void 0:g.arguments)?f:""),t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:r.id,toolName:r.function.name,argsTextDelta:null!=(y=e.function.arguments)?y:""}),null!=(null==(b=r.function)?void 0:b.name)&&null!=(null==(v=r.function)?void 0:v.arguments)&&He(r.function.arguments)&&(t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:null!=(w=r.id)?w:Me(),toolName:r.function.name,args:r.function.arguments}),r.sent=!0)}},flush(e){var t;if("tool-calls"===d)for(const n of u)n.sent||(e.enqueue({type:"tool-call",toolCallType:"function",toolCallId:null!=(t=n.id)?t:Me(),toolName:n.function.name,args:He(n.function.arguments)?n.function.arguments:"{}"}),n.sent=!0);const n={};!m||void 0===h.totalTokens&&void 0===h.cost&&void 0===h.promptTokensDetails&&void 0===h.completionTokensDetails||(n.openrouter={usage:h});const r=Object.keys(n).length>0&&m;e.enqueue(da({type:"finish",finishReason:d,logprobs:c,usage:p},r?{providerMetadata:n}:{}))}})),rawCall:{rawPrompt:i,rawSettings:l},rawResponse:{headers:s},warnings:[]}}},Ea=Sr.object({id:Sr.string().optional(),model:Sr.string().optional(),usage:Sr.object({prompt_tokens:Sr.number(),prompt_tokens_details:Sr.object({cached_tokens:Sr.number()}).nullish(),completion_tokens:Sr.number(),completion_tokens_details:Sr.object({reasoning_tokens:Sr.number()}).nullish(),total_tokens:Sr.number(),cost:Sr.number().optional()}).nullish()}),Ca=Ea.extend({choices:Sr.array(Sr.object({message:Sr.object({role:Sr.literal("assistant"),content:Sr.string().nullable().optional(),reasoning:Sr.string().nullable().optional(),reasoning_details:va.nullish(),tool_calls:Sr.array(Sr.object({id:Sr.string().optional().nullable(),type:Sr.literal("function"),function:Sr.object({name:Sr.string(),arguments:Sr.string()})})).optional()}),index:Sr.number(),logprobs:Sr.object({content:Sr.array(Sr.object({token:Sr.string(),logprob:Sr.number(),top_logprobs:Sr.array(Sr.object({token:Sr.string(),logprob:Sr.number()}))})).nullable()}).nullable().optional(),finish_reason:Sr.string().optional().nullable()}))}),Sa=Sr.union([Ea.extend({choices:Sr.array(Sr.object({delta:Sr.object({role:Sr.enum(["assistant"]).optional(),content:Sr.string().nullish(),reasoning:Sr.string().nullish().optional(),reasoning_details:va.nullish(),tool_calls:Sr.array(Sr.object({index:Sr.number(),id:Sr.string().nullish(),type:Sr.literal("function").optional(),function:Sr.object({name:Sr.string().nullish(),arguments:Sr.string().nullish()})})).nullish()}).nullish(),logprobs:Sr.object({content:Sr.array(Sr.object({token:Sr.string(),logprob:Sr.number(),top_logprobs:Sr.array(Sr.object({token:Sr.string(),logprob:Sr.number()}))})).nullable()}).nullish(),finish_reason:Sr.string().nullable().optional(),index:Sr.number()}))}),Ta]);function Aa(e){return null==e?void 0:e.tokens.map((t,n)=>{var r,s;return{token:t,logprob:null!=(r=e.token_logprobs[n])?r:0,topLogprobs:e.top_logprobs?Object.entries(null!=(s=e.top_logprobs[n])?s:{}).map(([e,t])=>({token:e,logprob:t})):[]}})}var Ra=class{constructor(e,t,n){this.specificationVersion="v1",this.defaultObjectGenerationMode=void 0,this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}getArgs({mode:e,inputFormat:t,prompt:n,maxTokens:r,temperature:s,topP:o,frequencyPenalty:a,presencePenalty:i,seed:l,responseFormat:u,topK:c,stopSequences:d,providerMetadata:p}){var h,m;const g=e.type,f=null!=(h=null==p?void 0:p.openrouter)?h:{},{prompt:y}=function({prompt:e,inputFormat:t,user:n="user",assistant:r="assistant"}){if("prompt"===t&&1===e.length&&e[0]&&"user"===e[0].role&&1===e[0].content.length&&e[0].content[0]&&"text"===e[0].content[0].type)return{prompt:e[0].content[0].text};let s="";e[0]&&"system"===e[0].role&&(s+=`${e[0].content}\n\n`,e=e.slice(1));for(const{role:t,content:o}of e)switch(t){case"system":throw new q({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":s+=`${n}:\n${o.map(e=>{switch(e.type){case"text":return e.text;case"image":throw new Ne({functionality:"images"});case"file":throw new Ne({functionality:"file attachments"});default:throw new Error(`Unsupported content type: ${e}`)}}).join("")}\n\n`;break;case"assistant":s+=`${r}:\n${o.map(e=>{switch(e.type){case"text":return e.text;case"tool-call":throw new Ne({functionality:"tool-call messages"});case"reasoning":throw new Ne({functionality:"reasoning messages"});case"redacted-reasoning":throw new Ne({functionality:"redacted reasoning messages"});case"file":throw new Ne({functionality:"file attachments"});default:throw new Error(`Unsupported content type: ${e}`)}}).join("")}\n\n`;break;case"tool":throw new Ne({functionality:"tool messages"});default:throw new Error(`Unsupported role: ${t}`)}return s+=`${r}:\n`,{prompt:s}}({prompt:n,inputFormat:t}),b=da(da(da({model:this.modelId,models:this.settings.models,logit_bias:this.settings.logitBias,logprobs:"number"==typeof this.settings.logprobs?this.settings.logprobs:"boolean"==typeof this.settings.logprobs&&this.settings.logprobs?0:void 0,suffix:this.settings.suffix,user:this.settings.user,max_tokens:r,temperature:s,top_p:o,frequency_penalty:a,presence_penalty:i,seed:l,stop:d,response_format:u,top_k:c,prompt:y,include_reasoning:this.settings.includeReasoning,reasoning:this.settings.reasoning},this.config.extraBody),this.settings.extraBody),f);switch(g){case"regular":if(null==(m=e.tools)?void 0:m.length)throw new Ne({functionality:"tools"});if(e.toolChoice)throw new Ne({functionality:"toolChoice"});return b;case"object-json":throw new Ne({functionality:"object-json mode"});case"object-tool":throw new Ne({functionality:"object-tool mode"});default:throw new Ne({functionality:`${g} mode`})}}async doGenerate(e){var t,n,r,s,o;const a=this.getArgs(e),{responseHeaders:i,value:l}=await Ve({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:a,failedResponseHandler:Na,successfulResponseHandler:Qe(Oa),abortSignal:e.abortSignal,fetch:this.config.fetch}),u=a,{prompt:c}=u,d=ha(u,["prompt"]);if("error"in l)throw new Error(`${l.error.message}`);const p=l.choices[0];if(!p)throw new Error("No choice in OpenRouter completion response");return{response:{id:l.id,modelId:l.model},text:null!=(t=p.text)?t:"",reasoning:p.reasoning||void 0,usage:{promptTokens:null!=(r=null==(n=l.usage)?void 0:n.prompt_tokens)?r:0,completionTokens:null!=(o=null==(s=l.usage)?void 0:s.completion_tokens)?o:0},finishReason:ka(p.finish_reason),logprobs:Aa(p.logprobs),rawCall:{rawPrompt:c,rawSettings:d},rawResponse:{headers:i},warnings:[]}}async doStream(e){const t=this.getArgs(e),{responseHeaders:n,value:r}=await Ve({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:pa(da({},this.getArgs(e)),{stream:!0,stream_options:"strict"===this.config.compatibility?{include_usage:!0}:void 0}),failedResponseHandler:Na,successfulResponseHandler:Ye(Oa),abortSignal:e.abortSignal,fetch:this.config.fetch}),s=t,{prompt:o}=s,a=ha(s,["prompt"]);let i,l="other",u={promptTokens:Number.NaN,completionTokens:Number.NaN};return{stream:r.pipeThrough(new TransformStream({transform(e,t){if(!e.success)return l="error",void t.enqueue({type:"error",error:e.error});const n=e.value;if("error"in n)return l="error",void t.enqueue({type:"error",error:n.error});null!=n.usage&&(u={promptTokens:n.usage.prompt_tokens,completionTokens:n.usage.completion_tokens});const r=n.choices[0];null!=(null==r?void 0:r.finish_reason)&&(l=ka(r.finish_reason)),null!=(null==r?void 0:r.text)&&t.enqueue({type:"text-delta",textDelta:r.text});const s=Aa(null==r?void 0:r.logprobs);(null==s?void 0:s.length)&&(void 0===i&&(i=[]),i.push(...s))},flush(e){e.enqueue({type:"finish",finishReason:l,logprobs:i,usage:u})}})),rawCall:{rawPrompt:o,rawSettings:a},rawResponse:{headers:n},warnings:[]}}},Oa=Sr.union([Sr.object({id:Sr.string().optional(),model:Sr.string().optional(),choices:Sr.array(Sr.object({text:Sr.string(),reasoning:Sr.string().nullish().optional(),reasoning_details:va.nullish(),finish_reason:Sr.string().nullish(),index:Sr.number(),logprobs:Sr.object({tokens:Sr.array(Sr.string()),token_logprobs:Sr.array(Sr.number()),top_logprobs:Sr.array(Sr.record(Sr.string(),Sr.number())).nullable()}).nullable().optional()})),usage:Sr.object({prompt_tokens:Sr.number(),completion_tokens:Sr.number()}).optional().nullable()}),Ta]);function ja(e={}){var t,n,r;const s=null!=(n=st(null!=(t=e.baseURL)?t:e.baseUrl))?n:"https://openrouter.ai/api/v1",o=null!=(r=e.compatibility)?r:"compatible",a=()=>da({Authorization:`Bearer ${$e({apiKey:e.apiKey,environmentVariableName:"OPENROUTER_API_KEY",description:"OpenRouter"})}`},e.headers),i=(t,n={})=>new Ia(t,n,{provider:"openrouter.chat",url:({path:e})=>`${s}${e}`,headers:a,compatibility:o,fetch:e.fetch,extraBody:e.extraBody}),l=(t,n={})=>new Ra(t,n,{provider:"openrouter.completion",url:({path:e})=>`${s}${e}`,headers:a,compatibility:o,fetch:e.fetch,extraBody:e.extraBody}),u=(e,t)=>{if(new.target)throw new Error("The OpenRouter model function cannot be called with the new keyword.");return"openai/gpt-3.5-turbo-instruct"===e?l(e,t):i(e,t)},c=(e,t)=>u(e,t);return c.languageModel=u,c.chat=i,c.completion=l,c}ja({compatibility:"strict"});class Ma{constructor(e,t,n,r){this.llms=e,this.names=t||[],this.stream_first_timeout=n||3e4,this.stream_token_timeout=r||18e4,-1==this.names.indexOf("default")&&this.names.push("default")}async call(e){return await this.doGenerate({inputFormat:"messages",mode:{type:"regular",tools:e.tools,toolChoice:e.toolChoice},prompt:e.messages,maxTokens:e.maxTokens,temperature:e.temperature,topP:e.topP,topK:e.topK,stopSequences:e.stopSequences,abortSignal:e.abortSignal})}async doGenerate(e){const t=e.maxTokens,n=e.providerMetadata,r=[...this.names,...this.names];let o;for(let a=0;a<r.length;a++){const i=r[a],l=this.llms[i],u=await this.getLLM(i);if(!u)continue;t||(e.maxTokens=l.config?.maxTokens||16e3),n||(e.providerMetadata={},e.providerMetadata[u.provider]=l.options||{});let c=e;l.handler&&(c=await l.handler(c));try{let e=await u.doGenerate(c);return s.isEnableDebug()&&s.debug(`LLM nonstream body, name: ${i} => `,e.request?.body),e.llm=i,e.llmConfig=l,e}catch(e){if("AbortError"===e?.name)throw e;o=e,s.isEnableInfo()&&s.info(`LLM nonstream request, name: ${i} => `,{tools:c.mode?.tools,messages:c.prompt}),s.error(`LLM error, name: ${i} => `,e)}}return Promise.reject(o||new Error("No LLM available"))}async callStream(e){return await this.doStream({inputFormat:"messages",mode:{type:"regular",tools:e.tools,toolChoice:e.toolChoice},prompt:e.messages,maxTokens:e.maxTokens,temperature:e.temperature,topP:e.topP,topK:e.topK,stopSequences:e.stopSequences,abortSignal:e.abortSignal})}async doStream(e){const t=e.maxTokens,n=e.providerMetadata,r=[...this.names,...this.names];let o;for(let a=0;a<r.length;a++){const l=r[a],u=this.llms[l],c=await this.getLLM(l);if(!c)continue;t||(e.maxTokens=u.config?.maxTokens||16e3),n||(e.providerMetadata={},e.providerMetadata[c.provider]=u.options||{});let d=e;u.handler&&(d=await u.handler(d));try{const e=new AbortController,t=d.abortSignal?AbortSignal.any([d.abortSignal,e.signal]):e.signal,n=await i(async()=>await c.doStream({...d,abortSignal:t}),this.stream_first_timeout,t=>{e.abort()}),r=n.stream.getReader(),{done:o,value:a}=await i(async()=>await r.read(),this.stream_first_timeout,t=>{r.cancel(),r.releaseLock(),e.abort()});if(o){s.warn(`LLM stream done, name: ${l} => `,{done:o,value:a}),r.releaseLock();continue}s.isEnableDebug()&&s.debug(`LLM stream body, name: ${l} => `,n.request?.body);let p=a;if("error"==p.type){s.error(`LLM stream error, name: ${l}`,p),r.releaseLock();continue}return n.llm=l,n.llmConfig=u,n.stream=this.streamWrapper([p],r,e),n}catch(e){if("AbortError"===e?.name)throw e;o=e,s.isEnableInfo()&&s.info(`LLM stream request, name: ${l} => `,{tools:d.mode?.tools,messages:d.prompt}),s.error(`LLM error, name: ${l} => `,e)}}return Promise.reject(o||new Error("No LLM available"))}async getLLM(e){const t=this.llms[e];if(!t)return null;let n,r;if(n="string"==typeof t.apiKey?t.apiKey:await t.apiKey(),t.config?.baseURL&&(r="string"==typeof t.config.baseURL?t.config.baseURL:await t.config.baseURL()),"openai"==t.provider)return vs({apiKey:n,baseURL:r,fetch:t.fetch,organization:t.config?.organization,project:t.config?.project,headers:t.config?.headers,compatibility:t.config?.compatibility}).languageModel(t.model);if("anthropic"==t.provider)return Ms({apiKey:n,baseURL:r,fetch:t.fetch,headers:t.config?.headers}).languageModel(t.model);if("google"==t.provider)return no({apiKey:n,baseURL:r,fetch:t.fetch,headers:t.config?.headers}).languageModel(t.model);if("aws"==t.provider){let e=n.split("=");return ra({accessKeyId:e[0],secretAccessKey:e[1],baseURL:r,region:t.config?.region||"us-west-1",fetch:t.fetch,headers:t.config?.headers,sessionToken:t.config?.sessionToken}).languageModel(t.model)}return"openrouter"==t.provider?ja({apiKey:n,baseURL:r,fetch:t.fetch,headers:t.config?.headers,compatibility:t.config?.compatibility}).languageModel(t.model):t.provider.languageModel(t.model)}streamWrapper(e,t,n){let r=null;return new ReadableStream({start:t=>{if(null!=e&&e.length>0)for(let n=0;n<e.length;n++)t.enqueue(e[n])},pull:async e=>{r=setTimeout(()=>{n.abort("Streaming request timeout")},this.stream_token_timeout);const{done:s,value:o}=await t.read();if(clearTimeout(r),s)return e.close(),void t.releaseLock();e.enqueue(o)},cancel:e=>{r&&clearTimeout(r),t.cancel(e)}})}get Llms(){return this.llms}get Names(){return this.names}}var Pa,Da,$a={},Ua={},qa={};function La(){if(Da)return qa;Da=1;var e=/[A-Z_a-z\xC0-\xD6\xD8-\xF6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,t=new RegExp("[\\-\\.0-9"+e.source.slice(1,-1)+"\\u00B7\\u0300-\\u036F\\u203F-\\u2040]"),n=new RegExp("^"+e.source+t.source+"*(?::"+e.source+t.source+"*)?$");function r(e,t){this.message=e,this.locator=t,Error.captureStackTrace&&Error.captureStackTrace(this,r)}function s(){}function o(e,t){return t.lineNumber=e.lineNumber,t.columnNumber=e.columnNumber,t}function a(e,t,n,r,s,o){function a(e,t,r){e in n.attributeNames&&o.fatalError("Attribute "+e+" redefined"),n.addValue(e,t,r)}for(var i,l=++t,u=0;;){var c=e.charAt(l);switch(c){case"=":if(1===u)i=e.slice(t,l),u=3;else{if(2!==u)throw new Error("attribute equal must after attrName");u=3}break;case"'":case'"':if(3===u||1===u){if(1===u&&(o.warning('attribute value must after "="'),i=e.slice(t,l)),t=l+1,!((l=e.indexOf(c,t))>0))throw new Error("attribute value no end '"+c+"' match");a(i,d=e.slice(t,l).replace(/&#?\w+;/g,s),t-1),u=5}else{if(4!=u)throw new Error('attribute value must after "="');a(i,d=e.slice(t,l).replace(/&#?\w+;/g,s),t),o.warning('attribute "'+i+'" missed start quot('+c+")!!"),t=l+1,u=5}break;case"/":switch(u){case 0:n.setTagName(e.slice(t,l));case 5:case 6:case 7:u=7,n.closed=!0;case 4:case 1:case 2:break;default:throw new Error("attribute invalid close char('/')")}break;case"":return o.error("unexpected end of input"),0==u&&n.setTagName(e.slice(t,l)),l;case">":switch(u){case 0:n.setTagName(e.slice(t,l));case 5:case 6:case 7:break;case 4:case 1:"/"===(d=e.slice(t,l)).slice(-1)&&(n.closed=!0,d=d.slice(0,-1));case 2:2===u&&(d=i),4==u?(o.warning('attribute "'+d+'" missed quot(")!'),a(i,d.replace(/&#?\w+;/g,s),t)):("http://www.w3.org/1999/xhtml"===r[""]&&d.match(/^(?:disabled|checked|selected)$/i)||o.warning('attribute "'+d+'" missed value!! "'+d+'" instead!!'),a(d,d,t));break;case 3:throw new Error("attribute value missed!!")}return l;case"":c=" ";default:if(c<=" ")switch(u){case 0:n.setTagName(e.slice(t,l)),u=6;break;case 1:i=e.slice(t,l),u=2;break;case 4:var d=e.slice(t,l).replace(/&#?\w+;/g,s);o.warning('attribute "'+d+'" missed quot(")!!'),a(i,d,t);case 5:u=6}else switch(u){case 2:n.tagName,"http://www.w3.org/1999/xhtml"===r[""]&&i.match(/^(?:disabled|checked|selected)$/i)||o.warning('attribute "'+i+'" missed value!! "'+i+'" instead2!!'),a(i,i,t),t=l,u=1;break;case 5:o.warning('attribute space is required"'+i+'"!!');case 6:u=1,t=l;break;case 3:u=4,t=l;break;case 7:throw new Error("elements closed character '/' and '>' must be connected to")}}l++}}function i(e,t,n){for(var r=e.tagName,s=null,o=e.length;o--;){var a=e[o],i=a.qName,l=a.value;if((h=i.indexOf(":"))>0)var u=a.prefix=i.slice(0,h),d=i.slice(h+1),p="xmlns"===u&&d;else d=i,u=null,p="xmlns"===i&&"";a.localName=d,!1!==p&&(null==s&&(s={},c(n,n={})),n[p]=s[p]=l,a.uri="http://www.w3.org/2000/xmlns/",t.startPrefixMapping(p,l))}for(o=e.length;o--;)(u=(a=e[o]).prefix)&&("xml"===u&&(a.uri="http://www.w3.org/XML/1998/namespace"),"xmlns"!==u&&(a.uri=n[u||""]));var h;(h=r.indexOf(":"))>0?(u=e.prefix=r.slice(0,h),d=e.localName=r.slice(h+1)):(u=null,d=e.localName=r);var m=e.uri=n[u||""];if(t.startElement(m,d,r,e),!e.closed)return e.currentNSMap=n,e.localNSMap=s,!0;if(t.endElement(m,d,r),s)for(u in s)t.endPrefixMapping(u)}function l(e,t,n,r,s){if(/^(?:script|textarea)$/i.test(n)){var o=e.indexOf("</"+n+">",t),a=e.substring(t+1,o);if(/[&<]/.test(a))return/^script$/i.test(n)?(s.characters(a,0,a.length),o):(a=a.replace(/&#?\w+;/g,r),s.characters(a,0,a.length),o)}return t+1}function u(e,t,n,r){var s=r[n];return null==s&&((s=e.lastIndexOf("</"+n+">"))<t&&(s=e.lastIndexOf("</"+n)),r[n]=s),s<t}function c(e,t){for(var n in e)t[n]=e[n]}function d(e,t,n,r){if("-"===e.charAt(t+2))return"-"===e.charAt(t+3)?(s=e.indexOf("--\x3e",t+4))>t?(n.comment(e,t+4,s-t-4),s+3):(r.error("Unclosed comment"),-1):-1;if("CDATA["==e.substr(t+3,6)){var s=e.indexOf("]]>",t+9);return n.startCDATA(),n.characters(e,t+9,s-t-9),n.endCDATA(),s+3}var o=function(e,t){var n,r=[],s=/'[^']+'|"[^"]+"|[^\s<>\/=]+=?|(\/?\s*>|<)/g;for(s.lastIndex=t,s.exec(e);n=s.exec(e);)if(r.push(n),n[1])return r}(e,t),a=o.length;if(a>1&&/!doctype/i.test(o[0][0])){var i=o[1][0],l=!1,u=!1;a>3&&(/^public$/i.test(o[2][0])?(l=o[3][0],u=a>4&&o[4][0]):/^system$/i.test(o[2][0])&&(u=o[3][0]));var c=o[a-1];return n.startDTD(i,l,u),n.endDTD(),c.index+c[0].length}return-1}function p(e,t,n){var r=e.indexOf("?>",t);if(r){var s=e.substring(t,r).match(/^<\?(\S*)\s*([\s\S]*?)\s*$/);return s?(s[0].length,n.processingInstruction(s[1],s[2]),r+2):-1}return-1}function h(){this.attributeNames={}}return r.prototype=new Error,r.prototype.name=r.name,s.prototype={parse:function(e,t,n){var s=this.domBuilder;s.startDocument(),c(t,t={}),function(e,t,n,s,c){function m(e){var t=e.slice(1,-1);return t in n?n[t]:"#"===t.charAt(0)?function(e){if(e>65535){var t=55296+((e-=65536)>>10),n=56320+(1023&e);return String.fromCharCode(t,n)}return String.fromCharCode(e)}(parseInt(t.substr(1).replace("x","0x"))):(c.error("entity not found:"+e),e)}function g(t){if(t>k){var n=e.substring(k,t).replace(/&#?\w+;/g,m);w&&f(k),s.characters(n,0,t-k),k=t}}function f(t,n){for(;t>=b&&(n=v.exec(e));)y=n.index,b=y+n[0].length,w.lineNumber++;w.columnNumber=t-y+1}for(var y=0,b=0,v=/.*(?:\r\n?|\n)|.*$/g,w=s.locator,_=[{currentNSMap:t}],x={},k=0;;){try{var T=e.indexOf("<",k);if(T<0){if(!e.substr(k).match(/^\s*$/)){var N=s.doc,I=N.createTextNode(e.substr(k));N.appendChild(I),s.currentElement=I}return}switch(T>k&&g(T),e.charAt(T+1)){case"/":var E=e.indexOf(">",T+3),C=e.substring(T+2,E),S=_.pop();E<0?(C=e.substring(T+2).replace(/[\s<].*/,""),c.error("end tag name: "+C+" is not complete:"+S.tagName),E=T+1+C.length):C.match(/\s</)&&(C=C.replace(/[\s<].*/,""),c.error("end tag name: "+C+" maybe not complete"),E=T+1+C.length);var A=S.localNSMap,R=S.tagName==C;if(R||S.tagName&&S.tagName.toLowerCase()==C.toLowerCase()){if(s.endElement(S.uri,S.localName,C),A)for(var O in A)s.endPrefixMapping(O);R||c.fatalError("end tag name: "+C+" is not match the current start tagName:"+S.tagName)}else _.push(S);E++;break;case"?":w&&f(T),E=p(e,T,s);break;case"!":w&&f(T),E=d(e,T,s,c);break;default:w&&f(T);var j=new h,M=_[_.length-1].currentNSMap,P=(E=a(e,T,j,M,m,c),j.length);if(!j.closed&&u(e,E,j.tagName,x)&&(j.closed=!0,n.nbsp||c.warning("unclosed xml attribute")),w&&P){for(var D=o(w,{}),$=0;$<P;$++){var U=j[$];f(U.offset),U.locator=o(w,{})}s.locator=D,i(j,s,M)&&_.push(j),s.locator=w}else i(j,s,M)&&_.push(j);"http://www.w3.org/1999/xhtml"!==j.uri||j.closed?E++:E=l(e,E,j.tagName,m,s)}}catch(e){if(e instanceof r)throw e;c.error("element parse error: "+e),E=-1}E>k?k=E:g(Math.max(T,k)+1)}}(e,t,n,s,this.errorHandler),s.endDocument()}},h.prototype={setTagName:function(e){if(!n.test(e))throw new Error("invalid tagName:"+e);this.tagName=e},addValue:function(e,t,r){if(!n.test(e))throw new Error("invalid attribute:"+e);this.attributeNames[e]=this.length,this[this.length++]={qName:e,value:t,offset:r}},length:0,getLocalName:function(e){return this[e].localName},getLocator:function(e){return this[e].locator},getQName:function(e){return this[e].qName},getURI:function(e){return this[e].uri},getValue:function(e){return this[e].value}},qa.XMLReader=s,qa.ParseError=r,qa}var Fa,Ba,Ha={};function Za(){if(Fa)return Ha;function e(e,t){for(var n in e)t[n]=e[n]}function t(t,n){var r=t.prototype;if(!(r instanceof n)){function s(){}s.prototype=n.prototype,e(r,s=new s),t.prototype=r=s}r.constructor!=t&&("function"!=typeof t&&console.error("unknow Class:"+t),r.constructor=t)}Fa=1;var n={},r=n.ELEMENT_NODE=1,s=n.ATTRIBUTE_NODE=2,o=n.TEXT_NODE=3,a=n.CDATA_SECTION_NODE=4,i=n.ENTITY_REFERENCE_NODE=5,l=n.ENTITY_NODE=6,u=n.PROCESSING_INSTRUCTION_NODE=7,c=n.COMMENT_NODE=8,d=n.DOCUMENT_NODE=9,p=n.DOCUMENT_TYPE_NODE=10,h=n.DOCUMENT_FRAGMENT_NODE=11,m=n.NOTATION_NODE=12,g={},f={};g.INDEX_SIZE_ERR=(f[1]="Index size error",1),g.DOMSTRING_SIZE_ERR=(f[2]="DOMString size error",2);var y=g.HIERARCHY_REQUEST_ERR=(f[3]="Hierarchy request error",3);g.WRONG_DOCUMENT_ERR=(f[4]="Wrong document",4),g.INVALID_CHARACTER_ERR=(f[5]="Invalid character",5),g.NO_DATA_ALLOWED_ERR=(f[6]="No data allowed",6),g.NO_MODIFICATION_ALLOWED_ERR=(f[7]="No modification allowed",7);var b=g.NOT_FOUND_ERR=(f[8]="Not found",8);g.NOT_SUPPORTED_ERR=(f[9]="Not supported",9);var v=g.INUSE_ATTRIBUTE_ERR=(f[10]="Attribute in use",10);function w(e,t){if(t instanceof Error)var n=t;else n=this,Error.call(this,f[e]),this.message=f[e],Error.captureStackTrace&&Error.captureStackTrace(this,w);return n.code=e,t&&(this.message=this.message+": "+t),n}function _(){}function x(e,t){this._node=e,this._refresh=t,k(this)}function k(t){var n=t._node._inc||t._node.ownerDocument._inc;if(t._inc!=n){var r=t._refresh(t._node);te(t,"length",r.length),e(r,t),t._inc=n}}function T(){}function N(e,t){for(var n=e.length;n--;)if(e[n]===t)return n}function I(e,t,n,r){if(r?t[N(t,r)]=n:t[t.length++]=n,e){n.ownerElement=e;var s=e.ownerDocument;s&&(r&&j(s,e,r),function(e,t,n){e&&e._inc++,"http://www.w3.org/2000/xmlns/"==n.namespaceURI&&(t._nsMap[n.prefix?n.localName:""]=n.value)}(s,e,n))}}function E(e,t,n){var r=N(t,n);if(!(r>=0))throw w(b,new Error(e.tagName+"@"+n));for(var s=t.length-1;r<s;)t[r]=t[++r];if(t.length=s,e){var o=e.ownerDocument;o&&(j(o,e,n),n.ownerElement=null)}}function C(e){if(this._features={},e)for(var t in e)this._features=e[t]}function S(){}function A(e){return("<"==e?"&lt;":">"==e&&"&gt;")||"&"==e&&"&amp;"||'"'==e&&"&quot;"||"&#"+e.charCodeAt()+";"}function R(e,t){if(t(e))return!0;if(e=e.firstChild)do{if(R(e,t))return!0}while(e=e.nextSibling)}function O(){}function j(e,t,n,r){e&&e._inc++,"http://www.w3.org/2000/xmlns/"==n.namespaceURI&&delete t._nsMap[n.prefix?n.localName:""]}function M(e,t,n){if(e&&e._inc){e._inc++;var r=t.childNodes;if(n)r[r.length++]=n;else{for(var s=t.firstChild,o=0;s;)r[o++]=s,s=s.nextSibling;r.length=o}}}function P(e,t){var n=t.previousSibling,r=t.nextSibling;return n?n.nextSibling=r:e.firstChild=r,r?r.previousSibling=n:e.lastChild=n,M(e.ownerDocument,e),t}function D(e,t,n){var r=t.parentNode;if(r&&r.removeChild(t),t.nodeType===h){var s=t.firstChild;if(null==s)return t;var o=t.lastChild}else s=o=t;var a=n?n.previousSibling:e.lastChild;s.previousSibling=a,o.nextSibling=n,a?a.nextSibling=s:e.firstChild=s,null==n?e.lastChild=o:n.previousSibling=o;do{s.parentNode=e}while(s!==o&&(s=s.nextSibling));return M(e.ownerDocument||e,e),t.nodeType==h&&(t.firstChild=t.lastChild=null),t}function $(){this._nsMap={}}function U(){}function q(){}function L(){}function F(){}function B(){}function H(){}function Z(){}function W(){}function V(){}function z(){}function G(){}function K(){}function J(e,t){var n=[],r=9==this.nodeType&&this.documentElement||this,s=r.prefix,o=r.namespaceURI;if(o&&null==s&&null==(s=r.lookupPrefix(o)))var a=[{namespace:o,prefix:null}];return Y(this,n,e,t,a),n.join("")}function X(e,t,n){var r=e.prefix||"",s=e.namespaceURI;if(!r&&!s)return!1;if("xml"===r&&"http://www.w3.org/XML/1998/namespace"===s||"http://www.w3.org/2000/xmlns/"==s)return!1;for(var o=n.length;o--;){var a=n[o];if(a.prefix==r)return a.namespace!=s}return!0}function Y(e,t,n,l,m){if(l){if(!(e=l(e)))return;if("string"==typeof e)return void t.push(e)}switch(e.nodeType){case r:m||(m=[]),m.length;var g=e.attributes,f=g.length,y=e.firstChild,b=e.tagName;n="http://www.w3.org/1999/xhtml"===e.namespaceURI||n,t.push("<",b);for(var v=0;v<f;v++)"xmlns"==(w=g.item(v)).prefix?m.push({prefix:w.localName,namespace:w.value}):"xmlns"==w.nodeName&&m.push({prefix:"",namespace:w.value});for(v=0;v<f;v++){var w;if(X(w=g.item(v),0,m)){var _=w.prefix||"",x=w.namespaceURI,k=_?" xmlns:"+_:" xmlns";t.push(k,'="',x,'"'),m.push({prefix:_,namespace:x})}Y(w,t,n,l,m)}if(X(e,0,m)&&(_=e.prefix||"",(x=e.namespaceURI)&&(k=_?" xmlns:"+_:" xmlns",t.push(k,'="',x,'"'),m.push({prefix:_,namespace:x}))),y||n&&!/^(?:meta|link|img|br|hr|input)$/i.test(b)){if(t.push(">"),n&&/^script$/i.test(b))for(;y;)y.data?t.push(y.data):Y(y,t,n,l,m),y=y.nextSibling;else for(;y;)Y(y,t,n,l,m),y=y.nextSibling;t.push("</",b,">")}else t.push("/>");return;case d:case h:for(y=e.firstChild;y;)Y(y,t,n,l,m),y=y.nextSibling;return;case s:return t.push(" ",e.name,'="',e.value.replace(/[<&"]/g,A),'"');case o:return t.push(e.data.replace(/[<&]/g,A).replace(/]]>/g,"]]&gt;"));case a:return t.push("<![CDATA[",e.data,"]]>");case c:return t.push("\x3c!--",e.data,"--\x3e");case p:var T=e.publicId,N=e.systemId;if(t.push("<!DOCTYPE ",e.name),T)t.push(" PUBLIC ",T),N&&"."!=N&&t.push(" ",N),t.push(">");else if(N&&"."!=N)t.push(" SYSTEM ",N,">");else{var I=e.internalSubset;I&&t.push(" [",I,"]"),t.push(">")}return;case u:return t.push("<?",e.target," ",e.data,"?>");case i:return t.push("&",e.nodeName,";");default:t.push("??",e.nodeName)}}function Q(e,t,n){var o;switch(t.nodeType){case r:(o=t.cloneNode(!1)).ownerDocument=e;case h:break;case s:n=!0}if(o||(o=t.cloneNode(!1)),o.ownerDocument=e,o.parentNode=null,n)for(var a=t.firstChild;a;)o.appendChild(Q(e,a,n)),a=a.nextSibling;return o}function ee(e,t,n){var o=new t.constructor;for(var a in t){var i=t[a];"object"!=typeof i&&i!=o[a]&&(o[a]=i)}switch(t.childNodes&&(o.childNodes=new _),o.ownerDocument=e,o.nodeType){case r:var l=t.attributes,u=o.attributes=new T,c=l.length;u._ownerElement=o;for(var d=0;d<c;d++)o.setAttributeNode(ee(e,l.item(d),!0));break;case s:n=!0}if(n)for(var p=t.firstChild;p;)o.appendChild(ee(e,p,n)),p=p.nextSibling;return o}function te(e,t,n){e[t]=n}g.INVALID_STATE_ERR=(f[11]="Invalid state",11),g.SYNTAX_ERR=(f[12]="Syntax error",12),g.INVALID_MODIFICATION_ERR=(f[13]="Invalid modification",13),g.NAMESPACE_ERR=(f[14]="Invalid namespace",14),g.INVALID_ACCESS_ERR=(f[15]="Invalid access",15),w.prototype=Error.prototype,e(g,w),_.prototype={length:0,item:function(e){return this[e]||null},toString:function(e,t){for(var n=[],r=0;r<this.length;r++)Y(this[r],n,e,t);return n.join("")}},x.prototype.item=function(e){return k(this),this[e]},t(x,_),T.prototype={length:0,item:_.prototype.item,getNamedItem:function(e){for(var t=this.length;t--;){var n=this[t];if(n.nodeName==e)return n}},setNamedItem:function(e){var t=e.ownerElement;if(t&&t!=this._ownerElement)throw new w(v);var n=this.getNamedItem(e.nodeName);return I(this._ownerElement,this,e,n),n},setNamedItemNS:function(e){var t,n=e.ownerElement;if(n&&n!=this._ownerElement)throw new w(v);return t=this.getNamedItemNS(e.namespaceURI,e.localName),I(this._ownerElement,this,e,t),t},removeNamedItem:function(e){var t=this.getNamedItem(e);return E(this._ownerElement,this,t),t},removeNamedItemNS:function(e,t){var n=this.getNamedItemNS(e,t);return E(this._ownerElement,this,n),n},getNamedItemNS:function(e,t){for(var n=this.length;n--;){var r=this[n];if(r.localName==t&&r.namespaceURI==e)return r}return null}},C.prototype={hasFeature:function(e,t){var n=this._features[e.toLowerCase()];return!(!n||t&&!(t in n))},createDocument:function(e,t,n){var r=new O;if(r.implementation=this,r.childNodes=new _,r.doctype=n,n&&r.appendChild(n),t){var s=r.createElementNS(e,t);r.appendChild(s)}return r},createDocumentType:function(e,t,n){var r=new H;return r.name=e,r.nodeName=e,r.publicId=t,r.systemId=n,r}},S.prototype={firstChild:null,lastChild:null,previousSibling:null,nextSibling:null,attributes:null,parentNode:null,childNodes:null,ownerDocument:null,nodeValue:null,namespaceURI:null,prefix:null,localName:null,insertBefore:function(e,t){return D(this,e,t)},replaceChild:function(e,t){this.insertBefore(e,t),t&&this.removeChild(t)},removeChild:function(e){return P(this,e)},appendChild:function(e){return this.insertBefore(e,null)},hasChildNodes:function(){return null!=this.firstChild},cloneNode:function(e){return ee(this.ownerDocument||this,this,e)},normalize:function(){for(var e=this.firstChild;e;){var t=e.nextSibling;t&&t.nodeType==o&&e.nodeType==o?(this.removeChild(t),e.appendData(t.data)):(e.normalize(),e=t)}},isSupported:function(e,t){return this.ownerDocument.implementation.hasFeature(e,t)},hasAttributes:function(){return this.attributes.length>0},lookupPrefix:function(e){for(var t=this;t;){var n=t._nsMap;if(n)for(var r in n)if(n[r]==e)return r;t=t.nodeType==s?t.ownerDocument:t.parentNode}return null},lookupNamespaceURI:function(e){for(var t=this;t;){var n=t._nsMap;if(n&&e in n)return n[e];t=t.nodeType==s?t.ownerDocument:t.parentNode}return null},isDefaultNamespace:function(e){return null==this.lookupPrefix(e)}},e(n,S),e(n,S.prototype),O.prototype={nodeName:"#document",nodeType:d,doctype:null,documentElement:null,_inc:1,insertBefore:function(e,t){if(e.nodeType==h){for(var n=e.firstChild;n;){var s=n.nextSibling;this.insertBefore(n,t),n=s}return e}return null==this.documentElement&&e.nodeType==r&&(this.documentElement=e),D(this,e,t),e.ownerDocument=this,e},removeChild:function(e){return this.documentElement==e&&(this.documentElement=null),P(this,e)},importNode:function(e,t){return Q(this,e,t)},getElementById:function(e){var t=null;return R(this.documentElement,function(n){if(n.nodeType==r&&n.getAttribute("id")==e)return t=n,!0}),t},getElementsByClassName:function(e){var t=new RegExp("(^|\\s)"+e+"(\\s|$)");return new x(this,function(e){var n=[];return R(e.documentElement,function(s){s!==e&&s.nodeType==r&&t.test(s.getAttribute("class"))&&n.push(s)}),n})},createElement:function(e){var t=new $;return t.ownerDocument=this,t.nodeName=e,t.tagName=e,t.childNodes=new _,(t.attributes=new T)._ownerElement=t,t},createDocumentFragment:function(){var e=new z;return e.ownerDocument=this,e.childNodes=new _,e},createTextNode:function(e){var t=new L;return t.ownerDocument=this,t.appendData(e),t},createComment:function(e){var t=new F;return t.ownerDocument=this,t.appendData(e),t},createCDATASection:function(e){var t=new B;return t.ownerDocument=this,t.appendData(e),t},createProcessingInstruction:function(e,t){var n=new G;return n.ownerDocument=this,n.tagName=n.target=e,n.nodeValue=n.data=t,n},createAttribute:function(e){var t=new U;return t.ownerDocument=this,t.name=e,t.nodeName=e,t.localName=e,t.specified=!0,t},createEntityReference:function(e){var t=new V;return t.ownerDocument=this,t.nodeName=e,t},createElementNS:function(e,t){var n=new $,r=t.split(":"),s=n.attributes=new T;return n.childNodes=new _,n.ownerDocument=this,n.nodeName=t,n.tagName=t,n.namespaceURI=e,2==r.length?(n.prefix=r[0],n.localName=r[1]):n.localName=t,s._ownerElement=n,n},createAttributeNS:function(e,t){var n=new U,r=t.split(":");return n.ownerDocument=this,n.nodeName=t,n.name=t,n.namespaceURI=e,n.specified=!0,2==r.length?(n.prefix=r[0],n.localName=r[1]):n.localName=t,n}},t(O,S),$.prototype={nodeType:r,hasAttribute:function(e){return null!=this.getAttributeNode(e)},getAttribute:function(e){var t=this.getAttributeNode(e);return t&&t.value||""},getAttributeNode:function(e){return this.attributes.getNamedItem(e)},setAttribute:function(e,t){var n=this.ownerDocument.createAttribute(e);n.value=n.nodeValue=""+t,this.setAttributeNode(n)},removeAttribute:function(e){var t=this.getAttributeNode(e);t&&this.removeAttributeNode(t)},appendChild:function(e){return e.nodeType===h?this.insertBefore(e,null):function(e,t){var n=t.parentNode;if(n){var r=e.lastChild;n.removeChild(t),r=e.lastChild}return r=e.lastChild,t.parentNode=e,t.previousSibling=r,t.nextSibling=null,r?r.nextSibling=t:e.firstChild=t,e.lastChild=t,M(e.ownerDocument,e,t),t}(this,e)},setAttributeNode:function(e){return this.attributes.setNamedItem(e)},setAttributeNodeNS:function(e){return this.attributes.setNamedItemNS(e)},removeAttributeNode:function(e){return this.attributes.removeNamedItem(e.nodeName)},removeAttributeNS:function(e,t){var n=this.getAttributeNodeNS(e,t);n&&this.removeAttributeNode(n)},hasAttributeNS:function(e,t){return null!=this.getAttributeNodeNS(e,t)},getAttributeNS:function(e,t){var n=this.getAttributeNodeNS(e,t);return n&&n.value||""},setAttributeNS:function(e,t,n){var r=this.ownerDocument.createAttributeNS(e,t);r.value=r.nodeValue=""+n,this.setAttributeNode(r)},getAttributeNodeNS:function(e,t){return this.attributes.getNamedItemNS(e,t)},getElementsByTagName:function(e){return new x(this,function(t){var n=[];return R(t,function(s){s===t||s.nodeType!=r||"*"!==e&&s.tagName!=e||n.push(s)}),n})},getElementsByTagNameNS:function(e,t){return new x(this,function(n){var s=[];return R(n,function(o){o===n||o.nodeType!==r||"*"!==e&&o.namespaceURI!==e||"*"!==t&&o.localName!=t||s.push(o)}),s})}},O.prototype.getElementsByTagName=$.prototype.getElementsByTagName,O.prototype.getElementsByTagNameNS=$.prototype.getElementsByTagNameNS,t($,S),U.prototype.nodeType=s,t(U,S),q.prototype={data:"",substringData:function(e,t){return this.data.substring(e,e+t)},appendData:function(e){e=this.data+e,this.nodeValue=this.data=e,this.length=e.length},insertData:function(e,t){this.replaceData(e,0,t)},appendChild:function(e){throw new Error(f[y])},deleteData:function(e,t){this.replaceData(e,t,"")},replaceData:function(e,t,n){n=this.data.substring(0,e)+n+this.data.substring(e+t),this.nodeValue=this.data=n,this.length=n.length}},t(q,S),L.prototype={nodeName:"#text",nodeType:o,splitText:function(e){var t=this.data,n=t.substring(e);t=t.substring(0,e),this.data=this.nodeValue=t,this.length=t.length;var r=this.ownerDocument.createTextNode(n);return this.parentNode&&this.parentNode.insertBefore(r,this.nextSibling),r}},t(L,q),F.prototype={nodeName:"#comment",nodeType:c},t(F,q),B.prototype={nodeName:"#cdata-section",nodeType:a},t(B,q),H.prototype.nodeType=p,t(H,S),Z.prototype.nodeType=m,t(Z,S),W.prototype.nodeType=l,t(W,S),V.prototype.nodeType=i,t(V,S),z.prototype.nodeName="#document-fragment",z.prototype.nodeType=h,t(z,S),G.prototype.nodeType=u,t(G,S),K.prototype.serializeToString=function(e,t,n){return J.call(e,t,n)},S.prototype.toString=J;try{if(Object.defineProperty){function ne(e){switch(e.nodeType){case r:case h:var t=[];for(e=e.firstChild;e;)7!==e.nodeType&&8!==e.nodeType&&t.push(ne(e)),e=e.nextSibling;return t.join("");default:return e.nodeValue}}Object.defineProperty(x.prototype,"length",{get:function(){return k(this),this.$$length}}),Object.defineProperty(S.prototype,"textContent",{get:function(){return ne(this)},set:function(e){switch(this.nodeType){case r:case h:for(;this.firstChild;)this.removeChild(this.firstChild);(e||String(e))&&this.appendChild(this.ownerDocument.createTextNode(e));break;default:this.data=e,this.value=e,this.nodeValue=e}}}),te=function(e,t,n){e["$$"+t]=n}}}catch(re){}return Ha.Node=S,Ha.DOMException=w,Ha.DOMImplementation=C,Ha.XMLSerializer=K,Ha}var Wa=function(){if(Ba)return $a;function e(e){this.options=e||{locator:{}}}function t(){this.cdata=!1}function n(e,t){t.lineNumber=e.lineNumber,t.columnNumber=e.columnNumber}function r(e){if(e)return"\n@"+(e.systemId||"")+"#[line:"+e.lineNumber+",col:"+e.columnNumber+"]"}function s(e,t,n){return"string"==typeof e?e.substr(t,n):e.length>=t+n||t?new java.lang.String(e,t,n)+"":e}function o(e,t){e.currentElement?e.currentElement.appendChild(t):e.doc.appendChild(t)}Ba=1,e.prototype.parseFromString=function(e,n){var s=this.options,o=new l,i=s.domBuilder||new t,u=s.errorHandler,c=s.locator,d=s.xmlns||{},p=/\/x?html?$/.test(n),h=p?a.entityMap:{lt:"<",gt:">",amp:"&",quot:'"',apos:"'"};return c&&i.setDocumentLocator(c),o.errorHandler=function(e,n,s){if(!e){if(n instanceof t)return n;e=n}var o={},a=e instanceof Function;function i(t){var n=e[t];!n&&a&&(n=2==e.length?function(n){e(t,n)}:e),o[t]=n&&function(e){n("[xmldom "+t+"]\t"+e+r(s))}||function(){}}return s=s||{},i("warning"),i("error"),i("fatalError"),o}(u,i,c),o.domBuilder=s.domBuilder||i,p&&(d[""]="http://www.w3.org/1999/xhtml"),d.xml=d.xml||"http://www.w3.org/XML/1998/namespace",e&&"string"==typeof e?o.parse(e,d,h):o.errorHandler.error("invalid doc source"),i.doc},t.prototype={startDocument:function(){this.doc=(new c).createDocument(null,null,null),this.locator&&(this.doc.documentURI=this.locator.systemId)},startElement:function(e,t,r,s){var a=this.doc,i=a.createElementNS(e,r||t),l=s.length;o(this,i),this.currentElement=i,this.locator&&n(this.locator,i);for(var u=0;u<l;u++){e=s.getURI(u);var c=s.getValue(u),d=(r=s.getQName(u),a.createAttributeNS(e,r));this.locator&&n(s.getLocator(u),d),d.value=d.nodeValue=c,i.setAttributeNode(d)}},endElement:function(e,t,n){var r=this.currentElement;r.tagName,this.currentElement=r.parentNode},startPrefixMapping:function(e,t){},endPrefixMapping:function(e){},processingInstruction:function(e,t){var r=this.doc.createProcessingInstruction(e,t);this.locator&&n(this.locator,r),o(this,r)},ignorableWhitespace:function(e,t,n){},characters:function(e,t,r){if(e=s.apply(this,arguments)){if(this.cdata)var o=this.doc.createCDATASection(e);else o=this.doc.createTextNode(e);this.currentElement?this.currentElement.appendChild(o):/^\s*$/.test(e)&&this.doc.appendChild(o),this.locator&&n(this.locator,o)}},skippedEntity:function(e){},endDocument:function(){this.doc.normalize()},setDocumentLocator:function(e){(this.locator=e)&&(e.lineNumber=0)},comment:function(e,t,r){e=s.apply(this,arguments);var a=this.doc.createComment(e);this.locator&&n(this.locator,a),o(this,a)},startCDATA:function(){this.cdata=!0},endCDATA:function(){this.cdata=!1},startDTD:function(e,t,r){var s=this.doc.implementation;if(s&&s.createDocumentType){var a=s.createDocumentType(e,t,r);this.locator&&n(this.locator,a),o(this,a)}},warning:function(e){console.warn("[xmldom warning]\t"+e,r(this.locator))},error:function(e){console.error("[xmldom error]\t"+e,r(this.locator))},fatalError:function(e){throw new u(e,this.locator)}},"endDTD,startEntity,endEntity,attributeDecl,elementDecl,externalEntityDecl,internalEntityDecl,resolveEntity,getExternalSubset,notationDecl,unparsedEntityDecl".replace(/\w+/g,function(e){t.prototype[e]=function(){return null}});var a=(Pa||(Pa=1,Ua.entityMap={lt:"<",gt:">",amp:"&",quot:'"',apos:"'",Agrave:"",Aacute:"",Acirc:"",Atilde:"",Auml:"",Aring:"",AElig:"",Ccedil:"",Egrave:"",Eacute:"",Ecirc:"",Euml:"",Igrave:"",Iacute:"",Icirc:"",Iuml:"",ETH:"",Ntilde:"",Ograve:"",Oacute:"",Ocirc:"",Otilde:"",Ouml:"",Oslash:"",Ugrave:"",Uacute:"",Ucirc:"",Uuml:"",Yacute:"",THORN:"",szlig:"",agrave:"",aacute:"",acirc:"",atilde:"",auml:"",aring:"",aelig:"",ccedil:"",egrave:"",eacute:"",ecirc:"",euml:"",igrave:"",iacute:"",icirc:"",iuml:"",eth:"",ntilde:"",ograve:"",oacute:"",ocirc:"",otilde:"",ouml:"",oslash:"",ugrave:"",uacute:"",ucirc:"",uuml:"",yacute:"",thorn:"",yuml:"",nbsp:"",iexcl:"",cent:"",pound:"",curren:"",yen:"",brvbar:"",sect:"",uml:"",copy:"",ordf:"",laquo:"",not:"",shy:"",reg:"",macr:"",deg:"",plusmn:"",sup2:"",sup3:"",acute:"",micro:"",para:"",middot:"",cedil:"",sup1:"",ordm:"",raquo:"",frac14:"",frac12:"",frac34:"",iquest:"",times:"",divide:"",forall:"",part:"",exist:"",empty:"",nabla:"",isin:"",notin:"",ni:"",prod:"",sum:"",minus:"",lowast:"",radic:"",prop:"",infin:"",ang:"",and:"",or:"",cap:"",cup:"",int:"",there4:"",sim:"",cong:"",asymp:"",ne:"",equiv:"",le:"",ge:"",sub:"",sup:"",nsub:"",sube:"",supe:"",oplus:"",otimes:"",perp:"",sdot:"",Alpha:"",Beta:"",Gamma:"",Delta:"",Epsilon:"",Zeta:"",Eta:"",Theta:"",Iota:"",Kappa:"",Lambda:"",Mu:"",Nu:"",Xi:"",Omicron:"",Pi:"",Rho:"",Sigma:"",Tau:"",Upsilon:"",Phi:"",Chi:"",Psi:"",Omega:"",alpha:"",beta:"",gamma:"",delta:"",epsilon:"",zeta:"",eta:"",theta:"",iota:"",kappa:"",lambda:"",mu:"",nu:"",xi:"",omicron:"",pi:"",rho:"",sigmaf:"",sigma:"",tau:"",upsilon:"",phi:"",chi:"",psi:"",omega:"",thetasym:"",upsih:"",piv:"",OElig:"",oelig:"",Scaron:"",scaron:"",Yuml:"",fnof:"",circ:"",tilde:"",ensp:"",emsp:"",thinsp:"",zwnj:"",zwj:"",lrm:"",rlm:"",ndash:"",mdash:"",lsquo:"",rsquo:"",sbquo:"",ldquo:"",rdquo:"",bdquo:"",dagger:"",Dagger:"",bull:"",hellip:"",permil:"",prime:"",Prime:"",lsaquo:"",rsaquo:"",oline:"",euro:"",trade:"",larr:"",uarr:"",rarr:"",darr:"",harr:"",crarr:"",lceil:"",rceil:"",lfloor:"",rfloor:"",loz:"",spades:"",clubs:"",hearts:"",diams:""}),Ua),i=La(),l=i.XMLReader,u=i.ParseError,c=$a.DOMImplementation=Za().DOMImplementation;return $a.XMLSerializer=Za().XMLSerializer,$a.DOMParser=e,$a.__DOMHandler=t,$a}();function Va(e){const t=function(e){const t=new Map,n=new Map,r=new Map;for(const s of e)t.set(s.id,s),n.set(s.id,0),r.set(s.id,[]);for(const s of e)for(const e of s.dependsOn)t.has(e)&&(r.get(e).push(s.id),n.set(s.id,n.get(s.id)+1));const s=[],o=new Map;for(const[e,t]of n.entries())0===t&&s.push(e),o.set(e,0);let a=0;for(;s.length>0;){const e=s.shift();a++;for(const t of r.get(e)){const e=n.get(t)-1;n.set(t,e),0===e&&s.push(t)}}if(a<e.length){console.warn("Detected a circular dependency, automatically disconnecting the circular link...");const r=new Set;for(const[e,t]of n.entries())t>0&&r.add(e);const s=[];for(const n of e)if(r.has(n.id)){const e=n.dependsOn.filter(e=>!r.has(e)||!t.has(e));if(0===e.length&&n.dependsOn.length>0){const s=n.dependsOn.find(e=>t.has(e));s&&!r.has(s)&&e.push(s)}n.dependsOn=e,s.push(n),e.length!==n.dependsOn.length&&console.warn(`The partial cyclic dependency of agent ${n.id} has been disconnected.`)}else{const e=n.dependsOn.filter(e=>t.has(e));n.dependsOn=e,s.push(n)}return s}return e.map(e=>(e.dependsOn=e.dependsOn.filter(e=>t.has(e)),e))}(e);if(0===t.length)throw new Error("No executable agent");const n=new Map,r=new Map;for(const e of t)n.set(e.id,e),r.set(e.id,[]);for(const e of t)for(const t of e.dependsOn)r.has(t)&&r.get(t).push(e);let s=t.filter(e=>0===e.dependsOn.length);0===s.length&&(s=t.filter(e=>1==e.dependsOn.length&&e.dependsOn[0].endsWith("00")));const o=new Set,a=function e(t){if(0===t.length)return;for(const e of t)o.add(e.id);const n=[],s=new Set;for(const e of t){const t=r.get(e.id)||[];for(const e of t)e.dependsOn.every(e=>o.has(e))&&!s.has(e.id)&&(n.push(e),s.add(e.id))}const a=e(n);return 1===t.length?{type:"normal",agent:t[0],nextAgent:a}:{type:"parallel",agents:t.map(e=>({type:"normal",agent:e,nextAgent:void 0})),nextAgent:a}}(s);if(!a)throw new Error("Unable to build execution tree");return a}function za(e,t,n,r){let s=null;try{r&&(s={taskId:e,name:"",thought:r,agents:[],xml:t});let o=t.indexOf("<root>");if(-1==o)return s;let a=(t=t.substring(o)).indexOf("</root>");a>-1&&(t=t.substring(0,a+7)),n||(t=function(e){e.indexOf("&")>-1&&(e=e.replace(/&(?![a-zA-Z0-9#]+;)/g,"&amp;"));let t=e.lastIndexOf(" "),n=t>-1?e.substring(t+1):"";if(e.endsWith("="))e+='""';else if("name"==n||"id"==n||"dependsOn"==n||"input"==n||"output"==n||"items"==n||"event"==n||"loop"==n){let t=e.lastIndexOf(">"),n=e.lastIndexOf("<");t<n&&e.lastIndexOf(" ")>n&&(e+='=""')}e=function(e){const t=[];for(let n=0;n<e.length;n++){let r=e[n];"<"===r?t.push(">"):">"===r?t.pop():'"'===r&&('"'===t[t.length-1]?t.pop():t.push('"'))}const n=[];for(;t.length>0;)n.push(t.pop());return e+n.join("")}(e);const r=[];function s(e){return e.endsWith("/>")}for(let t=0;t<e.length;t++)if("<"===e[t]){const n="/"===e[t+1];let o=e.indexOf(">",t),a=e.slice(t,o+1);if(s(a)||(n?r.pop():r.push(a)),-1==o)break;t=o}const o=[];for(;r.length>0;){const e=r.pop();if(e.startsWith("<")){let t=e.match(/<(\w+)/);if(t){const e=t[1];o.push(`</${e}>`)}}else o.push(e)}return e+o.join("")}(t));let i=(new Wa.DOMParser).parseFromString(t,"text/xml").documentElement;if("root"!==i.tagName)return s;const l=[],u=i.getElementsByTagName("thought")[0]?.textContent||"",c={taskId:e,name:i.getElementsByTagName("name")[0]?.textContent||"",thought:r?r+"\n"+u:u,agents:l,xml:t};let d=i.getElementsByTagName("agents"),p=d.length>0?d[0].getElementsByTagName("agent"):[];for(let t=0;t<p.length;t++){let n=p[t],r=n.getAttribute("name");if(!r)break;let s=n.getAttribute("id")||t,o=n.getAttribute("dependsOn")||"",a=[],i={name:r,id:Ga(e,s),dependsOn:o.split(",").filter(e=>""!=e.trim()).map(t=>Ga(e,t)),task:n.getElementsByTagName("task")[0]?.textContent||"",nodes:a,status:"init",parallel:void 0,xml:n.toString()},u=n.getElementsByTagName("nodes");u.length>0&&Ka(a,u[0].childNodes),l.push(i)}if(n){let e=Va(c.agents);for(;;){if("normal"===e.type)e.agent.parallel=!1;else{const t=e.agents;for(let e=0;e<t.length;e++)t[e].agent.parallel=!0}if(!e.nextAgent)break;e=e.nextAgent}}return c}catch(e){if(n)throw e;return s}}function Ga(e,t){return e+"-"+(+t<10?"0"+t:t)}function Ka(e,t){for(let n=0;n<t.length;n++){if(1!==t[n].nodeType)continue;let r=t[n];switch(r.tagName){case"node":{let t={type:"normal",text:r.textContent||"",input:r.getAttribute("input"),output:r.getAttribute("output")};e.push(t);break}case"forEach":{let t=[],n={type:"forEach",items:r.getAttribute("items")||"list",nodes:t},s=r.getElementsByTagName("node");s.length>0&&Ka(t,s),e.push(n);break}case"watch":{let t=[],n={type:"watch",event:r.getAttribute("event")||"",loop:"true"==r.getAttribute("loop"),description:r.getElementsByTagName("description")[0]?.textContent||"",triggerNodes:t},s=r.getElementsByTagName("trigger");s.length>0&&Ka(t,s[0].childNodes),e.push(n);break}}}}function Ja(e,t,n){const r=(new Wa.DOMParser).parseFromString(e,"text/xml");let s=r.getElementsByTagName("agent"),o=r.getElementsByTagName("nodes");if(o.length>0){let e=o[0].childNodes,t=0;for(let r=0;r<e.length;r++){let s=e[r];1==s.nodeType&&(s.setAttribute("id",t+""),n&&n(t,s),t++)}}let a=function(e){let t="";const n=new Wa.XMLSerializer;for(let r=0;r<e.childNodes.length;r++)t+=n.serializeToString(e.childNodes[r]);return t}(s[0]),i=a.substring(0,a.indexOf("<task>"));return a=a.replace("<task>","<currentTask>").replace("</task>","</currentTask>"),`<root>${i}<mainTask>${t}</mainTask>${a}</root>`.replace(/      /g,"  ").replace("    </root>","</root>")}function Xa(e,t){let n=(new Wa.DOMParser).parseFromString(e,"text/xml").getElementsByTagName("nodes");if(n.length>0){let e=n[0].childNodes,r=0;for(let n=0;n<e.length;n++){let s=e[n];if(1==s.nodeType&&(null!=s.getAttribute("id")&&""!=s.getAttribute("id")||s.setAttribute("id",r+""),r++,s.getAttribute("id")==t+""))return s}}return null}class Ya{constructor(){this.name="task_snapshot",this.description="Task snapshot archive, recording key information of the current task, updating task node status, facilitating subsequent continuation of operation.",this.parameters={type:"object",properties:{doneIds:{type:"array",description:"Update task node completion status, list of completed node IDs.",items:{type:"number"}},taskSnapshot:{type:"string",description:"Current task important information, as detailed as possible, ensure that the task progress can be restored through this information later, output records of completed task information, contextual information, variables used, pending tasks information, etc."}},required:["doneIds","taskSnapshot"]}}async execute(e,t){let n=e.doneIds,r=e.taskSnapshot,s=t.agentChain.agent,o=t.context.chain.taskPrompt,a=Ja(s.xml,o,(e,t)=>{let r=n.indexOf(e)>-1;t.setAttribute("status",r?"done":"todo")});return{content:[{type:"text",text:"The current task has been interrupted. Below is a snapshot of the task execution history.\n# Task Snapshot\n"+r.trim()+"\n\n# Task\n"+a}]}}}async function Qa(e,t,n,r,i,l,u=0,c,d){await e.context.checkAborted(),n.length>=80&&!i&&await ti(e,t,n,r),l||function(e,t){const n=e.context.conversation.splice(0,e.context.conversation.length).filter(e=>!!e);if(n.length>0){const e="The user is intervening in the current task, please replan and execute according to the following instructions:\n"+n.map(e=>`- ${e.trim()}`).join("\n");t.push({role:"user",content:[{type:"text",text:e}]})}}(e,n);let p=e.context,h=e.agentChain,m=h.agent,g=c||p.config.callback||{onMessage:async()=>{}};const f=new AbortController;let y,b={tools:r,toolChoice:l,messages:n,abortSignal:AbortSignal.any([p.controller.signal,f.signal])};d&&d(b),h.agentRequest=b;try{p.currentStepControllers.add(f),y=await t.callStream(b)}catch(s){if(p.currentStepControllers.delete(f),await p.checkAborted(),!i&&n.length>=5&&((s+"").indexOf("tokens")>-1||(s+"").indexOf("too long")>-1)&&await ti(e,t,n,r),u<3)return await o(200*(u+1)*(u+1)),Qa(e,t,n,r,i,l,++u,g);throw s}let v="",w="",_="",x=a(),k=!1,T=[];const N=y.stream.getReader();try{let o=null;for(;;){await p.checkAborted();const{done:a,value:c}=await N.read();if(a)break;let d=c;switch(d.type){case"text-delta":if(o&&!d.textDelta)continue;v+=d.textDelta||"",await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"text",streamId:x,streamDone:!1,text:v},e),o&&(await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"tool_use",toolId:o.toolCallId,toolName:o.toolName,params:o.args||{}},e),o=null);break;case"reasoning":w+=d.textDelta||"",await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"thinking",streamId:x,streamDone:!1,text:w},e);break;case"tool-call-delta":k||(k=!0,await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"text",streamId:x,streamDone:!0,text:v},e)),_+=d.argsTextDelta||"",await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"tool_streaming",toolId:d.toolCallId,toolName:d.toolName,paramsText:_},e),null==o&&(o={type:"tool-call",toolCallId:d.toolCallId,toolName:d.toolName,args:{}},T.push(o));break;case"tool-call":{_="";let t=d.args?JSON.parse(d.args):{},n={taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"tool_use",toolId:d.toolCallId,toolName:d.toolName,params:t};await g.onMessage(n,e),null==o?T.push({type:"tool-call",toolCallId:d.toolCallId,toolName:d.toolName,args:n.params||t}):(o.args=n.params||t,o=null);break}case"file":await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"file",mimeType:d.mimeType,data:d.data},e);break;case"error":throw s.error(`${m.name} agent error: `,d),await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"error",error:d.error},e),new Error("LLM Error: "+d.error);case"finish":if(k||(k=!0,await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"text",streamId:x,streamDone:!0,text:v},e)),o&&(await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"tool_use",toolId:o.toolCallId,toolName:o.toolName,params:o.args||{}},e),o=null),await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"finish",finishReason:d.finishReason,usage:d.usage},e),"length"===d.finishReason&&n.length>=5&&!i&&u<3)return await ti(e,t,n,r),Qa(e,t,n,r,i,l,++u,g)}}}catch(s){if(await p.checkAborted(),u<3)return await o(200*(u+1)*(u+1)),Qa(e,t,n,r,i,l,++u,g);throw s}finally{N.releaseLock(),p.currentStepControllers.delete(f)}return h.agentResult=v,v?[{type:"text",text:v},...T]:T}function ei(e,t){let n=[],r=[];for(let s=0;s<e.length;s++){let o=e[s];if("tool"==o.role)for(let e=0;e<o.content.length;e++){let s=o.content[e].toolName;if(r.indexOf(s)>-1)continue;r.push(s);let a=t.filter(e=>e.name===s)[0];a&&n.push(a)}}return n}async function ti(e,t,n,r){if(!(n.length<5))try{!async function(e,t,n,r){let s=ei(n,r),o=new Ya,a=u(s,[{type:"function",name:o.name,description:o.description,parameters:o.parameters}]),i=n.length-1,l=n;for(let e=l.length-1;e>3;e--)if("tool"==l[e].role){l=l.slice(0,e+1),i=e;break}l.push({role:"user",content:[{type:"text",text:"Please create a snapshot backup of the current task, keeping only key important information and node completion status."}]});let c=(await Qa(e,t,l,a,!0,{type:"tool",toolName:o.name})).filter(e=>"tool-call"==e.type)[0],d="string"==typeof c.args?JSON.parse(c.args||"{}"):c.args||{},p=await o.execute(d,e),h=e.context.config.callback;h&&await h.onMessage({taskId:e.context.taskId,agentName:e.agent.Name,nodeId:e.agentChain.agent.id,type:"tool_result",toolId:c.toolCallId,toolName:c.toolName,params:d,toolResult:p},e);let m=3;for(let e=0;e<n.length;e++)if("tool"==n[0].role){m=e;break}n.splice(m+1,i-m-2,{role:"user",content:p.content.filter(e=>"text"==e.type)})}(e,t,n,r)}catch(e){s.error("Error compressing agent messages:",e)}}class ni{constructor(e,t){var n;this.tool="function"in(n=e)?{type:"function",name:n.function.name,description:n.function.description,parameters:n.function.parameters}:"input_schema"in n?{type:"function",name:n.name,description:n.description,parameters:n.input_schema}:"inputSchema"in n?{type:"function",name:n.name,description:n.description,parameters:n.inputSchema}:{type:"function",name:n.name,description:n.description,parameters:n.parameters},this.execute=t}get name(){return this.tool.name}getTool(){return this.tool}async callTool(e,t,n){return await this.execute.execute(e,t,n)}}class ri{constructor(e,t){this.toolName=e.toolName,this.toolCallId=e.toolCallId,this.request=JSON.parse(JSON.stringify(t))}updateParams(e){this.params=e,this.onUpdate&&this.onUpdate()}updateToolResult(e){this.toolResult=e,this.onUpdate&&this.onUpdate()}}class si{constructor(e){this.tools=[],this.agent=e}push(e){e.onUpdate=()=>{this.onUpdate&&this.onUpdate({type:"update",target:e})},this.tools.push(e),this.onUpdate&&this.onUpdate({type:"update",target:this})}}class oi{constructor(e){this.agents=[],this.listeners=[],this.taskPrompt=e}push(e){e.onUpdate=e=>{this.pub(e)},this.agents.push(e),this.pub({type:"update",target:e})}pub(e){this.listeners.forEach(t=>t(this,e))}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}}const ai="foreach_task";class ii{constructor(){this.name=ai,this.description="When executing the `forEach` node, please use the current tool for counting to ensure tasks are executed sequentially, the tool needs to be called with each loop iteration.",this.parameters={type:"object",properties:{nodeId:{type:"number",description:"forEach node ID."},progress:{type:"string",description:"Current execution progress."},next_step:{type:"string",description:"Next task description."}},required:["nodeId","progress","next_step"]}}async execute(e,t){let n=e.nodeId,r=Xa(t.agentChain.agent.xml,n);if(null==r)throw new Error("Node ID does not exist: "+n);if("forEach"!==r.tagName)throw new Error("Node ID is not a forEach node: "+n);let s=r.getAttribute("items"),o=null,a="Recorded";if(s&&"list"!=s&&(o=t.context.variables.get(s.trim()),o)){let e="foreach_"+n,r=t.variables.get(e)||0;r%5==0&&(a=`Variable information associated with the current loop task.\nvariable_name: ${s.trim()}\nvariable_value: ${o}`),t.variables.set(e,++r)}return{content:[{type:"text",text:a}]}}}const li="human_interact",ui="variable_storage";class ci{constructor(){this.name=ui,this.description="Used for storing, reading, and retrieving variable data, and maintaining input/output variables in task nodes.",this.parameters={type:"object",properties:{operation:{type:"string",description:"variable storage operation type.",enum:["read_variable","write_variable","list_all_variable"]},name:{type:"string",description:"variable name, required when reading and writing variables, If reading variables, it supports reading multiple variables separated by commas."},value:{type:"string",description:"variable value, required when writing variables"}},required:["operation"]}}async execute(e,t){let n="";switch(e.operation){case"read_variable":if(e.name){let r={},s=e.name.split(",");for(let e=0;e<s.length;e++){let n=s[e].trim(),o=t.context.variables.get(n);r[n]=o}n=JSON.stringify(r)}else n="Error: name is required";break;case"write_variable":{if(!e.name){n="Error: name is required";break}if(null==e.value){n="Error: value is required";break}let r=e.name;t.context.variables.set(r.trim(),e.value),n="success";break}case"list_all_variable":n=JSON.stringify(Object.keys(t.context.variables))}return{content:[{type:"text",text:n||""}]}}}const di="watch_trigger";class pi{constructor(){this.name=di,this.description="When executing the `watch` node, please use it to monitor DOM element changes, it will block the listener until the element changes or times out.",this.parameters={type:"object",properties:{nodeId:{type:"number",description:"watch node ID."},watch_area:{type:"array",description:"Element changes in monitoring area, eg: [x, y, width, height].",items:{type:"number"}},watch_index:{type:"array",description:"The index of elements to be monitoring multiple elements simultaneously.",items:{type:"number"}},frequency:{type:"number",description:"Check frequency, how many seconds between each check, default 1 seconds.",default:1,minimum:.5,maximum:30},timeout:{type:"number",description:"Timeout in minute, default 5 minutes.",default:5,minimum:1,maximum:30}},required:["nodeId"]}}async execute(e,t){let n=e.nodeId,r=Xa(t.agentChain.agent.xml,n);if(null==r)throw new Error("Node ID does not exist: "+n);if("watch"!==r.tagName)throw new Error("Node ID is not a watch node: "+n);let s=r.getElementsByTagName("description")[0]?.textContent||"";if(!s)return{content:[{type:"text",text:"The watch node does not have a description, skip."}]};await this.init_eko_observer(t);const o=await this.get_screenshot(t),a=(new Date).getTime(),i=6e4*(e.timeout||5),l=Math.max(500,1e3*(e.frequency||1));let u=new Ma(t.context.config.llms,t.agent.Llms);for(;(new Date).getTime()-a<i;){if(await t.context.checkAborted(),await new Promise(e=>setTimeout(e,l)),"false"==await this.has_eko_changed(t))continue;await this.init_eko_observer(t);const e=await this.get_screenshot(t),n=await this.is_dom_change(t,u,o,e,s);if(n.changed)return{content:[{type:"text",text:n.changeInfo||"DOM change detected."}]}}return{content:[{type:"text",text:"Timeout reached, no DOM changes detected."}]}}async get_screenshot(e){const t=e.agent.screenshot,n=await t.call(e.agent,e);return{image:l(n.imageBase64),imageType:n.imageType}}async init_eko_observer(e){try{const t=e.agent.execute_script;await t.call(e.agent,e,()=>{let e=window;e.has_eko_changed=!1,e.eko_observer&&e.eko_observer.disconnect();let t=new MutationObserver(function(t){e.has_eko_changed=!0});t.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0}),e.eko_observer=t},[])}catch(e){console.error("Error initializing Eko observer:",e)}}async has_eko_changed(e){try{const t=e.agent.execute_script;return await t.call(e.agent,e,()=>window.has_eko_changed+"",[])}catch(e){return console.error("Error checking Eko change:",e),"undefined"}}async is_dom_change(e,t,n,r,o){try{let s={messages:[{role:"system",content:'You are a tool for detecting element changes. Given a task description, compare two images to determine whether the changes described in the task have occurred.\nIf the changes have occurred, return an json with `changed` set to true and `changeInfo` containing a description of the changes. If no changes have occurred, return an object with `changed` set to false.\n\n## Example\nUser: Monitor new messages in group chat\n### No changes detected\nOutput:\n{\n  "changed": false\n}\n### Change detected\nOutput:\n{\n  "changed": true,\n  "changeInfo": "New message received in the group chat. The message content is: \'Hello, how are you?\'"\n}'},{role:"user",content:[{type:"image",image:n.image,mimeType:n.imageType},{type:"image",image:r.image,mimeType:r.imageType},{type:"text",text:o}]}],abortSignal:e.context.controller.signal},a=(await t.call(s)).text||"{}";return a=a.substring(a.indexOf("{"),a.lastIndexOf("}")+1),JSON.parse(a)}catch(e){s.error("Error in is_dom_change:",e)}return{changed:!1}}}class hi{constructor(e){this.toolWrapper=e,this.name=e.name,this.description=e.getTool().description,this.parameters=e.getTool().parameters}async execute(e,t,n){return this.toolWrapper.callTool(e,t,n)}}const mi=`\n* HUMAN INTERACT\nDuring the task execution process, you can use the \`${li}\` tool to interact with humans, please call it in the following situations:\n- When performing dangerous operations such as deleting files, confirmation from humans is required.\n- When encountering obstacles while accessing websites, such as requiring user login, captcha verification, QR code scanning, or human verification, you need to request manual assistance.\n- Please do not use the \`${li}\` tool frequently.\n`,gi=`\n* VARIABLE STORAGE\nWhen a step node has input/output variable attributes, use the \`${ui}\` tool to read from and write to these variables, these variables enable context sharing and coordination between multiple agents.\n`,fi=`\n* forEach node\nrepetitive tasks, when executing to the forEach node, require the use of the \`${ai}\` tool.\n`,yi=`\n* watch node\nmonitor changes in webpage DOM elements, when executing to the watch node, require the use of the \`${di}\` tool.\n`;function bi(e,t,n,r){let s=(r||e.Tools).filter(e=>"task_node_status"==e.name).length>0;return Ja(t.xml,n.chain.taskPrompt,(e,t)=>{s&&t.setAttribute("status","todo")})}class vi{constructor(e){this.tools=[],this.name=e.name,this.description=e.description,this.tools=e.tools,this.llms=e.llms,this.mcpClient=e.mcpClient,this.planDescription=e.planDescription,this.requestHandler=e.requestHandler}async run(e,t){let n=this.mcpClient||e.config.defaultMcpClient,r=new h(e,this,t);try{return this.agentContext=r,n&&!n.isConnected()&&await n.connect(e.controller.signal),this.runWithContext(r,n,500)}finally{n&&await n.close()}}async runWithContext(e,t,n=100,r=[]){let s=0;this.agentContext=e;let o=e.context,a=e.agentChain.agent;const i=[...this.tools,...this.system_auto_tools(a)],l=[{role:"system",content:await this.buildSystemPrompt(e,i)},...r,{role:"user",content:await this.buildUserPrompt(e,i)}];e.messages=l;let c=new Ma(o.config.llms,this.llms),d=i;for(;s<n;){if(await o.checkAborted(),t){let n=await this.controlMcpTools(e,l,s);if(n.mcpTools){let e=await this.listTools(o,t,a,n.mcpParams),r=u(i,ei(l,d));d=u(r,e)}}await this.handleMessages(e,l,i);let n=await Qa(e,c,l,this.convertTools(d),!1,void 0,0,this.callback,this.requestHandler),r=await this.handleCallResult(e,l,d,n);if(r)return r;s++}return"Unfinished"}async handleCallResult(e,t,n,r){const o=e.variables.get("forceStop");if(o)return o;let a=null,i=e.context,l=[],u=[];if(0==(r=function(e){if(e.length<=1||e.filter(e=>"tool-call"==e.type).length<=1)return e;let t=[],n=[];for(let r=0;r<e.length;r++)if("tool-call"===e[r].type){let s=e[r],o=s.toolName+s.args;-1==n.indexOf(o)&&(t.push(e[r]),n.push(o))}else t.push(e[r]);return t}(r)).length)return null;for(let t=0;t<r.length;t++){let o,c=r[t];if("text"==c.type){a=c.text;continue}let d=new ri(c,e.agentChain.agentRequest);e.agentChain.push(d);try{let t="string"==typeof c.args?JSON.parse(c.args||"{}"):c.args||{};d.params=t;let r=this.getTool(n,c.toolName);if(!r)throw new Error(c.toolName+" tool does not exist");o=await r.execute(t,e,c),d.updateToolResult(o),e.consecutiveErrorNum=0}catch(t){if(s.error("tool call error: ",c.toolName,c.args,t),o={content:[{type:"text",text:t+""}],isError:!0},d.updateToolResult(o),++e.consecutiveErrorNum>=10)throw t}const p=this.callback||i.config.callback;p&&await p.onMessage({taskId:i.taskId,agentName:e.agent.Name,nodeId:e.agentChain.agent.id,type:"tool_result",toolId:c.toolCallId,toolName:c.toolName,params:c.args||{},toolResult:o},e);let h=this.convertToolResult(c,o,l);u.push(h)}return t.push({role:"assistant",content:r}),u.length>0?(t.push({role:"tool",content:u}),l.forEach(e=>t.push(e)),null):a}system_auto_tools(e){let t=[],n=e.xml;(n.indexOf("input=")>-1||n.indexOf("output=")>-1)&&t.push(new ci),n.indexOf("</forEach>")>-1&&t.push(new ii),n.indexOf("</watch>")>-1&&t.push(new pi);let r=this.tools.map(e=>e.name);return t.filter(e=>-1==r.indexOf(e.name))}async buildSystemPrompt(e,t){return function(e,t,n,r,s){let o="",a="";r=r||e.Tools;let i=t.xml,l=i.indexOf("</watch>")>-1,u=i.indexOf("</forEach>")>-1,c=r.filter(e=>e.name==li).length>0,p=i.indexOf("input=")>-1||i.indexOf("output=")>-1||r.filter(e=>e.name==ui).length>0;if(c&&(o+=mi),p&&(o+=gi),u&&(r.filter(e=>e.name==ai).length>0&&(o+=fi),a+='\n    \x3c!-- duplicate task node, items support list and variable --\x3e\n    <forEach items="list or variable name">\n      <node>forEach item step node</node>\n    </forEach>'),l&&(r.filter(e=>e.name==di).length>0&&(o+=yi),a+='\n    \x3c!-- monitor task node, the loop attribute specifies whether to listen in a loop or listen once --\x3e\n    <watch event="dom" loop="true">\n      <description>Monitor task description</description>\n      <trigger>\n        <node>Trigger step node</node>\n        <node>...</node>\n      </trigger>\n    </watch>'),s&&s.trim()&&(o+="\n"+s.trim()+"\n"),o+="\nCurrent datetime: {datetime}",n.chain.agents.length>1){o+="\n Main task: "+n.chain.taskPrompt,o+="\n\n# Pre-task execution results";for(let e=0;e<n.chain.agents.length;e++){let t=n.chain.agents[e];t.agentResult&&(o+=`\n## ${t.agent.task||t.agent.name}\n${d(t.agentResult,500,!0)}`)}}return'\nYou are {name}, an autonomous AI agent for {agent} agent.\n\n# Agent Description\n{description}\n{prompt}\n\n# User input task instructions\n<root>\n  \x3c!-- Main task, completed through the collaboration of multiple Agents --\x3e\n  <mainTask>main task</mainTask>\n  \x3c!-- The tasks that the current agent needs to complete, the current agent only needs to complete the currentTask --\x3e\n  <currentTask>specific task</currentTask>\n  \x3c!-- Complete the corresponding step nodes of the task, Only for reference --\x3e\n  <nodes>\n    \x3c!-- node supports input/output variables to pass dependencies --\x3e\n    <node input="variable name" output="variable name" status="todo / done">task step node</node>{nodePrompt}\n  </nodes>\n</root>\n\nThe output language should follow the language corresponding to the user\'s task.\n'.replace("{name}","Eko").replace("{agent}",e.Name).replace("{description}",e.Description).replace("{prompt}","\n"+o.trim()).replace("{nodePrompt}",a).replace("{datetime}",(new Date).toLocaleString()).trim()}(this,e.agentChain.agent,e.context,t,await this.extSysPrompt(e,t))}async buildUserPrompt(e,t){return[{type:"text",text:bi(this,e.agentChain.agent,e.context,t)}]}async extSysPrompt(e,t){return""}async listTools(t,n,r,o){try{n.isConnected()||await n.connect(t.controller.signal);let s=await n.listTools({taskId:t.taskId,nodeId:r?.id,environment:e,agent_name:r?.name||this.name,params:{},prompt:r?.task||t.chain.taskPrompt,...o||{}},t.controller.signal),a=[];for(let e=0;e<s.length;e++){let t=s[e],r=this.toolExecuter(n,t.name),o=new ni(t,r);a.push(new hi(o))}return a}catch(e){return s.error("Mcp listTools error",e),[]}}async controlMcpTools(e,t,n){return{mcpTools:0==n}}toolExecuter(t,n){return{execute:async function(r,s){return await t.callTool({name:n,arguments:r,extInfo:{taskId:s.context.taskId,nodeId:s.agentChain.agent.id,environment:e,agent_name:s.agent.Name}},s.context.controller.signal)}}}convertTools(e){return e.map(e=>({type:"function",name:e.name,description:e.description,parameters:e.parameters}))}getTool(e,t){for(let n=0;n<e.length;n++)if(e[n].name==t)return e[n];return null}convertToolResult(e,t,n){let r="";for(let s=0;s<t.content.length;s++){let o=t.content[s];"text"==o.type?r+=(r.length>0?"\n":"")+o.text:n.push({role:"user",content:[{type:"image",image:l(o.data),mimeType:o.mimeType},{type:"text",text:`call \`${e.toolName}\` tool result`}]})}let s=1==t.isError;s&&!r.startsWith("Error")?r="Error: "+r:s||0!=r.length||(r="Successful");let o={type:"text",text:r},a=r;if(r&&(r.startsWith("{")&&r.endsWith("}")||r.startsWith("[")&&r.endsWith("]")))try{a=JSON.parse(r),o=null}catch(e){}return{type:"tool-result",toolCallId:e.toolCallId,toolName:e.toolName,result:a,content:o?[o]:void 0,isError:s}}async handleMessages(e,t,n){!function(e){let t=0,n=0,r={};for(let s=e.length-1;s>=0;s--){let o=e[s];if("user"==o.role)for(let e=0;e<o.content.length;e++){let r=o.content[e];if("image"==r.type){if(++t<=1)break;r={type:"text",text:"[image]"},o.content[e]=r}else if("file"==r.type){if(++n<=1)break;r={type:"text",text:"[file]"},o.content[e]=r}}else if("tool"==o.role)for(let e=0;e<o.content.length;e++){let n=o.content[e],s=n.content;if(s&&0!=s.length){for(let e=0;e<s.length;e++){let n=s[e];if("image"==n.type){if(++t<=1)break;n={type:"text",text:"[image]"},s[e]=n}}for(let e=0;e<s.length;e++){let t=s[e];if("text"==t.type&&t.text?.length>5e3){if(!r[n.toolName]){r[n.toolName]=1;break}r[n.toolName]++,t={type:"text",text:t.text.substring(0,5e3)+"..."},s[e]=t}}}}}}(t)}async callInnerTool(e){let t=await e();return{content:[{type:"text",text:t?"string"==typeof t?t:JSON.stringify(t):"Successful"}]}}async loadTools(e){if(this.mcpClient){let t=await this.listTools(e,this.mcpClient);if(t&&t.length>0)return u(this.tools,t)}return this.tools}addTool(e){this.tools.push(e)}async onTaskStatus(e,t){"abort"==e&&this.agentContext&&this.agentContext?.variables.clear()}get Llms(){return this.llms}get Name(){return this.name}get Description(){return this.description}get Tools(){return this.tools}get PlanDescription(){return this.planDescription}get McpClient(){return this.mcpClient}get AgentContext(){return this.agentContext}}const wi=['User: Open Boss Zhipin, find 10 operation positions in Chengdu, and send a personal introduction to the recruiters based on the page information.\nOutput result:\n<root>\n  <name>Submit resume</name>\n  <thought>OK, now the user requests me to create a workflow that involves opening the Boss Zhipin website, finding 10 operation positions in Chengdu, and sending personal resumes to the recruiters based on the job information.</thought>\n  <agents>\n    <agent name="Browser" id="0" dependsOn="">\n      <task>Open Boss Zhipin, find 10 operation positions in Chengdu, and send a personal introduction to the recruiters based on the page information.</task>\n      <nodes>\n        <node>Open Boss Zhipin, enter the job search page</node>\n        <node>Set the regional filter to Chengdu and search for operational positions.</node>\n        <node>Brows the job list and filter out 10 suitable operation positions.</node>\n        <forEach items="list">\n          <node>Analyze job requirements</node>\n          <node>Send a self-introduction to the recruiter</node>\n        </forEach>\n      </nodes>\n    </agent>\n  </agents>\n</root>','User: Help me collect the latest AI news, summarize it, and send it to the "AI news information" group chat on WeChat.\nOutput result:\n<root>\n  <name>Latest AI News</name>\n  <thought>OK, users need to collect the latest AI news, summarize it, and send it to a WeChat group named "AI news information" This requires automation, including the steps of data collection, processing, and distribution.</thought>\n  <agents>\n    <agent name="Browser" id="0" dependsOn="">\n      <task>Search for the latest updates on AI</task>\n      <nodes>\n        <node>Open Google</node>\n        <node>Search for the latest updates on AI</node>\n        <forEach items="list">\n          <node>View Details</node>\n        </forEach>\n        <node output="summaryInfo">Summarize search information</node>\n      </nodes>\n    </agent>\n    <agent name="Computer" id="1" dependsOn="0">\n      <task>Send a message to the WeChat group chat "AI news information"</task>\n      <nodes>\n        <node>Open WeChat</node>\n        <node>Search for the "AI news information" chat group</node>\n        <node input="summaryInfo">Send summary message</node>\n      </nodes>\n    </agent>\n  </agents>\n</root>','User: Access the Google team\'s organization page on GitHub, extract all developer accounts from the team, and compile statistics on the countries and regions where these developers are located.\nOutput result:\n<root>\n  <name>Statistics of Google Team Developers\' Geographic Distribution</name>\n  <thought>Okay, I need to first visit GitHub, then find Google\'s organization page on GitHub, extract the team member list, and individually visit each developer\'s homepage to obtain location information for each developer. This requires using a browser to complete all operations.</thought>\n  <agents>\n    <agent name="Browser" id="0" dependsOn="">\n      <task>Visit Google GitHub Organization Page and Analyze Developer Geographic Distribution</task>\n      <nodes>\n        <node>Visit https://github.com/google</node>\n        <node>Click "People" tab to view team members</node>\n        <node>Scroll the page to load all developer information</node>\n        <node output="developers">Extract all developer account information</node>\n        <forEach items="developers">\n          <node>Visit developer\'s homepage</node>\n          <node>Extract developer\'s location information</node>\n        </forEach>\n        <node>Compile and analyze the geographic distribution data of all developers</node>\n      </nodes>\n    </agent>\n  </agents>\n</root>','User: Open Discord to monitor messages in Group A, and automatically reply when new messages are received.\nOutput result:\n<root>\n  <name>Automatic reply to Discord messages</name>\n  <thought>OK, monitor the chat messages in Discord group A and automatically reply.</thought>\n  <agents>\n    <agent name="Browser" id="0" dependsOn="">\n      <task>Open Group A in Discord</task>\n      <nodes>\n        <node>Open Discord page</node>\n        <node>Find and open Group A</node>\n        <watch event="dom" loop="true">\n          <description>Monitor new messages in group chat</description>\n          <trigger>\n            <node>Analyze message content</node>\n            <node>Automatic reply to new messages</node>\n          </trigger>\n        </watch>\n      </nodes>\n    </agent>\n  </agents>\n</root>','User: Search for information about "fellou," compile the results into a summary profile, then share it across social media platforms including Twitter, Facebook, and Reddit. Finally, export the platform sharing operation results to an Excel file.\nOutput result:\n<root>\n<name>Fellou Research and Social Media Campaign</name>\n<thought>The user wants me to research information about \'Fellou\', create a summary profile, share it on multiple social media platforms (Twitter, Facebook, Reddit), and then compile the results into an Excel file. This requires multiple agents working together: Browser for research, Browser for social media posting (Twitter, Facebook, and Reddit in parallel), and File for creating the Excel export. I need to break this down into sequential steps with proper variable passing between agents.</thought>\n<agents>\n  <agent name="Browser" id="0" dependsOn="">\n      <task>Research comprehensive information about \'Fellou\'</task>\n      <nodes>\n        <node>Search for the latest information about \'Fellou\' - its identity, purpose, and core features</node>\n        <node>Search for Fellou\'s functionalities, capabilities, and technical specifications</node>\n        <node>Search for recent news, updates, announcements, and developments related to Fellou</node>\n        <node>Search for user reviews, feedback, and community discussions about Fellou</node>\n        <node>Search for Fellou\'s market position, competitors, and industry context</node>\n        <node output="researchData">Compile all research findings into a comprehensive summary profile</node>\n      </nodes>\n    </agent>\n    <agent name="Browser" id="1" dependsOn="0">\n      <task>Share Fellou\'s summary and collected interaction data on Twitter/X</task>\n      <nodes>\n        <node>Navigate to Twitter/X platform</node>\n        <node input="researchData">Create and post Twitter-optimized content about Fellou (within character limits, using hashtags)</node>\n        <node output="twitterResults">Capture Twitter post URL and initial engagement metrics</node>\n      </nodes>\n    </agent>\n    <agent name="Browser" id="2" dependsOn="0">\n      <task>Share Fellou\'s summary and collected interaction data on Facebook</task>\n      <nodes>\n        <node>Navigate to Facebook platform</node>\n        <node input="researchData">Create and post Facebook-optimized content about Fellou (longer format, engaging description)</node>\n        <node output="facebookResults">Capture Facebook post URL and initial engagement metrics</node>\n      </nodes>\n    </agent>\n    <agent name="Browser" id="3" dependsOn="0">\n      <task>Share Fellou\'s summary and collected interaction data on Reddit</task>\n      <nodes>\n        <node>Navigate to Reddit platform</node>\n        <node input="researchData">Find appropriate subreddit and create Reddit-optimized post about Fellou (community-focused, informative)</node>\n        <node output="redditResults">Capture Reddit post URL and initial engagement metrics</node>\n      </nodes>\n    </agent>\n    <agent name="File" id="4" dependsOn="1,2,3">\n      <task>Compile social media results into Excel file</task>\n      <nodes>\n        <node input="twitterResults,facebookResults,redditResults">Create Excel file with social media campaign results</node>\n        <node>Include columns for Platform, Post URL, Content Summary, Timestamp, Initial Likes/Shares/Comments</node>\n        <node>Format the Excel file with proper headers and styling</node>\n        <node>Save the file as \'Fellou_Social_Media_Campaign_Results.xlsx\'</node>\n      </nodes>\n    </agent>\n  </agents>\n</agents>\n</root>'];async function _i(e){let t="",n=e.agents;for(let r=0;r<n.length;r++){let s=n[r],o=await s.loadTools(e);t+=`<agent name="${s.Name}">\nDescription: ${s.PlanDescription||s.Description}\nTools:\n`+o.filter(e=>!e.noPlan).map(e=>`  - ${e.name}: ${e.planDescription||e.description||""}`).join("\n")+"\n</agent>\n\n"}let r=e.variables.get("plan_example_list")||wi,s="";const o=e.agents.filter(e=>"Chat"==e.Name).length>0?['User: hello.\nOutput result:\n<root>\n  <name>Chat</name>\n  <thought>Alright, the user wrote "hello". That\'s pretty straightforward. I need to respond in a friendly and welcoming manner.</thought>\n  <agents>\n    \x3c!-- Chat agents can exist without the <task> and <nodes> nodes. --\x3e\n    <agent name="Chat" id="0" dependsOn=""></agent>\n  </agents>\n</root>',...r]:[...r];for(let e=0;e<o.length;e++)s+=`## Example ${e+1}\n${o[e]}\n\n`;return'\nYou are {name}, an autonomous AI Agent Planner.\n\n## Task Description\nYour task is to understand the user\'s requirements, dynamically plan the user\'s tasks based on the Agent list, and please follow the steps below:\n1. Understand the user\'s requirements.\n2. Analyze the Agents that need to be used based on the user\'s requirements.\n3. Generate the Agent calling plan based on the analysis results.\n4. About agent name, please do not arbitrarily fabricate non-existent agent names.\n5. You only need to provide the steps to complete the user\'s task, key steps only, no need to be too detailed.\n6. Please strictly follow the output format and example output.\n7. The output language should follow the language corresponding to the user\'s task.\n\n## Agent list\n{agents}\n\n## Output Rules and Format\n<root>\n  \x3c!-- Task Name (Short) --\x3e\n  <name>Task Name</name>\n  \x3c!-- Need to break down the task into multi-agent collaboration. Please think step by step and output a detailed thought process. --\x3e\n  <thought>Your thought process on user demand planning</thought>\n  \x3c!-- Multiple Agents work together to complete the task --\x3e\n  <agents>\n    \x3c!--\n    Multi-Agent supports parallelism, coordinating parallel tasks through dependencies, and passing dependent context information through node variables.\n    name: The name of the Agent, where the name can only be an available name in the Agent list.\n    id: Use subscript order as ID for dependency relationships between multiple agents.\n    dependsOn: The IDs of agents that the current agent depends on, separated by commas when there are multiple dependencies.\n    --\x3e\n    <agent name="Agent name" id="0" dependsOn="">\n      \x3c!-- The current Agent needs to complete the task --\x3e\n      <task>current agent task</task>\n      <nodes>\n        \x3c!-- Nodes support input/output variables for parameter passing and dependency handling in multi-agent collaboration. --\x3e\n        <node>Complete the corresponding step nodes of the task</node>\n        <node input="variable name">...</node>\n        <node output="variable name">...</node>\n        \x3c!-- When including duplicate tasks, `forEach` can be used --\x3e\n        <forEach items="list or variable name">\n          <node>forEach step node</node>\n        </forEach>\n        \x3c!-- When you need to monitor changes in webpage DOM elements, you can use `Watch`, the loop attribute specifies whether to listen in a loop or listen once. --\x3e\n        <watch event="dom" loop="true">\n          <description>Monitor task description</description>\n          <trigger>\n            <node>Trigger step node</node>\n            <node>...</node>\n          </trigger>\n        </watch>\n      </nodes>\n    </agent>\n    \x3c!--\n    Multi-agent Collaboration Dependency Example:\n\n    Execution Flow:\n    1. Agent 0: Initial agent with no dependencies (executes first)\n    2. Agent 1: Depends on Agent 0 completion (executes after Agent 0)\n    3. Agent 2 & 3: Both depend on Agent 1 completion (execute in parallel after Agent 1)\n    4. Agent 4: Depends on both Agent 2 and Agent 3 completion (executes last)\n\n    Dependency Chain: Agent 0  Agent 1  (Agent 2  Agent 3)  Agent 4\n    --\x3e\n    <agent name="Agent name" id="0" dependsOn="">...</agent>\n    <agent name="Agent name" id="1" dependsOn="0">...</agent>\n    <agent name="Agent name" id="2" dependsOn="1">...</agent>\n    <agent name="Agent name" id="3" dependsOn="1">...</agent>\n    <agent name="Agent name" id="4" dependsOn="2,3">...</agent>\n  </agents>\n</root>\n\n{example_prompt}\n'.replace("{name}","Eko").replace("{agents}",t.trim()).replace("{example_prompt}",s).trim()}function xi(t,n,r){let s="";return s=n?"\nUser Platform: {platform}\nTask Website: {task_website}\nCurrent datetime: {datetime}\nTask Description: {task_prompt}\n".replace("{task_website}",n):"\nUser Platform: {platform}\nCurrent datetime: {datetime}\nTask Description: {task_prompt}\n",s=s.replace("{task_prompt}",t).replace("{platform}",e).replace("{datetime}",(new Date).toLocaleString()).trim(),r&&(s+=`\n${r.trim()}`),s}class ki{constructor(e,t){this.context=e,this.taskId=e.taskId,this.callback=t||e.config.callback}async plan(e,t=!0){let n,r;"string"==typeof e?(n=e,r={type:"text",text:xi(e,this.context.variables.get("task_website"),this.context.variables.get("plan_ext_prompt"))}):(r=e,n=e.text||"");const s=[{role:"system",content:this.context.variables.get("plan_sys_prompt")||await _i(this.context)},{role:"user",content:[r]}];return await this.doPlan(n,s,t)}async replan(e,t=!0){const n=this.context.chain;if(n.planRequest&&n.planResult){const r=[...n.planRequest.messages,{role:"assistant",content:[{type:"text",text:n.planResult}]},{role:"user",content:[{type:"text",text:e}]}];return await this.doPlan(e,r,t)}return this.plan(e,t)}async doPlan(e,t,n){const r=this.context.config,o=new Ma(r.llms,r.planLlms),a={maxTokens:4096,temperature:.7,messages:t,abortSignal:this.context.controller.signal},i=(await o.callStream(a)).stream.getReader();let l="",u="";try{for(;;){await this.context.checkAborted(!0);const{done:e,value:t}=await i.read();if(e)break;let n=t;if("error"==n.type)throw s.error("Plan, LLM Error: ",n),new Error("LLM Error: "+n.error);if("reasoning"==n.type&&(u+=n.textDelta||""),"text-delta"==n.type&&(l+=n.textDelta||""),this.callback){let e=za(this.taskId,l,!1,u);e&&await this.callback.onMessage({taskId:this.taskId,agentName:"Planer",type:"workflow",streamDone:!1,workflow:e})}}}finally{i.releaseLock(),s.isEnableInfo()&&s.info("Planner result: \n"+l)}if(n){const e=this.context.chain;e.planRequest=a,e.planResult=l}let c=za(this.taskId,l,!0,u);return this.callback&&await this.callback.onMessage({taskId:this.taskId,agentName:"Planer",type:"workflow",streamDone:!0,workflow:c}),c.taskPrompt?c.taskPrompt+="\n"+e.trim():c.taskPrompt=e.trim(),c}}class Ti{constructor(e){this.config=e,this.taskMap=new Map}async generate(e,t=a(),n){const r=[...this.config.agents||[]],s=new oi(e),o=new p(t,this.config,r,s);n&&Object.keys(n).forEach(e=>o.variables.set(e,n[e]));try{if(this.taskMap.set(t,o),this.config.a2aClient){const t=await this.config.a2aClient.listAgents(e);o.agents=c(o.agents,t)}const n=new ki(o);return o.workflow=await n.plan(e),o.workflow}catch(e){throw this.deleteTask(t),e}}async modify(e,t){const n=this.taskMap.get(e);if(!n)return await this.generate(t,e);if(this.config.a2aClient){const e=await this.config.a2aClient.listAgents(t);n.agents=c(n.agents,e)}const r=new ki(n);return n.workflow=await r.replan(t),n.workflow}async execute(e){const t=this.getTask(e);if(!t)throw new Error("The task does not exist");t.pause&&t.setPause(!1),t.conversation=[],t.controller.signal.aborted&&(t.controller=new AbortController);try{return await this.doRunWorkflow(t)}catch(t){return s.error("execute error",t),{taskId:e,success:!1,stopReason:"AbortError"==t?.name?"abort":"error",result:t}}}async run(e,t=a(),n){return await this.generate(e,t,n),await this.execute(t)}async initContext(e,t){const n=this.config.agents||[],r=new oi(e.taskPrompt||e.name),s=new p(e.taskId,this.config,n,r);if(this.config.a2aClient){const t=await this.config.a2aClient.listAgents(e.taskPrompt||e.name);s.agents=c(s.agents,t)}return t&&Object.keys(t).forEach(e=>s.variables.set(e,t[e])),s.workflow=e,this.taskMap.set(e.taskId,s),s}async doRunWorkflow(e){const t=e.agents,n=e.workflow;if(!n||0==n.agents.length)throw new Error("Workflow error");const r=t.reduce((e,t)=>(e[t.Name]=t,e),{});let s=Va(n.agents);const o=[];for(;;){if(await e.checkAborted(),"normal"===s.type){const t=r[s.agent.name];if(!t)throw new Error("Unknown Agent: "+s.agent.name);const n=s.agent,a=new si(n);e.chain.push(a),s.result=await this.runAgent(e,t,s,a),o.push(s.result)}else{const t=s.agents,n=async(t,n)=>{const s=r[t.agent.name];if(!s)throw new Error("Unknown Agent: "+t.agent.name);const o=new si(t.agent);return e.chain.push(o),{result:await this.runAgent(e,s,t,o),agentChain:o,index:n}};let a=[],i=e.variables.get("agentParallel");if(void 0===i&&(i=false),i){const r=await Promise.all(t.map((e,t)=>n(e,t)));r.sort((e,t)=>e.index-t.index),r.forEach(({agentChain:t})=>{e.chain.push(t)}),a=r.map(({result:e})=>e)}else for(let r=0;r<t.length;r++){const{result:s,agentChain:o}=await n(t[r],r);e.chain.push(o),a.push(s)}o.push(a.join("\n\n"))}if(e.conversation.splice(0,e.conversation.length),!s.nextAgent)break;s=s.nextAgent}return{success:!0,stopReason:"done",result:o[o.length-1],taskId:e.taskId}}async runAgent(e,t,n,r){try{return n.agent.status="running",this.config.callback&&await this.config.callback.onMessage({taskId:e.taskId,agentName:n.agent.name,nodeId:n.agent.id,type:"agent_start",agentNode:n.agent}),n.result=await t.run(e,r),n.agent.status="done",this.config.callback&&await this.config.callback.onMessage({taskId:e.taskId,agentName:n.agent.name,nodeId:n.agent.id,type:"agent_result",agentNode:n.agent,result:n.result},t.AgentContext),n.result}catch(r){throw n.agent.status="error",this.config.callback&&await this.config.callback.onMessage({taskId:e.taskId,agentName:n.agent.name,nodeId:n.agent.id,type:"agent_result",agentNode:n.agent,error:r},t.AgentContext),r}}getTask(e){return this.taskMap.get(e)}getAllTaskId(){return[...this.taskMap.keys()]}deleteTask(e){this.abortTask(e);const t=this.taskMap.get(e);return t&&t.variables.clear(),this.taskMap.delete(e)}abortTask(e,t){let n=this.taskMap.get(e);return!!n&&(n.setPause(!1),this.onTaskStatus(n,"abort",t),n.controller.abort(t),!0)}pauseTask(e,t,n,r){const s=this.taskMap.get(e);return!!s&&(this.onTaskStatus(s,t?"pause":"resume-pause",r),s.setPause(t,n),!0)}chatTask(e,t){const n=this.taskMap.get(e);if(n)return n.conversation.push(t),n.conversation}addAgent(e){this.config.agents=this.config.agents||[],this.config.agents.push(e)}async onTaskStatus(e,t,n){const[r]=e.currentAgent()||[];if(r){const e=r.onTaskStatus;e&&await e.call(r,t,n)}}}function Ni(e=200){let t="";e=e||200;try{function n(r){if(r.nodeType===Node.ELEMENT_NODE){const e=r.tagName.toLowerCase();if(["script","style","noscript"].includes(e))return;const t=window.getComputedStyle(r);if("none"==t.display||"hidden"==t.visibility||"0"==t.opacity)return}if(r.nodeType===Node.TEXT_NODE){const e=r.textContent.trim();e&&(t+=e+" ")}else if(r.nodeType===Node.ELEMENT_NODE){const s=r.tagName.toLowerCase();if(["input","select","textarea"].includes(s))"input"==s&&"checkbox"==r.type?t+=r.checked+" ":"input"==s&&"radio"==r.type?r.checked&&r.value&&(t+=r.value+" "):r.value&&(t+=r.value+" ");else if("img"===s){const n=r.src||r.getAttribute("src")||r.getAttribute("data-src"),s=r.alt||r.title||"";n&&n.length<=e&&r.width*r.height>=1e4&&n.startsWith("http")&&(t+=`![${s||"image"}](${n.trim()}) `)}else if("a"===s&&0==r.children.length){const n=r.href||r.getAttribute("href"),s=r.innerText.trim()||r.title;s&&n&&n.length<=e&&n.startsWith("http")?t+=`[${s}](${n.trim()}) `:t+=s+" "}else if("video"===s||"audio"==s){let e=r.src||r.getAttribute("src");const n=r.querySelectorAll("source");n.length>0&&n[0].src&&(e=n[0].src,e&&e.startsWith("http")&&n[0].type&&(t+=n[0].type+" ")),e&&e.startsWith("http")&&(t+=e.trim()+" ")}else if("br"===s)t+="\n";else{if(["p","div","h1","h2","h3","h4","h5","h6"].includes(s)){t+="\n";for(let e of r.childNodes)n(e);return void(t+="\n")}if("hr"===s)t+="\n--------\n";else for(let e of r.childNodes)n(e)}}}n(document.body)}catch(r){t=document.body.innerText}return t.replace(/\s*\n/g,"\n").replace(/\n+/g,"\n").trim()}class Ii extends vi{async go_back(e){try{await this.execute_script(e,()=>{window.navigation.back()},[]),await o(100)}catch(e){}}async extract_page_content(e,t){let n=await this.execute_script(e,Ni,[]),r=await this.get_current_page(e),s=`title: ${r.title}\npage_url: ${r.url}\npage_content: \n${n}`;return t&&e.context.variables.set(t,s),{title:r.title||"",page_url:r.url,page_content:n}}async controlMcpTools(e,t,n){if(n>0){let t=null;try{t=(await this.get_current_page(e)).url}catch(e){}let r=e.variables.get("lastUrl");return e.variables.set("lastUrl",t),{mcpTools:0==n||t!=r,mcpParams:{environment:"browser",browser_url:t}}}return{mcpTools:!0,mcpParams:{environment:"browser"}}}toolExecuter(e,t){return{execute:async(n,r)=>{let s=await e.callTool({name:t,arguments:n,extInfo:{taskId:r.context.taskId,nodeId:r.agentChain.agent.id,environment:"browser",agent_name:r.agent.Name,browser_url:r.variables.get("lastUrl")}},r.context.controller.signal);if(s.extInfo&&s.extInfo.javascript&&"text"==s.content[0].type){let e,t=`${s.content[0].text};execute(${JSON.stringify(n)})`,o=await this.execute_mcp_script(r,t);return e="string"==typeof o||"number"==typeof o?o+"":o?JSON.stringify(o):"Successful",{content:[{type:"text",text:e}]}}return s}}}async get_current_page(e){return await this.execute_script(e,()=>({url:window.location.href,title:window.document.title}),[])}lastToolResult(e){let t=e[e.length-1];if("tool"!=t.role)return null;let n=t.content.filter(e=>"tool-result"==e.type)[0];if(!n)return null;let r=n.result,s=n.isError;for(let t=e.length-2;t>0;t--)if("assistant"===e[t].role&&"string"!=typeof e[t].content)for(let o=0;o<e[t].content.length;o++){let a=e[t].content[o];if("string"!=typeof a&&"tool-call"!==a.type)continue;let i=a;if(n.toolCallId==i.toolCallId)return{id:n.toolCallId,toolName:i.toolName,args:i.args,result:r,isError:s}}return null}toolUseNames(e){let t=[];if(!e)return t;for(let n=0;n<e.length;n++){let r=e[n];"tool"==r.role&&t.push(r.content[0].toolName)}return t}async execute_mcp_script(e,t){}}function Ei(){function e(t,n){if(!t)return;if("TEXT_NODE"==t.type)return{text:t.text||"",isVisible:t.isVisible||!1,parent:n};let r={tagName:t.tagName,xpath:t.xpath,highlightIndex:t.highlightIndex,attributes:t.attributes||{},isVisible:t.isVisible||!1,isInteractive:t.isInteractive||!1,isTopElement:t.isTopElement||!1,shadowRoot:t.shadowRoot||!1,children:[],parent:n};if(t.children){let n=[];for(let s=0;s<t.children.length;s++){let o=t.children[s];if(o){let t=e(o,r);t&&n.push(t)}}r.children=n}return r}window.get_clickable_elements=function(t=!0,n){window.clickable_elements={},document.querySelectorAll("[eko-user-highlight-id]").forEach(e=>e.removeAttribute("eko-user-highlight-id"));let r=e(function(e){let t=0;function n(e,t=!0){const n=[];let r=e;for(;r&&r.nodeType===Node.ELEMENT_NODE&&(!t||!(r.parentNode instanceof ShadowRoot||r.parentNode instanceof HTMLIFrameElement));){let e=0,t=r.previousSibling;for(;t;)t.nodeType===Node.ELEMENT_NODE&&t.nodeName===r.nodeName&&e++,t=t.previousSibling;const s=r.nodeName.toLowerCase(),o=e>0?`[${e+1}]`:"";n.unshift(`${s}${o}`),r=r.parentNode}return n.join("/")}return function r(s,o=null){if(!s)return null;if(s.nodeType===Node.TEXT_NODE){const e=s.textContent.trim();return e&&function(e){const t=document.createRange();t.selectNodeContents(e);const n=t.getBoundingClientRect();return 0!==n.width&&0!==n.height&&n.top>=0&&n.top<=window.innerHeight&&e.parentElement?.checkVisibility({checkOpacity:!0,checkVisibilityCSS:!0})}(s)?{type:"TEXT_NODE",text:e,isVisible:!0}:null}if(s.nodeType===Node.ELEMENT_NODE&&(a=s,new Set(["svg","script","style","link","meta"]).has(a.tagName.toLowerCase())))return null;var a;const i={tagName:s.tagName?s.tagName.toLowerCase():null,attributes:{},xpath:s.nodeType===Node.ELEMENT_NODE?n(s,!0):null,children:[]};if(s.nodeType===Node.ELEMENT_NODE&&s.attributes){const e=s.getAttributeNames?.()||[];for(const t of e)i.attributes[t]=s.getAttribute(t)}if(s.nodeType===Node.ELEMENT_NODE){const n=function(e){const t=new Set(["a","button","details","embed","input","label","menu","menuitem","object","select","textarea","summary"]),n=new Set(["button","menu","menuitem","link","checkbox","radio","slider","tab","tabpanel","textbox","combobox","grid","listbox","option","progressbar","scrollbar","searchbox","switch","tree","treeitem","spinbutton","tooltip","a-button-inner","a-dropdown-button","click","menuitemcheckbox","menuitemradio","a-button-text","button-text","button-icon","button-icon-only","button-text-icon-only","dropdown","combobox"]),r=e.tagName.toLowerCase(),s=e.getAttribute("role"),o=e.getAttribute("aria-role"),a=e.getAttribute("tabindex");if(t.has(r)||n.has(s)||n.has(o)||null!==a&&"-1"!==a||"a-dropdown-select"===e.getAttribute("data-action")||"a-dropdown-button"===e.getAttribute("data-action"))return!0;const i=window.getComputedStyle(e),l=null!==e.onclick||null!==e.getAttribute("onclick")||e.hasAttribute("ng-click")||e.hasAttribute("@click")||e.hasAttribute("v-on:click"),u=function(e){try{return window.getEventListeners?.(e)||{}}catch(t){const n={},r=["click","mousedown","mouseup","touchstart","touchend","keydown","keyup","focus","blur"];for(const t of r){const r=e[`on${t}`];r&&(n[t]=[{listener:r,useCapture:!1}])}return n}}(e),c=u&&(u.click?.length>0||u.mousedown?.length>0||u.mouseup?.length>0||u.touchstart?.length>0||u.touchend?.length>0),d=e.hasAttribute("aria-expanded")||e.hasAttribute("aria-pressed")||e.hasAttribute("aria-selected")||e.hasAttribute("aria-checked");void 0!==e.form||e.hasAttribute("contenteditable")||i.userSelect;const p=e.draggable||"true"===e.getAttribute("draggable");return d||l||c||p}(s),r=function(e){const t=window.getComputedStyle(e);return e.offsetWidth>0&&e.offsetHeight>0&&"hidden"!==t.visibility&&"none"!==t.display}(s),a=function(e){if(e.ownerDocument!==window.document)return!0;const t=e.getRootNode();if(t instanceof ShadowRoot){const n=e.getBoundingClientRect(),r={x:n.left+n.width/2,y:n.top+n.height/2};try{const n=t.elementFromPoint(r.x,r.y);if(!n)return!1;let s=n;for(;s&&s!==t;){if(s===e)return!0;s=s.parentElement}return!1}catch(e){return!0}}const n=e.getBoundingClientRect(),r={x:n.left+n.width/2,y:n.top+n.height/2};try{const t=document.elementFromPoint(r.x,r.y);if(!t)return!1;let n=t;for(;n&&n!==document.documentElement;){if(n===e)return!0;n=n.parentElement}return!1}catch(e){return!0}}(s);i.isInteractive=n,i.isVisible=r,i.isTopElement=a,n&&r&&a&&(i.highlightIndex=t++,window.clickable_elements[i.highlightIndex]=s,e&&function(e,t,n=null){let r=document.getElementById("eko-highlight-container");r||(r=document.createElement("div"),r.id="eko-highlight-container",r.style.position="fixed",r.style.pointerEvents="none",r.style.top="0",r.style.left="0",r.style.width="100%",r.style.height="100%",r.style.zIndex="2147483647",document.documentElement.appendChild(r));const s=["#FF0000","#00FF00","#0000FF","#FFA500","#800080","#008080","#FF69B4","#4B0082","#FF4500","#2E8B57","#DC143C","#4682B4"],o=s[t%s.length],a=`${o}1A`,i=document.createElement("div");i.style.position="absolute",i.style.border=`2px solid ${o}`,i.style.pointerEvents="none",i.style.boxSizing="border-box";const l=e.getBoundingClientRect();let u=l.top,c=l.left;if((l.width<window.innerWidth/2||l.height<window.innerHeight/2)&&(i.style.backgroundColor=a),n){const e=n.getBoundingClientRect();u+=e.top,c+=e.left}i.style.top=`${u}px`,i.style.left=`${c}px`,i.style.width=`${l.width}px`,i.style.height=`${l.height}px`;const d=document.createElement("div");d.className="eko-highlight-label",d.style.position="absolute",d.style.background=o,d.style.color="white",d.style.padding="1px 4px",d.style.borderRadius="4px",d.style.fontSize=`${Math.min(12,Math.max(8,l.height/2))}px`,d.textContent=t;let p=u+2,h=c+l.width-20-2;(l.width<24||l.height<20)&&(p=u-16-2,h=c+l.width-20),p<0&&(p=u+2),h<0&&(h=c+2),h+20>window.innerWidth&&(h=c+l.width-20-2),d.style.top=`${p}px`,d.style.left=`${h}px`,r.appendChild(i),r.appendChild(d),e.setAttribute("eko-user-highlight-id",`eko-highlight-${t}`)}(s,i.highlightIndex,o))}if(s.shadowRoot&&(i.shadowRoot=!0),s.shadowRoot){const e=Array.from(s.shadowRoot.childNodes).map(e=>r(e,o));i.children.push(...e)}if("IFRAME"===s.tagName)try{const e=s.contentDocument||s.contentWindow.document;if(e){const t=Array.from(e.body.childNodes).map(e=>r(e,s));i.children.push(...t)}}catch(e){console.warn("Unable to access iframe:",s)}else{const e=Array.from(s.childNodes).map(e=>r(e,o));i.children.push(...e)}return i}(document.body)}(t)),s=function(e){let t={};return function e(n){if(n.tagName){null!=n.highlightIndex&&(t[n.highlightIndex]=n);for(let t=0;t<n.children.length;t++)e(n.children[t])}}(e),t}(r);return{element_str:function(e,t){t||(t=["id","title","type","name","role","class","src","href","aria-label","placeholder","value","alt","aria-expanded"]);let n=[];return function e(r,s){if(null==r.text){if(null!=r.highlightIndex){let e="";if(t){for(let n=0;n<t.length;n++){let s=t[n],o=r.attributes[s];if("class"==s&&o&&o.length>30){let e=o.split(" ").slice(0,3);o=e.join(" ")}else{if(("src"==s||"href"==s)&&o&&o.length>200)continue;("src"==s||"href"==s)&&o&&o.startsWith("/")&&(o=window.location.origin+o)}s&&o&&(e+=` ${s}="${o}"`)}e=e.replace(/\n+/g," ")}let s=function(e){let t=[];return function n(r){if(!r.tagName||r==e||null==r.highlightIndex)if(!r.tagName&&r.text)t.push(r.text);else if(r.tagName)for(let e=0;e<r.children.length;e++)n(r.children[e])}(e),t.join("\n").trim().replace(/\n+/g," ")}(r);n.push(`[${r.highlightIndex}]:<${r.tagName}${e}>${s}</${r.tagName}>`)}for(let t=0;t<r.children.length;t++)e(r.children[t])}else(function(e){let t=e.parent;for(;t;){if(null!=t.highlightIndex)return!0;t=t.parent}return!1})(r)||n.push(`[]:${r.text}`)}(e),n.join("\n")}(r,n),selector_map:s}},window.get_highlight_element=function(e){return document.querySelector(`[eko-user-highlight-id="eko-highlight-${e}"]`)||window.clickable_elements[e]},window.remove_highlight=function(){let e=document.getElementById("eko-highlight-container");e&&e.remove()}}class Ci extends Ii{constructor(e,t,n){const r=[];super({name:"Browser",description:"You are a browser operation agent, use structured commands to interact with the browser.\n* This is a browser GUI interface where you need to analyze webpages by taking screenshot and page element structures, and specify action sequences to complete designated tasks.\n* For your first visit, please start by calling either the `navigate_to` or `current_page` tool. After each action you perform, I will provide you with updated information about the current state, including page screenshots and structured element data that has been specially processed for easier analysis.\n* Screenshot description:\n  - Screenshot are used to understand page layouts, with labeled bounding boxes corresponding to element indexes. Each bounding box and its label share the same color, with labels typically positioned in the top-right corner of the box.\n  - Screenshot help verify element positions and relationships. Labels may sometimes overlap, so extracted elements are used to verify the correct elements.\n  - In addition to screenshot, simplified information about interactive elements is returned, with element indexes corresponding to those in the screenshot.\n  - This tool can ONLY screenshot the VISIBLE content. If a complete content is required, use 'extract_page_content' instead.\n  - If the webpage content hasn't loaded, please use the `wait` tool to allow time for the content to load.\n* ELEMENT INTERACTION:\n   - Only use indexes that exist in the provided element list\n   - Each element has a unique index number (e.g., \"[33]:<button>\")\n   - Elements marked with \"[]:\" are non-interactive (for context only)\n   - Use the latest element index, do not rely on historical outdated element indexes\n* ERROR HANDLING:\n   - If no suitable elements exist, use other functions to complete the task\n   - If stuck, try alternative approaches, don't refuse tasks\n   - Handle popups/cookies by accepting or closing them\n   - When encountering scenarios that require user assistance such as login, verification codes, QR code scanning, etc., you can request user help\n* BROWSER OPERATION:\n   - Use scroll to find elements you are looking for, When extracting content, prioritize using extract_page_content, only scroll when you need to load more content\n* During execution, please output user-friendly step information. Do not output HTML-related element and index information to users, as this would cause user confusion.\n",tools:r,llms:e,mcpClient:n,planDescription:"Browser operation agent, interact with the browser using the mouse and keyboard."});let s=this.buildInitTools();t&&t.length>0&&(s=u(s,t)),s.forEach(e=>r.push(e))}async input_text(e,t,n,r){await this.execute_script(e,Si,[{index:t,text:n,enter:r}]),r&&await o(200)}async click_element(e,t,n,r){await this.execute_script(e,Ai,[{index:t,num_clicks:n,button:r}])}async scroll_to_element(e,t){await this.execute_script(e,e=>window.get_highlight_element(e).scrollIntoView({behavior:"smooth"}),[t]),await o(200)}async scroll_mouse_wheel(e,t,n){if(await this.execute_script(e,Mi,[{amount:t}]),await o(200),!n){const t=this.toolUseNames(e.agentChain.agentRequest?.messages);let r=0;for(let e=t.length-1;e>=Math.max(t.length-8,0);e--)"scroll_mouse_wheel"==t[e]&&r++;r>=3&&(n=!0)}if(n){let t=await this.extract_page_content(e);return{result:"The current page content has been extracted, latest page content:\ntitle: "+t.title+"\npage_url: "+t.page_url+"\npage_content: "+t.page_content}}}async hover_to_element(e,t){await this.execute_script(e,Ri,[{index:t}])}async get_select_options(e,t){return await this.execute_script(e,Oi,[{index:t}])}async select_option(e,t,n){return await this.execute_script(e,ji,[{index:t,option:n}])}async screenshot_and_html(e){try{let t=null;for(let n=0;n<5&&(await o(200),await this.execute_script(e,Ei,[]),await o(50),t=await this.execute_script(e,()=>window.get_clickable_elements(!0),[]),!t);n++);await o(100);let n=await this.screenshot(e),r=t.element_str;return{imageBase64:n.imageBase64,imageType:n.imageType,pseudoHtml:r}}finally{try{await this.execute_script(e,()=>window.remove_highlight(),[])}catch(e){}}}get_element_script(e){return`window.get_highlight_element(${e});`}buildInitTools(){return[{name:"navigate_to",description:"Navigate to a specific url",parameters:{type:"object",properties:{url:{type:"string",description:"The url to navigate to"}},required:["url"]},execute:async(e,t)=>await this.callInnerTool(()=>this.navigate_to(t,e.url))},{name:"current_page",description:"Get the information of the current webpage (url, title)",parameters:{type:"object",properties:{}},execute:async(e,t)=>await this.callInnerTool(()=>this.get_current_page(t))},{name:"go_back",description:"Navigate back in browser history",parameters:{type:"object",properties:{}},execute:async(e,t)=>await this.callInnerTool(()=>this.go_back(t))},{name:"input_text",description:"Input text into an element",parameters:{type:"object",properties:{index:{type:"number",description:"The index of the element to input text into"},text:{type:"string",description:"The text to input"},enter:{type:"boolean",description:"When text input is completed, press Enter (applicable to search boxes)",default:!1}},required:["index","text"]},execute:async(e,t)=>await this.callInnerTool(()=>this.input_text(t,e.index,e.text,e.enter))},{name:"click_element",description:"Click on an element by index",parameters:{type:"object",properties:{index:{type:"number",description:"The index of the element to click"},num_clicks:{type:"number",description:"number of times to click the element, default 1"},button:{type:"string",description:"Mouse button type, default left",enum:["left","right","middle"]}},required:["index"]},execute:async(e,t)=>await this.callInnerTool(()=>this.click_element(t,e.index,e.num_clicks||1,e.button||"left"))},{name:"scroll_mouse_wheel",description:"Scroll the mouse wheel at current position, only scroll when you need to load more content",parameters:{type:"object",properties:{amount:{type:"number",description:"Scroll amount (up / down)",minimum:1,maximum:10},direction:{type:"string",enum:["up","down"]},extract_page_content:{type:"boolean",default:!1,description:"After scrolling is completed, whether to extract the current latest page content"}},required:["amount","direction","extract_page_content"]},execute:async(e,t)=>await this.callInnerTool(async()=>{let n=e.amount;await this.scroll_mouse_wheel(t,"up"==e.direction?-n:n,1==e.extract_page_content)})},{name:"hover_to_element",description:"Mouse hover over the element",parameters:{type:"object",properties:{index:{type:"number",description:"The index of the element to input text into"}},required:["index"]},execute:async(e,t)=>await this.callInnerTool(()=>this.hover_to_element(t,e.index))},{name:"extract_page_content",description:"Extract the text content and image links of the current webpage, please use this tool to obtain webpage data.",parameters:{type:"object",properties:{}},execute:async(e,t)=>await this.callInnerTool(()=>this.extract_page_content(t))},{name:"get_select_options",description:"Get all options from a native dropdown element (<select>).",parameters:{type:"object",properties:{index:{type:"number",description:"The index of the element to select"}},required:["index"]},execute:async(e,t)=>await this.callInnerTool(()=>this.get_select_options(t,e.index))},{name:"select_option",description:"Select the native dropdown option, Use this after get_select_options and when you need to select an option from a dropdown.",parameters:{type:"object",properties:{index:{type:"number",description:"The index of the element to select"},option:{type:"string",description:"Text option"}},required:["index","option"]},execute:async(e,t)=>await this.callInnerTool(()=>this.select_option(t,e.index,e.option))},{name:"get_all_tabs",description:"Get all tabs of the current browser",parameters:{type:"object",properties:{}},execute:async(e,t)=>await this.callInnerTool(()=>this.get_all_tabs(t))},{name:"switch_tab",description:"Switch to the specified tab page",parameters:{type:"object",properties:{tabId:{type:"number",description:"Tab ID, obtained through get_all_tabs"}},required:["tabId"]},execute:async(e,t)=>await this.callInnerTool(()=>this.switch_tab(t,e.tabId))},{name:"wait",noPlan:!0,description:"Wait for specified duration",parameters:{type:"object",properties:{duration:{type:"number",description:"Duration in millisecond",default:500,minimum:200,maximum:1e4}},required:["duration"]},execute:async(e,t)=>await this.callInnerTool(()=>o(e.duration||200))}]}async double_screenshots(e,t,n){return!0}async handleMessages(e,t,n){const r="This is the environmental information after the operation, including the latest browser screenshot and page elements. Please perform the next operation based on the environmental information. Do not output the following elements and index information in your response.\n\nIndex and elements:\n";let s=this.lastToolResult(t);if(s&&"extract_page_content"!==s.toolName&&"get_all_tabs"!==s.toolName&&"variable_storage"!==s.toolName){await o(300);let s=[];if(await this.double_screenshots(e,t,n)){let t=await this.screenshot(e),n=l(t.imageBase64);s.push({type:"image",image:n,mimeType:t.imageType})}let a=await this.screenshot_and_html(e),i=l(a.imageBase64);s.push({type:"image",image:i,mimeType:a.imageType}),t.push({role:"user",content:[...s,{type:"text",text:r+"```html\n"+a.pseudoHtml+"\n```"}]})}super.handleMessages(e,t,n),this.handlePseudoHtmlText(t,r)}handlePseudoHtmlText(e,t){for(let n=0;n<e.length;n++){let r=e[n];if("user"!==r.role||r.content.length<=1)continue;let s=r.content;for(let r=0;r<s.length;r++){let o=s[r];"text"==o.type&&o.text.startsWith(t)&&n>=2&&n<e.length-3&&(o.text=this.removePseudoHtmlAttr(o.text,["class","src","href"]))}"[image]"==s[0].text&&"[image]"==s[1].text&&s.splice(0,1)}}removePseudoHtmlAttr(e,t){return e.split("\n").map(e=>{if(!e.startsWith("[")||-1==e.indexOf("]:<"))return e;e=e.substring(e.indexOf("]:<")+2);for(let n=0;n<t.length;n++){let r=e.indexOf(t[n]+'="');if(-1==r)continue;let s=e.indexOf('"',r+t[n].length+3);-1!=s&&(e=e.substring(0,r)+e.substring(s+1).trim())}return e.replace('" >','">').replace(" >",">")}).join("\n")}}function Si(e){let t,{index:n,text:r,enter:s}=e,o=window.get_highlight_element(n);if(!o)return!1;if("IFRAME"==o.tagName){let e=o.contentDocument||o.contentWindow.document;t=e.querySelector("textarea")||e.querySelector('*[contenteditable="true"]')||e.querySelector("input")}else"INPUT"==o.tagName||"TEXTAREA"==o.tagName||0==o.childElementCount?t=o:(t=o.querySelector("input")||o.querySelector("textarea"),t||(t=o.querySelector('*[contenteditable="true"]')||o,"DIV"==t.tagName&&(t=t.querySelector("span")||t.querySelector("div")||t)));if(t.focus&&t.focus(),!r&&s)return["keydown","keypress","keyup"].forEach(e=>{const n=new KeyboardEvent(e,{key:"Enter",code:"Enter",keyCode:13,bubbles:!0,cancelable:!0});t.dispatchEvent(n)}),!0;if(null==t.value)t.textContent=r;else if(t.value=r,t.__proto__){let e=Object.getOwnPropertyDescriptor(t.__proto__,"value")?.set;e&&e.call(t,r)}return t.dispatchEvent(new Event("input",{bubbles:!0})),s&&["keydown","keypress","keyup"].forEach(e=>{const n=new KeyboardEvent(e,{key:"Enter",code:"Enter",keyCode:13,bubbles:!0,cancelable:!0});t.dispatchEvent(n)}),!0}function Ai(e){let{index:t,button:n,num_clicks:r}=e;function s(e,n){let s=window.get_highlight_element(t);if(!s)return!1;for(let t=0;t<r;t++)for(let t=0;t<e.length;t++){const r=new MouseEvent(e[t],{view:window,bubbles:!0,cancelable:!0,button:n});s.dispatchEvent(r)}return!0}return"right"==n?s(["mousedown","mouseup","contextmenu"],2):s(["mousedown","mouseup","click"],"middle"==n?1:0)}function Ri(e){let t=window.get_highlight_element(e.index);if(!t)return!1;const n=new MouseEvent("mouseenter",{bubbles:!0,cancelable:!0,view:window});return t.dispatchEvent(n),!0}function Oi(e){let t=window.get_highlight_element(e.index);return t&&"SELECT"===t.tagName.toUpperCase()?{options:Array.from(t.options).map(e=>({index:e.index,text:e.text.trim(),value:e.value})),name:t.name}:"Error: Not a select element"}function ji(e){let t=window.get_highlight_element(e.index);if(!t||"SELECT"!==t.tagName.toUpperCase())return"Error: Not a select element";let n=e.option.trim(),r=Array.from(t.options).find(e=>e.text.trim()===n);return r||(r=Array.from(t.options).find(e=>e.value.trim()===n)),r?(t.value=r.value,t.dispatchEvent(new Event("change")),{success:!0,selectedValue:r.value,selectedText:r.text.trim()}):{success:!1,error:"Select Option not found",availableOptions:Array.from(t.options).map(e=>e.text.trim())}}function Mi(e){const t=e.amount,n=document.documentElement||document.body;if(n.scrollHeight>1.2*window.innerHeight){const e=Math.max(20,Math.min((window.innerHeight||n.clientHeight)/10,200));return void window.scrollBy(0,e*t)}function r(e=document,t=[]){for(const n of Array.from(e.querySelectorAll("*")))"IFRAME"===n.tagName&&n.contentDocument?r(n.contentDocument,t):t.push(n);return t}function s(e){const t=e.getBoundingClientRect(),r=window.innerHeight||n.clientHeight,s=window.innerWidth||n.clientWidth,o=Math.max(0,Math.min(t.left,s)),a=Math.max(0,Math.min(t.right,s)),i=Math.max(0,Math.min(t.top,r));return(a-o)*(Math.max(0,Math.min(t.bottom,r))-i)}function o(e){for(;e&&e!==document.body&&e!==document.body.parentElement;){const t=window.getComputedStyle(e);let n="auto"===t.zIndex?0:parseInt(t.zIndex)||0;if(n>0)return n;e=e.parentElement}return 0}const a=function(){const e=r();let t=e.filter(e=>{const t=window.getComputedStyle(e).getPropertyValue("overflow-y");return("auto"===t||"scroll"===t)&&e.scrollHeight>e.clientHeight});return 0==t.length&&(t=e.filter(e=>{const t=window.getComputedStyle(e).getPropertyValue("overflow-y");return"auto"===t||"scroll"===t||e.scrollHeight>e.clientHeight})),t}();if(0===a.length){const e=Math.max(20,Math.min((window.innerHeight||n.clientHeight)/10,200));return window.scrollBy(0,e*t),!1}const i=a.sort((e,t)=>{let n=o(t)-o(e);if(n>0)return 1;if(n<0)return-1;let r=s(t)-s(e);return r>0?1:r<0?-1:0}),l=i[0],u=l.clientHeight,c=Math.max(20,Math.min(u/10,200));l.scrollBy(0,c*t);const d=i.sort((e,t)=>t.getBoundingClientRect().height-e.getBoundingClientRect().height)[0];if(d!=l){const e=d.clientHeight,n=Math.max(20,Math.min(e/10,200));d.scrollBy(0,n*t)}return!0}class Pi extends Ci{async screenshot(e){let t,n=await this.getWindowId(e);try{t=await chrome.tabs.captureVisibleTab(n,{format:"jpeg",quality:60})}catch(e){await this.sleep(1e3),t=await chrome.tabs.captureVisibleTab(n,{format:"jpeg",quality:60})}return{imageBase64:t.substring(t.indexOf("base64,")+7),imageType:"image/jpeg"}}async navigate_to(e,t){let n=await this.getWindowId(e),r=await chrome.tabs.create({url:t,windowId:n});r=await this.waitForTabComplete(r.id),await this.sleep(200),e.variables.set("windowId",r.windowId);let s=e.variables.get("navigateTabIds")||[];return s.push(r.id),e.variables.set("navigateTabIds",s),{url:t,title:r.title,tabId:r.id}}async get_all_tabs(e){let t=await this.getWindowId(e),n=await chrome.tabs.query({windowId:t}),r=[];for(let e=0;e<n.length;e++){let t=n[e];r.push({tabId:t.id,url:t.url,title:t.title})}return r}async switch_tab(e,t){let n=await chrome.tabs.update(t,{active:!0});if(!n)throw new Error("tabId does not exist: "+t);return e.variables.set("windowId",n.windowId),{tabId:n.id,url:n.url,title:n.title}}async go_back(e){try{if(await this.execute_script(e,()=>window.navigation.canGoBack,[])+""=="true")return await this.execute_script(e,()=>{window.navigation.back()},[]),void await this.sleep(100);if(await this.execute_script(e,()=>window.history.length,[])>1)await this.execute_script(e,()=>{window.history.back()},[]);else{let t=e.variables.get("navigateTabIds");if(t&&t.length>0)return await this.switch_tab(e,t[t.length-1])}await this.sleep(100)}catch(e){console.error("BrowserAgent, go_back, error: ",e)}}async execute_script(e,t,n){let r=await this.getTabId(e);return(await chrome.scripting.executeScript({target:{tabId:r},func:t,args:n}))[0].result}async getTabId(e){let t=await this.getWindowId(e),n=await chrome.tabs.query({windowId:t,active:!0,windowType:"normal"});return 0==n.length&&(n=await chrome.tabs.query({windowId:t,windowType:"normal"})),n[n.length-1].id}async getWindowId(e){let t=e.variables.get("windowId");if(t)return t;let n=await chrome.windows.getLastFocused({windowTypes:["normal"]});if(n||(n=await chrome.windows.getCurrent({windowTypes:["normal"]})),n)return n.id;let r=await chrome.tabs.query({windowType:"normal",currentWindow:!0});return 0==r.length&&(r=await chrome.tabs.query({windowType:"normal",lastFocusedWindow:!0})),r[r.length-1].windowId}async waitForTabComplete(e,t=8e3){return new Promise(async(n,r)=>{const s=setTimeout(async()=>{chrome.tabs.onUpdated.removeListener(o);let t=await chrome.tabs.get(e);t.status,n(t)},t),o=async(t,r,a)=>{t==e&&"complete"===r.status&&(chrome.tabs.onUpdated.removeListener(o),clearTimeout(s),n(a))};let a=await chrome.tabs.get(e);if("complete"===a.status)return n(a),void clearTimeout(s);chrome.tabs.onUpdated.addListener(o)})}sleep(e){return new Promise(t=>setTimeout(()=>t(),e))}}let Di=!1,$i=!1,Ui=[];async function qi(e="llmConfig"){return(await chrome.storage.sync.get([e]))[e]}function Li(e,t,n){chrome.runtime.sendMessage({type:"log",log:e+"",level:t||"info",stream:n},()=>{chrome.runtime.lastError})}var Fi;chrome.runtime.onMessage.addListener((e,t,n)=>"START_RECORDING"===e.type?(Di=!0,Ui=[],chrome.tabs.query({active:!0,currentWindow:!0},e=>{const t=e[0];(null==t?void 0:t.id)?chrome.debugger.attach({tabId:t.id},"1.3",()=>{chrome.runtime.lastError?(console.error("Debugger attach error:",chrome.runtime.lastError.message),Li("Wait! Cannot record on this page (Chrome restricted page or debugger already attached).","error"),Di=!1,n({success:!1,error:chrome.runtime.lastError.message})):(chrome.debugger.sendCommand({tabId:t.id},"Network.enable"),chrome.debugger.sendCommand({tabId:t.id},"Console.enable"),Li("CDP Session started for tab "+t.id,"info"),chrome.tabs.sendMessage(t.id,{type:"START_RECORDING"},()=>{chrome.runtime.lastError&&console.warn("Content script not ready:",chrome.runtime.lastError.message)}),n({success:!0}))}):n({success:!1,error:"No active tab"})}),Li("Recording started...","info"),!0):"STOP_RECORDING"===e.type?(Di=!1,chrome.tabs.query({active:!0,currentWindow:!0},e=>{const t=e[0];(null==t?void 0:t.id)?(chrome.debugger.detach({tabId:t.id},()=>{chrome.runtime.lastError,Li("CDP Session finished.","info"),n({steps:Ui})}),chrome.tabs.sendMessage(t.id,{type:"STOP_RECORDING"},()=>{chrome.runtime.lastError})):n({steps:Ui})}),Li("Recording stopped. Captured "+Ui.length+" steps.","success"),!0):"RECORDED_STEP"===e.type?(Di&&(Ui.push(e.step),chrome.runtime.sendMessage({type:"UPDATE_STEPS",steps:Ui},()=>{chrome.runtime.lastError})),n({}),!1):"GET_RECORDED_STEPS"===e.type?(n({steps:Ui,isRecording:Di,isAssertMode:$i}),!1):"SET_ASSERT_MODE"===e.type?($i=e.enabled,chrome.tabs.query({active:!0,currentWindow:!0},e=>{const t=e[0];(null==t?void 0:t.id)&&chrome.tabs.sendMessage(t.id,{type:"SET_ASSERT_MODE",enabled:$i})}),!1):void 0),chrome.debugger.onEvent.addListener((e,t,n)=>{if(Di&&"Console.messageAdded"===t){const e=n.message;if("error"===e.level){const t=e.text||"";t.includes("cart_items")||t.includes("[object Object]")||t.includes("Extension context invalidated")||Li(`Page Error: ${t}`,"error")}}}),chrome.debugger.onDetach.addListener((e,t)=>{Di&&(Li("Debugger detached: "+t,"error"),Di=!1,chrome.runtime.sendMessage({type:"STOP_RECORDING"},()=>{chrome.runtime.lastError}))}),chrome.storage.local.set({running:!1}),chrome.runtime.onMessage.addListener(function(e,t,n){return"run"==e.type?(async()=>{try{chrome.runtime.sendMessage({type:"log",log:"Run..."}),Fi=await async function(e){var t,n;let r=await qi();if(!r||!r.apiKey)return Li("Please configure apiKey, configure in the Medhavi AI extension options of the browser extensions.","error"),chrome.runtime.openOptionsPage(),chrome.storage.local.set({running:!1}),void chrome.runtime.sendMessage({type:"stop"});if(Li(`Using LLM: ${r.llm}, Model: ${r.modelName}, BaseURL: ${null===(t=r.options)||void 0===t?void 0:t.baseURL}`,"info"),Li("API Key configured: "+(r.apiKey?"Yes (length: "+r.apiKey.length+")":"No"),"info"),!(null===(n=r.options)||void 0===n?void 0:n.baseURL))return void Li("Error: Base URL is not configured properly","error");if(!r.modelName)return void Li("Error: Model name is not configured","error");"openrouter"===r.llm&&(r.apiKey.startsWith("sk-or-")||Li("Warning: OpenRouter API keys typically start with 'sk-or-'","error"),r.options.baseURL.includes("openrouter.ai")||Li("Warning: Base URL should be OpenRouter endpoint","error"),r.modelName.includes(":free")&&Li("Using free tier model - check OpenRouter limits","info")),"google"===r.llm&&(r.apiKey.startsWith("AIza")||Li("Warning: Google API keys typically start with 'AIza'","error"),r.options.baseURL.includes("googleapis.com")||Li("Warning: Base URL should be Google API endpoint","error"),Li("Using Google Gemini API directly - better rate limits than OpenRouter","info")),"groq"===r.llm&&(r.apiKey.startsWith("gsk_")||Li("Warning: Groq API keys typically start with 'gsk_'","error"),r.options.baseURL.includes("api.groq.com")||Li("Warning: Base URL should be Groq API endpoint","error"),Li("Using Groq API - ultra-fast inference speeds","info"));const s={default:{provider:"groq"===r.llm?"openai":r.llm,model:r.modelName,apiKey:r.apiKey,config:{baseURL:r.options.baseURL,timeout:6e4,..."openrouter"===r.llm&&{headers:{"HTTP-Referer":"https://eko.ai","X-Title":"Medhavi AI Browser Agent"}},..."google"===r.llm&&{headers:{"Content-Type":"application/json"}},..."groq"===r.llm&&{headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.apiKey}`},messageFormat:"openai",enforceStringContent:!0}}}},o="groq"===r.llm?"openai":r.llm;Li(`LLM Config: Provider=${r.llm}, Actual Provider=${o}, Model=${r.modelName}, BaseURL=${r.options.baseURL}`,"info");let a={onMessage:async e=>{"workflow"==e.type?Li("Plan\n"+e.workflow.xml,"info",!e.streamDone):"text"==e.type?Li(e.text,"info",!e.streamDone):"tool_streaming"==e.type?Li(`${e.agentName} > ${e.toolName}\n${e.paramsText}`,"info",!0):"tool_use"==e.type?Li(`${e.agentName} > ${e.toolName}\n${JSON.stringify(e.params)}`):"error"==e.type&&Li(`LLM Error: ${e.error||"Unknown LLM error"}`,"error"),console.log("message: ",JSON.stringify(e,null,2))},onHumanConfirm:async(e,t)=>confirm(t)},i=[new Pi];try{Li(`Creating Medhavi AI instance with LLM provider: ${r.llm}`,"info");var l=new Ti({llms:s,agents:i,callback:a});Li("Medhavi AI instance created successfully","info")}catch(e){return Li(`Failed to create Medhavi AI instance: ${e.message}`,"error"),chrome.storage.local.set({running:!1}),void chrome.runtime.sendMessage({type:"stop"})}if(Li(`Starting Medhavi AI with prompt: "${e}"`,"info"),"groq"===r.llm){Li("Testing Groq API connectivity...","info");try{await fetch("https://api.groq.com/openai/v1/models",{method:"GET",headers:{Authorization:`Bearer ${r.apiKey}`,"Content-Type":"application/json"}}).then(e=>{e.ok?Li(" Groq API connectivity test successful","info"):Li(` Groq API responded with status: ${e.status}`,"error")})}catch(e){Li(` Groq API connectivity test failed: ${e.message}`,"error"),Li("This may indicate network or CORS issues","error")}}return l.run(e).then(e=>{Li(e.result,e.success?"success":"error")}).catch(e=>{var t,n,s;if(Li(`Error Type: ${e.constructor.name}`,"error"),Li(`Error Message: ${e.message||e.toString()}`,"error"),e.message&&e.message.includes("content must be a string")&&(Li(" MESSAGE FORMAT ERROR: API received invalid message format","error"),Li("This usually happens when:","error"),Li("1. The framework sends non-string content (images, objects, etc.)","error"),Li("2. Message formatting is incompatible with the provider","error"),"groq"===r.llm&&(Li("3. Groq requires strict OpenAI message format compliance","error"),Li("4. Try switching to Google Gemini or OpenAI temporarily","error")),Li("5. This may be a limitation of the current Eko framework version","error")),"Failed to fetch"!==e.message&&"TypeError"!==e.name||(Li(" NETWORK ERROR: Failed to fetch from API","error"),Li("Possible causes:","error"),Li("1. Network connectivity issues","error"),Li("2. CORS policy blocking the request","error"),Li("3. API endpoint unreachable","error"),Li(`4. Invalid base URL: ${null===(t=r.options)||void 0===t?void 0:t.baseURL}`,"error"),"groq"===r.llm&&(Li("5. Groq service might be temporarily down","error"),Li("6. Try switching to a different provider temporarily","error"))),"AI_APICallError"!==e.name&&"AI_APICallError"!==e.constructor.name&&"k"!==e.constructor.name||(Li("This is an AI API Call Error - check your API configuration","error"),Li(`Provider: ${r.llm}`,"error"),Li(`Model: ${r.modelName}`,"error"),Li(`Base URL: ${null===(n=r.options)||void 0===n?void 0:n.baseURL}`,"error"),Li(`API Key length: ${(null===(s=r.apiKey)||void 0===s?void 0:s.length)||"undefined"}`,"error"),"openrouter"===r.llm?(Li("Common causes for OpenRouter API errors:","error"),Li("1. Invalid API key format or permissions","error"),Li("2. Model not available or rate limited","error"),Li("3. Request format not compatible with model","error"),Li("4. Free tier usage limits exceeded","error"),Li("5. OpenRouter service issues","error")):"google"===r.llm?(Li("Common causes for Google Gemini API errors:","error"),Li("1. Invalid API key (should start with 'AIza')","error"),Li("2. API not enabled in Google Cloud Console","error"),Li("3. Billing not set up (required for API usage)","error"),Li("4. Model name format incorrect","error"),Li("5. Request quota exceeded","error"),Li("6. Geographic restrictions","error")):"groq"===r.llm&&(Li("Common causes for Groq API errors:","error"),Li("1. Invalid API key (should start with 'gsk_')","error"),Li("2. Rate limit exceeded (very generous limits)","error"),Li("3. Model name incorrect or unavailable","error"),Li("4. Request format not compatible","error"),Li("5. Message content format issues (must be strings)","error"),Li("6. Service temporarily unavailable","error"),Li(" RECOMMENDATION: Try Google Gemini for better compatibility","error"))),e.cause&&Li(`Error Cause: ${JSON.stringify(e.cause)}`,"error"),e.details&&Li(`Error Details: ${JSON.stringify(e.details)}`,"error"),e.statusCode)switch(Li(`Status Code: ${e.statusCode}`,"error"),e.statusCode){case 429:Li(" RATE LIMITED (429): You've exceeded the rate limit or quota","error"),Li("Solutions:","error"),Li("- Wait before trying again (rate limit resets)","error"),Li("- Check your OpenRouter account usage/credits","error"),Li("- Free tier models have strict limits","error"),Li("- Consider upgrading to paid plan","error");break;case 401:Li(" UNAUTHORIZED (401): Invalid API key","error");break;case 403:Li(" FORBIDDEN (403): Access denied to this model","error");break;case 400:Li(" BAD REQUEST (400): Invalid request format","error");break;case 500:Li(" SERVER ERROR (500): OpenRouter service issue","error")}e.responseBody&&Li(`Response Body: ${JSON.stringify(e.responseBody)}`,"error"),e.responseHeaders&&Li(`Response Headers: ${JSON.stringify(e.responseHeaders)}`,"error"),e.url&&Li(`Request URL: ${e.url}`,"error"),e.requestBodyValues&&Li(`Request Body: ${JSON.stringify(e.requestBodyValues)}`,"error"),e.isRetryable&&Li(`Is Retryable: ${e.isRetryable}`,"error"),e.data&&Li(`Error Data: ${JSON.stringify(e.data)}`,"error"),e.response&&(Li(`API Response Status: ${e.response.status}`,"error"),Li(`API Response Headers: ${JSON.stringify(e.response.headers)}`,"error"),Li(`API Response Data: ${JSON.stringify(e.response.data)}`,"error")),e.request&&(Li(`Request URL: ${e.request.url||"unknown"}`,"error"),Li(`Request Method: ${e.request.method||"unknown"}`,"error")),e.config&&Li(`Request Config: ${JSON.stringify({url:e.config.url,method:e.config.method,headers:e.config.headers?Object.keys(e.config.headers):"none"})}`,"error"),Li(`All error properties: ${JSON.stringify(Object.getOwnPropertyNames(e))}`,"error"),e.stack&&Li(`Error Stack: ${e.stack}`,"error"),console.error("Full error object:",e),console.error("Error keys:",Object.keys(e)),console.error("Error values:",Object.values(e))}).finally(()=>{chrome.storage.local.set({running:!1}),chrome.runtime.sendMessage({type:"stop"})}),l}(e.prompt)}catch(e){console.error(e),chrome.runtime.sendMessage({type:"log",log:e+"",level:"error"})}})():"stop"==e.type?(Fi&&Fi.getAllTaskId().forEach(e=>{Fi.abortTask(e),chrome.runtime.sendMessage({type:"log",log:"Abort taskId: "+e})}),chrome.runtime.sendMessage({type:"log",log:"Stop"})):"GENERATE_MANUAL_TESTCASE"===e.type&&(async()=>{try{chrome.runtime.sendMessage({type:"log",log:"Capturing page context..."});const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(null==e?void 0:e.id))throw new Error("No active tab found");await async function(e){try{await new Promise((t,n)=>{chrome.tabs.sendMessage(e,{type:"PING"},e=>{chrome.runtime.lastError||!e?n():t(!0)})})}catch(t){console.log("Injecting content script into tab",e),await chrome.scripting.executeScript({target:{tabId:e},files:["js/content_script.js"]}),await new Promise(e=>setTimeout(e,200))}}(e.id);const t=await new Promise((t,n)=>{chrome.tabs.sendMessage(e.id,{type:"GET_PAGE_CONTEXT"},e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):e&&e.context?t(e.context):n(new Error("Failed to get page context"))})});chrome.runtime.sendMessage({type:"log",log:"Generating test cases via AI..."});const n=await async function(e){let t=await qi();if(!t||!t.apiKey)throw new Error("LLM not configured");const n=`Generate a set of manual test cases for the following web page content. \nReturn the result in a Markdown table with the following columns:\n1. Test Case ID: A unique identifier (e.g., TC_Login_01)\n2. Test Title/Name: Brief descriptive title\n3. Description/Objective: Short explanation of what is being tested\n4. Preconditions: Setup conditions\n5. Test Steps: Clear, numbered sequence\n6. Test Data: Specific inputs or values\n7. Expected Result: Anticipated outcome\n8. Actual Result: (Leave empty)\n9. Status: (Leave empty)\n\nPage Title: ${e.title}\nURL: ${e.url}\n\nInteractive Elements:\n${e.elements.map(e=>`- ${e.tagName}: ${e.text||e.placeholder||e.role||"element"} (ID: ${e.id||"N/A"})`).join("\n")}`;return await async function(e,t){var n,r,s;"groq"===t.llm||t.llm;const o=t.options.baseURL+(t.options.baseURL.endsWith("/")?"":"/")+"chat/completions",a={"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`};"openrouter"===t.llm&&(a["HTTP-Referer"]="https://eko.ai",a["X-Title"]="Medhavi AI Browser Agent");const i={model:t.modelName,messages:[{role:"system",content:"You are a professional QA engineer helping to generate manual test cases."},{role:"user",content:e}],temperature:.7},l=await fetch(o,{method:"POST",headers:a,body:JSON.stringify(i)});if(!l.ok){const e=await l.text();throw new Error(`LLM API Error: ${l.status} - ${e}`)}return(null===(s=null===(r=null===(n=(await l.json()).choices)||void 0===n?void 0:n[0])||void 0===r?void 0:r.message)||void 0===s?void 0:s.content)||"Failed to generate test cases."}(n,t)}(t);chrome.runtime.sendMessage({type:"MANUAL_TESTCASE_GENERATED",testcases:n}),chrome.runtime.sendMessage({type:"log",log:"Manual test cases generated successfully!",level:"success"})}catch(e){console.error(e),chrome.runtime.sendMessage({type:"log",log:"Failed to generate test cases: "+e,level:"error"}),chrome.runtime.sendMessage({type:"MANUAL_TESTCASE_GENERATED",error:String(e)})}})(),!0}),chrome.sidePanel&&chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0})})();